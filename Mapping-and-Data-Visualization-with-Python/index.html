<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<meta content="IE=EDGE" http-equiv="X-UA-Compatible"/>
<meta content="Ujaval Gandhi" name="author"/>
<title>Mapping and Data Visualization with Python (Full Course Material)</title>
<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet"/>
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet"/>
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-PDGF11RK4Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PDGF11RK4Z');
</script>
<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>
<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style data-origin="pandoc" type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>
<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>
<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>
<!-- tabsets -->
<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>
<!-- code folding -->
</head>
<body>
<div class="container-fluid main-container">
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle collapsed" data-target="#navbar" data-toggle="collapse" type="button">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="index.html">Courses</a>
</div>
<div class="navbar-collapse collapse" id="navbar">
<ul class="nav navbar-nav">
<li>
<a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
<a href="#">Back to Top</a>
</li>
</ul>
</div><!--/.nav-collapse -->
</div><!--/.container -->
</div><!--/.navbar -->
<div id="header">
<h1 class="title toc-ignore">Mapping and Data Visualization with Python
(Full Course Material)</h1>
<h3 class="subtitle">A comprehensive guide for creating static and
dynamic visualizations with spatial data.</h3>
<h4 class="author">Ujaval Gandhi</h4>
</div>
<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#notebooks-and-datasets" id="toc-notebooks-and-datasets">Notebooks and Datasets</a></li>
<li><a href="#hello-colab" id="toc-hello-colab">Hello Colab</a>
<ul>
<li><a href="#package-management" id="toc-package-management">Package
Management</a></li>
<li><a href="#data-management" id="toc-data-management">Data
Management</a></li>
</ul></li>
<li><a href="#matplotlib-basics" id="toc-matplotlib-basics">Matplotlib
Basics</a>
<ul>
<li><a href="#setup" id="toc-setup">Setup</a></li>
<li><a href="#concepts" id="toc-concepts">Concepts</a></li>
<li><a href="#exercise" id="toc-exercise">Exercise</a></li>
</ul></li>
<li><a href="#creating-charts" id="toc-creating-charts">Creating
Charts</a>
<ul>
<li><a href="#overview" id="toc-overview">Overview</a></li>
<li><a href="#setup-and-data-download" id="toc-setup-and-data-download">Setup and Data Download</a></li>
<li><a href="#data-pre-processing" id="toc-data-pre-processing">Data
Pre-Processing</a></li>
<li><a href="#create-a-pie-chart" id="toc-create-a-pie-chart">Create a
Pie-Chart</a></li>
<li><a href="#create-a-bar-chart" id="toc-create-a-bar-chart">Create a
Bar Chart</a></li>
<li><a href="#exercise-1" id="toc-exercise-1">Exercise</a></li>
</ul></li>
<li><a href="#creating-maps" id="toc-creating-maps">Creating Maps</a>
<ul>
<li><a href="#overview-1" id="toc-overview-1">Overview</a></li>
<li><a href="#setup-and-data-download-1" id="toc-setup-and-data-download-1">Setup and Data Download</a></li>
<li><a href="#data-pre-processing-1" id="toc-data-pre-processing-1">Data
Pre-Processing</a></li>
<li><a href="#create-a-choropleth-map" id="toc-create-a-choropleth-map">Create a Choropleth Map</a></li>
<li><a href="#exercise-2" id="toc-exercise-2">Exercise</a></li>
</ul></li>
<li><a href="#using-basemaps" id="toc-using-basemaps">Using Basemaps</a>
<ul>
<li><a href="#overview-2" id="toc-overview-2">Overview</a></li>
<li><a href="#setup-and-data-download-2" id="toc-setup-and-data-download-2">Setup and Data Download</a></li>
<li><a href="#data-pre-processing-2" id="toc-data-pre-processing-2">Data
Pre-Processing</a></li>
<li><a href="#create-a-multi-layer-map" id="toc-create-a-multi-layer-map">Create a Multi-Layer Map</a></li>
<li><a href="#add-a-basemap" id="toc-add-a-basemap">Add A
BaseMap</a></li>
<li><a href="#exercise-3" id="toc-exercise-3">Exercise</a></li>
</ul></li>
<li><a href="#xarray-basics" id="toc-xarray-basics">XArray Basics</a>
<ul>
<li><a href="#overview-3" id="toc-overview-3">Overview</a></li>
<li><a href="#setup-and-data-download-3" id="toc-setup-and-data-download-3">Setup and Data Download</a></li>
<li><a href="#xarray-terminology" id="toc-xarray-terminology">XArray
Terminology</a></li>
<li><a href="#selecting-data" id="toc-selecting-data">Selecting
Data</a></li>
<li><a href="#masking-and-subsetting-data" id="toc-masking-and-subsetting-data">Masking and Subsetting
Data</a></li>
<li><a href="#aggregating-data" id="toc-aggregating-data">Aggregating
Data</a></li>
<li><a href="#exercise-4" id="toc-exercise-4">Exercise</a></li>
</ul></li>
<li><a href="#mapping-gridded-datasets" id="toc-mapping-gridded-datasets">Mapping Gridded Datasets</a>
<ul>
<li><a href="#overview-4" id="toc-overview-4">Overview</a></li>
<li><a href="#setup-and-data-download-4" id="toc-setup-and-data-download-4">Setup and Data Download</a></li>
<li><a href="#data-pre-processing-3" id="toc-data-pre-processing-3">Data
Pre-Processing</a></li>
<li><a href="#plotting-using-matplotlib" id="toc-plotting-using-matplotlib">Plotting using Matplotlib</a></li>
<li><a href="#plotting-using-cartopy" id="toc-plotting-using-cartopy">Plotting using CartoPy</a></li>
<li><a href="#exercise-5" id="toc-exercise-5">Exercise</a></li>
</ul></li>
<li><a href="#visualizing-rasters" id="toc-visualizing-rasters">Visualizing Rasters</a>
<ul>
<li><a href="#overview-5" id="toc-overview-5">Overview</a></li>
<li><a href="#setup-and-data-download-5" id="toc-setup-and-data-download-5">Setup and Data Download</a></li>
<li><a href="#rioxarray-basics" id="toc-rioxarray-basics">Rioxarray
Basics</a></li>
<li><a href="#plotting-multiple-rasters" id="toc-plotting-multiple-rasters">Plotting Multiple Rasters</a></li>
<li><a href="#merging-rasters" id="toc-merging-rasters">Merging
Rasters</a></li>
<li><a href="#annotating-plots" id="toc-annotating-plots">Annotating
Plots</a></li>
<li><a href="#exercise-6" id="toc-exercise-6">Exercise</a></li>
</ul></li>
<li><a href="#interactive-maps-with-folium" id="toc-interactive-maps-with-folium">Interactive Maps with Folium</a>
<ul>
<li><a href="#overview-6" id="toc-overview-6">Overview</a></li>
<li><a href="#setup-1" id="toc-setup-1">Setup</a></li>
<li><a href="#folium-basics" id="toc-folium-basics">Folium
Basics</a></li>
<li><a href="#exercise-7" id="toc-exercise-7">Exercise</a></li>
</ul></li>
<li><a href="#multi-layer-interactive-maps" id="toc-multi-layer-interactive-maps">Multi-layer Interactive Maps</a>
<ul>
<li><a href="#overview-7" id="toc-overview-7">Overview</a></li>
<li><a href="#setup-and-data-download-6" id="toc-setup-and-data-download-6">Setup and Data Download</a></li>
<li><a href="#using-geopandas-explore" id="toc-using-geopandas-explore">Using GeoPandas explore()</a></li>
<li><a href="#create-multi-layer-maps" id="toc-create-multi-layer-maps">Create Multi-layer Maps</a></li>
<li><a href="#exercise-8" id="toc-exercise-8">Exercise</a></li>
</ul></li>
<li><a href="#leafmap-basics" id="toc-leafmap-basics">Leafmap Basics</a>
<ul>
<li><a href="#overview-8" id="toc-overview-8">Overview</a></li>
<li><a href="#setup-and-data-download-7" id="toc-setup-and-data-download-7">Setup and Data Download</a></li>
<li><a href="#creating-a-map" id="toc-creating-a-map">Creating a
Map</a></li>
<li><a href="#adding-data-layers" id="toc-adding-data-layers">Adding
Data Layers</a></li>
<li><a href="#exercise-9" id="toc-exercise-9">Exercise</a></li>
</ul></li>
<li><a href="#streamlit-basics" id="toc-streamlit-basics">Streamlit
Basics</a>
<ul>
<li><a href="#installation-and-setting-up-the-environment" id="toc-installation-and-setting-up-the-environment">Installation and
Setting up the Environment</a></li>
<li><a href="#create-a-simple-dashboard" id="toc-create-a-simple-dashboard">Create a Simple Dashboard</a></li>
<li><a href="#exercise-10" id="toc-exercise-10">Exercise</a></li>
<li><a href="#create-a-simple-app" id="toc-create-a-simple-app">Create a
Simple App</a></li>
<li><a href="#exercise-11" id="toc-exercise-11">Exercise</a></li>
</ul></li>
<li><a href="#building-mapping-apps-with-leafmap-and-streamlit" id="toc-building-mapping-apps-with-leafmap-and-streamlit">Building
Mapping Apps with Leafmap and Streamlit</a>
<ul>
<li><a href="#create-a-mapping-dashboard" id="toc-create-a-mapping-dashboard">Create a Mapping Dashboard</a></li>
</ul></li>
<li><a href="#publishing-apps-with-streamlit-cloud" id="toc-publishing-apps-with-streamlit-cloud">Publishing Apps with
Streamlit Cloud</a>
<ul>
<li><a href="#upload-the-app-to-github" id="toc-upload-the-app-to-github">Upload the app to GitHub</a></li>
<li><a href="#add-app-dependencies" id="toc-add-app-dependencies">Add
App dependencies</a></li>
<li><a href="#replace-sensitive-data-with-secrets" id="toc-replace-sensitive-data-with-secrets">Replace Sensitive Data with
Secrets</a></li>
<li><a href="#deploy-your-app" id="toc-deploy-your-app">Deploy your
App</a></li>
</ul></li>
<li><a href="#supplement" id="toc-supplement">Supplement</a>
<ul>
<li><a href="#contextily" id="toc-contextily">Contextily</a>
<ul>
<li><a href="#creating-an-artistic-rendering-of-a-city" id="toc-creating-an-artistic-rendering-of-a-city">Creating an Artistic
Rendering of a City</a></li>
</ul></li>
<li><a href="#advanced-plotting" id="toc-advanced-plotting">Advanced
Plotting</a>
<ul>
<li><a href="#elevation-profile-plot-from-a-gps-track" id="toc-elevation-profile-plot-from-a-gps-track">Elevation Profile Plot
from a GPS Track</a></li>
<li><a href="#creating-a-stacked-bar-chart" id="toc-creating-a-stacked-bar-chart">Creating A Stacked Bar
Chart</a></li>
<li><a href="#labeling-features" id="toc-labeling-features">Labeling
Features</a></li>
<li><a href="#creating-time-series-charts" id="toc-creating-time-series-charts">Creating Time-Series
Charts</a></li>
<li><a href="#feature-correlation-matrix" id="toc-feature-correlation-matrix">Feature Correlation Matrix</a></li>
</ul></li>
<li><a href="#animation" id="toc-animation">Animation</a>
<ul>
<li><a href="#creating-animated-maps" id="toc-creating-animated-maps">Creating Animated Maps</a></li>
</ul></li>
<li><a href="#leafmap" id="toc-leafmap">Leafmap</a>
<ul>
<li><a href="#downloading-and-visualizing-osm-data-with-leafmap" id="toc-downloading-and-visualizing-osm-data-with-leafmap">Downloading
and Visualizing OSM Data with LeafMap</a></li>
<li><a href="#visualizing-osm-data" id="toc-visualizing-osm-data">Visualizing OSM Data</a></li>
</ul></li>
</ul></li>
<li><a href="#resources" id="toc-resources">Resources</a></li>
<li><a href="#data-credits" id="toc-data-credits">Data Credits</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<hr/>
<p><img src="https://courses.spatialthoughts.com/images/spatial_thoughts_logo.png" style="display: block; margin: auto;" width="250pt"/></p>
<hr/>
<div style="page-break-after: always;"></div>
<div class="section level1" id="introduction">
<h1>Introduction</h1>
<p>This is an intermediate-level course that teaches you how to use
Python for creating charts, plots, animations, and maps.</p>
<p><a href="https://docs.google.com/presentation/d/1Mc8O7zXJt-0LwUocPjpfjvkqYj-0qRnUMUIFpftVZFw/edit?usp=sharing" target="_blank"><img alt="View Presentation" src="https://courses.spatialthoughts.com/images/python_dataviz/course_overview.png" width="400"/></a></p>
<p><a href="https://docs.google.com/presentation/d/1Mc8O7zXJt-0LwUocPjpfjvkqYj-0qRnUMUIFpftVZFw/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
</div>
<div class="section level1" id="notebooks-and-datasets">
<h1>Notebooks and Datasets</h1>
<p>This course uses Google Colab for all exercises. You do not need to
install any packages or download any datasets.</p>
<p>The notebooks can be accessed by clicking on the <img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/> buttons at the beginning of each section. Once
you have opened the notebook in Colab, you can copy it to your own
account by going to <em>File → Save a Copy in Drive</em>.</p>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/colab1.png" style="display: block; margin: auto;" width="75%"/></p>
<p>Once the notebooks are saved to your drive, you will be able to
modify the code and save the updated copy. You can also click the
<em>Share</em> button and share a link to the notebook with others.</p>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/colab2.png" style="display: block; margin: auto;" width="75%"/></p>
<div style="page-break-after: always;"></div>
</div>
<div class="section level1" id="hello-colab">
<h1>Hello Colab</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/00_hello_colab.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<p><a href="https://colab.research.google.com/">Google Colab</a> is a
hosted Jupyter notebook environment that allows anyone to run Python
code via a web-browser. It provides you free computation and data
storage that can be utilized by your Python code.</p>
<p>You can click the <code>+Code</code> button to create a new cell and
enter a block of code. To run the code, click the <strong>Run
Code</strong> button next to the cell, or press <code>Shirt+Enter</code>
key.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Hello World'</span>)</span></code></pre></div>
<div class="section level3" id="package-management">
<h3>Package Management</h3>
<p>Colab comes pre-installed with many Python packages. You can use a
package by simply importing it.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code></pre></div>
<p>Each Colab notebook instance is run on a Ubuntu Linux machine in the
cloud. If you want to install any packages, you can run a command by
prefixing the command with a <code>!</code>. For example, you can
install third-party packages via <code>pip</code> using the command
<code>!pip</code>.</p>
<blockquote>
<p>Tip: If you want to list all pre-install packages and their versions
in your Colab environemnt, you can run <code>!pip list -v</code>.</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">--</span>quiet rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> rioxarray</span></code></pre></div>
<p>Some packages may also require additional binaries or local
configuration. This can be achieved using package management commands
for Ubuntu Linux. For example, we can run <code>apt</code> command to
install specific package required for <code>geopandas</code> to work
correctly.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="op">!</span>apt install <span class="op">-</span>qq libspatialindex<span class="op">-</span>dev</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">--</span>quiet fiona shapely pyproj rtree</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">--</span>quiet geopandas</span></code></pre></div>
<pre><code>libspatialindex-dev is already the newest version (1.8.5-5).
The following package was automatically installed and is no longer required:
  libnvidia-common-460
Use 'apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 20 not upgraded.</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code></pre></div>
</div>
<div class="section level3" id="data-management">
<h3>Data Management</h3>
<p>Colab provides 100GB of disk space along with your notebook. This can
be used to store your data, intermediate outputs and results.</p>
<p>The code below will create 2 folders named ‘data’ and ‘output’ in
your local filesystem.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<p>We can download some data from the internet and store it in the Colab
environment. Below is a helper function that uses <code>urllib</code> to
fetch any file from a URL.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span></code></pre></div>
<p>Let’s download the <a href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/">Populated
Places</a> dataset from Natural Earth.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>download(<span class="st">'https://naciscdn.org/naturalearth/10m/cultural/'</span> <span class="op">+</span> </span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>         <span class="st">'ne_10m_populated_places_simple.zip'</span>)</span></code></pre></div>
<pre><code>Downloaded data/ne_10m_populated_places_simple.zip</code></pre>
<p>The file is now in our local filesystem. We can construct the path to
the data folder and read it using <code>geopandas</code></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> <span class="st">'ne_10m_populated_places_simple.zip'</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>filepath <span class="op">=</span> os.path.join(data_folder, <span class="bu">file</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>places <span class="op">=</span> gpd.read_file(filepath)</span></code></pre></div>
<p>Let’s do some data processing and write the results to a new file.
The code below will filter all places which are also country
capitals.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>capitals <span class="op">=</span> places[places[<span class="st">'adm0cap'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>capitals</span></code></pre></div>
<p>We can write the results to the disk as a GeoPackage file.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">'capitals.gpkg'</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>capitals.to_file(driver<span class="op">=</span><span class="st">'GPKG'</span>, filename<span class="op">=</span>output_path)</span></code></pre></div>
<p>You can open the <strong>Files</strong> tab from the left-hand panel
in Colab and browse to the <code>output</code> folder. Locate the
<code>capitals.gpkg</code> file and click the <strong>⋮</strong> button
and select <em>Download</em> to download the file locally.</p>
<hr/>
</div>
</div>
<div class="section level1" id="matplotlib-basics">
<h1>Matplotlib Basics</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/01_matplotlib_basics.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<p>This notebook introduces the <a href="https://matplotlib.org/">Matplotlib</a> library. This is one of
the core Python packages for data visualization and is used by many
spatial and non-spatial packages to create charts and maps.</p>
<div class="section level2" id="setup">
<h2>Setup</h2>
<p>Most of the Matplotlib functionality is available in the
<code>pyplot</code> submodule, and by convention is imported as
<code>plt</code></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div class="section level2" id="concepts">
<h2>Concepts</h2>
<p>It is important to understand the 2 matplotlib objects</p>
<ul>
<li>Figure: This is the main container of the plot. A figure can contain
multiple plots inside it</li>
<li>Axes: Axes refers to an individual plot or graph. A figure contains
1 or more axes.</li>
</ul>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/matplotlib_terminology.png" width="800/"/></p>
<p>We create a figure and a single subplot. Specifying 1 row and 1
column for the <code>subplots()</code> function create a figure and an
axes within it. Even if we have a single plot in the figure, it is
useful to use this logic of intialization so it is consistent across
different scripts.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>First, let’s learn how to plot a single point using matplotlib. Let’s
say we want to display a point at the coordinate (0.5, 0.5).</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>point <span class="op">=</span> (<span class="fl">0.5</span>, <span class="fl">0.5</span>)</span></code></pre></div>
<p>We display the point using the <code>plot()</code> function. The
<code>plot()</code> function expects at least 2 arguments, first one
being one or more x coordinates and the second one being one or more y
coordinates. Remember that once a plot is displayed using
<code>plt.show()</code>, it displays the plot and empties the figure. So
you’ll have to create it again.</p>
<p>Reference: <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html">matplotlib.pyplot.plot</a></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>ax.plot(point[<span class="dv">0</span>], point[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'green'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Note: Understanding <code>*args</code> and <code>**kwargs</code></p>
<p>Python functions accept 2 types of arguments. - <em>Non Keyword
Arguments</em>: These are referred as <code>*args</code>. When the
number of arguments that a function takes is not fixed, it is specified
as <code>*args</code>. In the function <code>plot()</code> above, you
can specify 1 argument, 2 arguments or even 6 arguments and the function
will respond accordingly. - <em>Keyword Arguments</em>: These are
referred as <code>**kwargs</code>. These are specified as
<code>key=value</code> pairs and usually used to specify optional
parameters. These should always be specified after the non-keyword
arguments. The <code>color='green'</code> in the <code>plot()</code>
function is a keyboard argument.</p>
<p>One problematic area for plotting geospatial data using matplotlib is
that geospatial data is typically represented as a list of x and y
coordinates. Let’s say we want to plot the following 3 points defined as
a list of (x,y) tuples.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>points <span class="op">=</span> [(<span class="fl">0.1</span>, <span class="fl">0.5</span>), (<span class="fl">0.5</span>, <span class="fl">0.5</span>), (<span class="fl">0.9</span>, <span class="fl">0.5</span>)]</span></code></pre></div>
<p>But to plot it, <code>matplotlib</code> require 2 separate lists or x
and y coordinates. Here we can use the <code>zip()</code> function to
create list of x and y coordinates.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>x, y <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>points)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="bu">print</span>(x)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="bu">print</span>(y)</span></code></pre></div>
<p>Now these can be plotted using the <code>plot()</code> method. We
specify keyword arguments <code>color</code> and
<code>marker</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>ax.plot(x, y, color<span class="op">=</span><span class="st">'green'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>ax.plot(x, y, color<span class="op">=</span><span class="st">'green'</span>, marker<span class="op">=</span><span class="st">'o'</span>, linestyle<span class="op">=</span><span class="st">'None'</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>You can save the figure using the <code>savefig()</code> method.
Remember to save the figure <em>before</em> calling
<code>plt.show()</code> otherwise the figure would be empty.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>ax.plot(x, y, color<span class="op">=</span><span class="st">'green'</span>, marker<span class="op">=</span><span class="st">'o'</span>, linestyle<span class="op">=</span><span class="st">'None'</span>)</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'simple.png'</span>)</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/01_matplotlib_basics_files/01_matplotlib_basics_22_0.png"/></p>
<p>Matplotlib provides many specialized functions for different types of
plots. <code>scatter()</code> for Scatter Charts, <code>bar()</code> for
Bar Charts and so on. You can use them directly, but in practice they
are used via higher-level libraries like <code>pandas</code>. In the
next section, we will see how to create such charts.</p>
</div>
<div class="section level2" id="exercise">
<h2>Exercise</h2>
<p>Create a plot that displays the 2 given points with their x,y
coordinates with different sumbology.</p>
<ul>
<li><code>point1</code>: Plot it with green color and a triangle
marker.</li>
<li><code>point2</code>: Plot it with red color and a circle
marker.</li>
</ul>
<p>Reference: <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html">matplotlib.pyplot.plot</a></p>
<blockquote>
<p>Hint: You can call <code>plot()</code> multiple times to add new data
to the same Axes.</p>
</blockquote>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>point1 <span class="op">=</span> (<span class="dv">4</span>, <span class="dv">1</span>)</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>point2 <span class="op">=</span> (<span class="dv">3</span>, <span class="dv">4</span>)</span></code></pre></div>
<hr/>
</div>
</div>
<div class="section level1" id="creating-charts">
<h1>Creating Charts</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/02_creating_charts.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level2" id="overview">
<h2>Overview</h2>
<p>Pandas allows you to read structured datasets and visualize them
using the <code>plot()</code> method. By default, Pandas uses
<code>matplotlib</code> to create the plots.</p>
<p>In this notebook, we will take work with open dataset of crime in
London.</p>
</div>
<div class="section level2" id="setup-and-data-download">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span></code></pre></div>
<p>We have 12 different CSV files containing crime data for each month
of 2020. We download each of them to the data folder.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>files <span class="op">=</span> [</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>  <span class="st">'2020-01-metropolitan-street.csv'</span>,</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>  <span class="st">'2020-02-metropolitan-street.csv'</span>,</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>  <span class="st">'2020-03-metropolitan-street.csv'</span>,</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>  <span class="st">'2020-04-metropolitan-street.csv'</span>,</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>  <span class="st">'2020-05-metropolitan-street.csv'</span>,</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>  <span class="st">'2020-06-metropolitan-street.csv'</span>,</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>  <span class="st">'2020-07-metropolitan-street.csv'</span>,</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>  <span class="st">'2020-08-metropolitan-street.csv'</span>,</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>  <span class="st">'2020-09-metropolitan-street.csv'</span>,</span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>  <span class="st">'2020-10-metropolitan-street.csv'</span>,</span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>  <span class="st">'2020-11-metropolitan-street.csv'</span>,</span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>  <span class="st">'2020-12-metropolitan-street.csv'</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>]</span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/crime/'</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>  url <span class="op">=</span> os.path.join(data_url <span class="op">+</span> f)</span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>  download(url)</span></code></pre></div>
</div>
<div class="section level2" id="data-pre-processing">
<h2>Data Pre-Processing</h2>
<p>It will be helpful to merge all 12 CSV files into a single dataframe.
We can use <code>pd.concat()</code> to merge a list of dataframes.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>dataframe_list <span class="op">=</span> []</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>    filepath <span class="op">=</span> os.path.join(data_folder, f)</span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>    dataframe_list.append(df)</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>merged_df <span class="op">=</span> pd.concat(dataframe_list)</span></code></pre></div>
<p>The resulting dataframe consists of over 1 million records of various
crimes recorded in London in the year 2020.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>merged_df</span></code></pre></div>
</div>
<div class="section level2" id="create-a-pie-chart">
<h2>Create a Pie-Chart</h2>
<p>Let’s create a pie-chart showing the distribution of different types
of crime. Pandas <code>groupby()</code> function allows us to calculate
group statistics.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>type_counts <span class="op">=</span> merged_df.groupby(<span class="st">'Crime type'</span>).size()</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>type_counts</span></code></pre></div>
<p>We now uses the <code>plot()</code> method to create the chart. This
method is a wrapper around <code>matplotlib</code> and can accept
supported arguments from it.</p>
<p>Reference: <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.plot.html"><code>pandas.DataFrame.plot</code></a></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">10</span>)</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>type_counts.plot(kind<span class="op">=</span><span class="st">'pie'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Let’s customize the chart. First we use <code>set_title()</code>
method to add a title to the chart and <code>set_ylabel()</code> to
remove the empty y-axis label. Lastly, we use the
<code>plt.tight_layout()</code> to remove the extra whitespace around
the plot.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">10</span>)</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>type_counts.plot(kind<span class="op">=</span><span class="st">'pie'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>ax.set_title(<span class="st">'Crime Types'</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a>ax.set_ylabel(<span class="st">''</span>)</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Matplotlib plots offer unlimited possibilities to customize your
charts. Let’s see some of the options available to customize the
pie-chart.</p>
<ul>
<li><code>wedgeprops</code>: Customize the look of each ‘wedge’ of the
pie.</li>
<li><code>textprops</code>: Set the text properties of labels.</li>
</ul>
<p>Reference: <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.pie.html"><code>matplotlib.pyplot.pie</code></a></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>wedgeprops<span class="op">=</span>{<span class="st">'linewidth'</span>: <span class="dv">1</span>, <span class="st">'edgecolor'</span>: <span class="st">'white'</span>}</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>textprops<span class="op">=</span> {<span class="st">'fontsize'</span>: <span class="dv">10</span>, <span class="st">'fontstyle'</span>: <span class="st">'italic'</span>}</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">10</span>)</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a>type_counts.plot(kind<span class="op">=</span><span class="st">'pie'</span>, ax<span class="op">=</span>ax, </span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a>                 wedgeprops<span class="op">=</span>wedgeprops,</span>
<span id="cb35-9"><a href="#cb35-9" tabindex="-1"></a>                 textprops<span class="op">=</span>textprops</span>
<span id="cb35-10"><a href="#cb35-10" tabindex="-1"></a>                 )</span>
<span id="cb35-11"><a href="#cb35-11" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" tabindex="-1"></a>ax.set_title(<span class="st">'Crime Types'</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb35-13"><a href="#cb35-13" tabindex="-1"></a>ax.set_ylabel(<span class="st">''</span>)</span>
<span id="cb35-14"><a href="#cb35-14" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb35-16"><a href="#cb35-16" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/02_creating_charts_files/02_creating_charts_20_0.png"/></p>
</div>
<div class="section level2" id="create-a-bar-chart">
<h2>Create a Bar Chart</h2>
<p>We can also chart the trend of crime over the year. For this, let’s
group the data by month.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>monthly_counts <span class="op">=</span> merged_df.groupby(<span class="st">'Month'</span>).size()</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>monthly_counts</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>monthly_counts.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>As we learnt earlier, we can add multiple plots on the same Axes. We
can add a <code>line</code> chart along with the <code>bar</code> chart
to show the trendline as well. Lastly we add the titles and axis labels
to finish the chart.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a>monthly_counts.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>monthly_counts.plot(kind<span class="op">=</span><span class="st">'line'</span>, ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'red'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>ax.set_title(<span class="st">'Total Crime by Month'</span>)</span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Total Incidents'</span>)</span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/02_creating_charts_files/02_creating_charts_25_0.png"/></p>
</div>
<div class="section level2" id="exercise-1">
<h2>Exercise</h2>
<p>Plot the trend of Bicycle thefts as a line chart. The cell below
filters the <code>merged_df</code> dataframe to select incidents of
‘Bicycle theft’. Group the results by months and plot the results.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>bicycle_thefts <span class="op">=</span> merged_df[merged_df[<span class="st">'Crime type'</span>] <span class="op">==</span> <span class="st">'Bicycle theft'</span>]</span></code></pre></div>
<hr/>
</div>
</div>
<div class="section level1" id="creating-maps">
<h1>Creating Maps</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/03_creating_maps.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level2" id="overview-1">
<h2>Overview</h2>
<p>Similar to Pandas, GeoPandas has a <code>plot()</code> method that
can plot geospatial data using Matplotlib.</p>
<p>We will work with census data to create a choropleth map of
population density. We will start with a shapefile of census tracts, and
join it with tabular data to get a GeoDataframe with census tract
geometry and correponding populations.</p>
</div>
<div class="section level2" id="setup-and-data-download-1">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree mapclassify</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span></code></pre></div>
<p>We will download the the census tracts shapefile and a CSV file
containing a variety of population statistics for each tract.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a>shapefile_name <span class="op">=</span> <span class="st">'tl_2019_06_tract'</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">'.shp'</span>, <span class="st">'.shx'</span>, <span class="st">'.dbf'</span>, <span class="st">'.prj'</span>]</span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/census/'</span></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a><span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a>  url <span class="op">=</span> data_url <span class="op">+</span> shapefile_name <span class="op">+</span> ext</span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a>  download(url)</span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>csv_name <span class="op">=</span> <span class="st">'ACSST5Y2019.S0101_data.csv'</span></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a>download(data_url <span class="op">+</span> csv_name)</span></code></pre></div>
</div>
<div class="section level2" id="data-pre-processing-1">
<h2>Data Pre-Processing</h2>
<p>Let’s read the census tracts shapefile and the CSV file containing
population counts.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>shapefile_path <span class="op">=</span> os.path.join(data_folder, shapefile_name <span class="op">+</span> <span class="st">'.shp'</span>)</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>tracts <span class="op">=</span> gpd.read_file(shapefile_path)</span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>tracts</span></code></pre></div>
<p>We now read the file containing a variety of population statistics
for each tract. We read this file as a Pandas DataFrame. The CSV file
contains an extra row before the header, so we specify
<code>skiprows=[1]</code> to skip reading it.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>csv_path <span class="op">=</span> os.path.join(data_folder, csv_name)</span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>table <span class="op">=</span> pd.read_csv(csv_path, skiprows<span class="op">=</span>[<span class="dv">1</span>])</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>table</span></code></pre></div>
<p>To join this DataFrame with the GeoDataFrame, we need a column with
unique identifiers. We use the <code>GEOID</code> column and process the
id so they match exactly in both datasets.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>filtered <span class="op">=</span> table[[<span class="st">'GEO_ID'</span>,<span class="st">'NAME'</span>, <span class="st">'S0101_C01_001E'</span>]]</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>filtered <span class="op">=</span> filtered.rename(columns <span class="op">=</span> {<span class="st">'S0101_C01_001E'</span>: <span class="st">'Population'</span>, <span class="st">'GEO_ID'</span>: <span class="st">'GEOID'</span>})</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>filtered[<span class="st">'GEOID'</span>] <span class="op">=</span> filtered.GEOID.<span class="bu">str</span>[<span class="op">-</span><span class="dv">11</span>:]</span></code></pre></div>
<p>Finally, we do a table join using the <code>merge</code> method.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>gdf <span class="op">=</span> tracts.merge(filtered, on<span class="op">=</span><span class="st">'GEOID'</span>)</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>gdf</span></code></pre></div>
<p>For creating a choropleth map, we must normalize the population
counts. US Census Bureau <a href="https://www.census.gov/quickfacts/fact/note/US/LND110210">recommends</a>
calculating the population density by dividing the total population by
the land area. The original shapefile contains a column
<code>ALAND</code> with the land area in square kilometers. Using it, we
compute a new column <code>density</code> containing the persons per
square kilometer.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a>gdf[<span class="st">'density'</span>] <span class="op">=</span> <span class="fl">1e6</span><span class="op">*</span>gdf[<span class="st">'Population'</span>]<span class="op">/</span>gdf[<span class="st">'ALAND'</span>]</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a>gdf</span></code></pre></div>
</div>
<div class="section level2" id="create-a-choropleth-map">
<h2>Create a Choropleth Map</h2>
<p>The <code>plot()</code> method will render the data to a plot.</p>
<p>Reference: <a href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.plot.html">geopandas.GeoDataFrame.plot</a></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax)</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>You can supply additional style options to change the appearance of
the map. <code>facecolor</code> and <code>edgecolor</code> parameters
are used to determine the fill and outline colors respectively. The
stroke width can be adjusted using the <code>linewidth</code>
parameter.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#f0f0f0'</span>, edgecolor<span class="op">=</span><span class="st">'#de2d26'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We have the population density for each tract in the
<code>density</code> column. We can assign a color to each polygon based
on the value in this column - resulting in a choropleth map.
Additionally, we need to specify a color ramp using <code>cmap</code>
and classification scheme using <code>scheme</code>. The classification
schedule will determine how the continuous data will be classified into
discrete bins.</p>
<blockquote>
<p>Tip: You can add <code>_r</code> to any color ramp name to get a
<strong>r</strong>eversed version of that ramp.</p>
</blockquote>
<p>References: - <a href="https://matplotlib.org/stable/tutorials/colors/colormaps.html">Matplotlib
Colormaps</a> - <a href="https://pysal.org/mapclassify/generated/mapclassify.classify.html#mapclassify.classify">Mapclassify
Classification Schemes</a></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'density'</span>, cmap<span class="op">=</span><span class="st">'RdYlGn_r'</span>, scheme<span class="op">=</span><span class="st">'quantiles'</span>)</span>
<span id="cb52-4"><a href="#cb52-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Instead of the class breaks being determined by the classification
scheme, we can also manually specify the ranges. This is preferable so
we can have a human-interpretable legend. The <code>legend=True</code>
parameter adds a legend to our plot.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'density'</span>, cmap<span class="op">=</span><span class="st">'RdYlGn_r'</span>, scheme<span class="op">=</span><span class="st">'User_Defined'</span>, </span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a>         classification_kwds<span class="op">=</span><span class="bu">dict</span>(bins<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]),</span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a>         legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We give final touches to our map and save the result as a PNG file.
Remember to call <code>plt.savefig()</code> before showing the plot as
the plot gets emptied after being shown.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'california_pop.png'</span>)</span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'density'</span>, cmap<span class="op">=</span><span class="st">'RdYlGn_r'</span>, scheme<span class="op">=</span><span class="st">'User_Defined'</span>, </span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a>         classification_kwds<span class="op">=</span><span class="bu">dict</span>(bins<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]),</span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a>         legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a>ax.set_title(<span class="st">'California Population Density (2019)'</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/03_creating_maps_files/03_creating_maps_29_0.png"/></p>
</div>
<div class="section level2" id="exercise-2">
<h2>Exercise</h2>
<p>Plot the census tracts geodataframe <code>tracts</code> with just
outlines and no fill color.</p>
<blockquote>
<p>Hint: Set the <code>facecolor</code> option to <code>'none'</code>
for no fills. Check the <a href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.plot.html"><em>style_kwds</em>
parameter</a> of the <code>plot()</code> method for more details.</p>
</blockquote>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>tracts.plot(ax<span class="op">=</span>ax)</span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<hr/>
</div>
</div>
<div class="section level1" id="using-basemaps">
<h1>Using Basemaps</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/04_using_basemaps.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level2" id="overview-2">
<h2>Overview</h2>
<p>Creating geospatial visualizations oftern require overlaying your
data on a basemap. <a href="https://contextily.readthedocs.io/en/latest/">Contextily</a> is a
package that allows you to fetch various basemaps from the internet and
ad them to your plot as static images.</p>
<p>We will learn how to take a shapefile showing the path of the <a href="https://svs.gsfc.nasa.gov/4518">2017 Solar Eclipse</a> and create
a map with a topographic basemap.</p>
</div>
<div class="section level2" id="setup-and-data-download-2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree</span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a>  <span class="op">!</span>pip install contextily</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb59-6"><a href="#cb59-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb59-7"><a href="#cb59-7" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" tabindex="-1"></a>path_shapefile <span class="op">=</span> <span class="st">'upath17'</span></span>
<span id="cb59-9"><a href="#cb59-9" tabindex="-1"></a>umbra_shapefile <span class="op">=</span> <span class="st">'umbra17'</span></span>
<span id="cb59-10"><a href="#cb59-10" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">'.shp'</span>, <span class="st">'.shx'</span>, <span class="st">'.dbf'</span>, <span class="st">'.prj'</span>]</span>
<span id="cb59-11"><a href="#cb59-11" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/eclipse/'</span></span>
<span id="cb59-12"><a href="#cb59-12" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" tabindex="-1"></a><span class="cf">for</span> shapefile <span class="kw">in</span> [path_shapefile, umbra_shapefile]:</span>
<span id="cb59-14"><a href="#cb59-14" tabindex="-1"></a>  <span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb59-15"><a href="#cb59-15" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> shapefile <span class="op">+</span> ext</span>
<span id="cb59-16"><a href="#cb59-16" tabindex="-1"></a>    download(url)</span></code></pre></div>
</div>
<div class="section level2" id="data-pre-processing-2">
<h2>Data Pre-Processing</h2>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a>path_shapefile_path <span class="op">=</span> os.path.join(data_folder, path_shapefile <span class="op">+</span> <span class="st">'.shp'</span>)</span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a>path_gdf <span class="op">=</span> gpd.read_file(path_shapefile_path)</span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a>path_gdf</span></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a>umbra_shapefile_path <span class="op">=</span> os.path.join(data_folder, umbra_shapefile <span class="op">+</span> <span class="st">'.shp'</span>)</span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a>umbra_gdf <span class="op">=</span> gpd.read_file(umbra_shapefile_path)</span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>umbra_gdf[:<span class="dv">5</span>]</span></code></pre></div>
</div>
<div class="section level2" id="create-a-multi-layer-map">
<h2>Create a Multi-Layer Map</h2>
<p>We can show a GeoDataFrame using the <code>plot()</code> method.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>path_gdf.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#cccccc'</span>, edgecolor<span class="op">=</span><span class="st">'#969696'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>To add another layer to our plot, we can simply render another
GeoDataFrame on the same Axes.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a>path_gdf.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#cccccc'</span>, edgecolor<span class="op">=</span><span class="st">'#969696'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a>umbra_gdf.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#636363'</span>, edgecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb63-5"><a href="#cb63-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div class="section level2" id="add-a-basemap">
<h2>Add A BaseMap</h2>
<p>The visualization is not useful as it is missing context. We want to
overlay this on a basemap to understand where the eclipse was visible
from. We can choose from a variety of basemap tiles. There are over 200
basemap styles included in the library. Let’s see them using the
<code>providers</code> property.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a>providers <span class="op">=</span> cx.providers</span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a>providers</span></code></pre></div>
<p>For overlaying the eclipse path, let’s use the <em>OpenTopoMap</em>
basemap. We need to specify a CRS for the map. For now, let’s use the
CRS of the original shapefile.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>path_gdf.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#cccccc'</span>, edgecolor<span class="op">=</span><span class="st">'#969696'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>umbra_gdf.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#636363'</span>, edgecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>path_gdf.crs, source<span class="op">=</span>cx.providers.OpenTopoMap)</span>
<span id="cb65-8"><a href="#cb65-8" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>The web tiles for the basemap are in the Web Mercator CRS
(EPSG:3857). When you request them in a different CRS, they are warped
to the requested CRS. This may cause the labels to not be legible in
some cases. Instead, we can request the tiles in their original CRS and
reproject our data layer to its CRS.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>path_reprojected <span class="op">=</span> path_gdf.to_crs(<span class="st">'EPSG:3857'</span>)</span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a>umbra_reprojected <span class="op">=</span> umbra_gdf.to_crs(<span class="st">'EPSG:3857'</span>)</span>
<span id="cb66-3"><a href="#cb66-3" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb66-5"><a href="#cb66-5" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb66-6"><a href="#cb66-6" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" tabindex="-1"></a>path_reprojected.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#cccccc'</span>, edgecolor<span class="op">=</span><span class="st">'#969696'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb66-8"><a href="#cb66-8" tabindex="-1"></a>umbra_reprojected.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#636363'</span>, edgecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb66-9"><a href="#cb66-9" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>path_reprojected.crs, source<span class="op">=</span>cx.providers.OpenTopoMap)</span>
<span id="cb66-11"><a href="#cb66-11" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb66-12"><a href="#cb66-12" tabindex="-1"></a>ax.set_title(<span class="st">'2017 Total Solar Eclipse Path'</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb66-13"><a href="#cb66-13" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/04_using_basemaps_files/04_using_basemaps_21_0.png"/></p>
</div>
<div class="section level2" id="exercise-3">
<h2>Exercise</h2>
<p>Instead of the OpenTopoMap, create a visualization using the
<em>Toner</em> basemap from <em>Stamen</em>. Save the resulting
visualization as a PNG file <code>eclipse_path.png</code>.</p>
<hr/>
</div>
</div>
<div class="section level1" id="xarray-basics">
<h1>XArray Basics</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/05_xarray_basics.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level2" id="overview-3">
<h2>Overview</h2>
<p>Many climate and meteorological datasets come as gridded rasters in
data formats such as NetCDF and GRIB. We will use <a href="http://xarray.pydata.org/">XArray</a> to read, process and
visualize the gridded raster dataset.</p>
<p>Xarray is an evolution of rasterio and is inspired by libraries like
pandas to work with raster datasets. It is particularly suited for
working with multi-dimensional time-series raster datasets. It also
integrates tightly with dask that allows one to scale raster data
processing using parallel computing. XArray provides <a href="https://xarray.pydata.org/en/stable/user-guide/plotting.html">Plotting
Functions</a> based on Matplotlib.</p>
<p>In this section, we will take the <a href="https://data.giss.nasa.gov/gistemp/">Gridded Monthly Temperature
Anomaly Data</a> from 1880-present from GISTEMP and visualize the
temperature anomaly for the year 2021.</p>
</div>
<div class="section level2" id="setup-and-data-download-3">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb68-6"><a href="#cb68-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb68-7"><a href="#cb68-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb69"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb69-3"><a href="#cb69-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb69-4"><a href="#cb69-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb69-5"><a href="#cb69-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb69-6"><a href="#cb69-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb69-7"><a href="#cb69-7" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gistemp1200_GHCNv4_ERSSTv5.nc'</span></span>
<span id="cb69-9"><a href="#cb69-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/gistemp/'</span></span>
<span id="cb69-10"><a href="#cb69-10" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div class="section level2" id="xarray-terminology">
<h2>XArray Terminology</h2>
<p>By convention, XArray is imported as <code>xr</code>. We use Xarray’s
<code>open_dataset()</code> method to read the gridded raster. The
result is a <code>xarray.Dataset</code> object.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>file_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(file_path)</span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>ds</span></code></pre></div>
<p>The NetCDF file contains a grid of values for each month from
1880-2021 at a spatial resolution of 2 degrees. Let’s understand what is
contained in a Dataset.</p>
<ul>
<li><em>Variables</em>: This is similar to a band in a raster dataset.
Each variable contains an array of values.</li>
<li><em>Dimensions</em>: This is similar to number of array axes.</li>
<li><em>Coordinates</em>: These are the labels for values in each
dimension.</li>
<li><em>Attributes</em>: This is the metadata associated with the
dataset.</li>
</ul>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/xarray_terminology.png" width="800/"/></p>
<p>A Dataset consists of one or more <code>xarray.DataArray</code>
object. This is the main object that consists of a single variable with
dimension names, coordinates and attributes. You can access each
variable using <code>dataset.variable_name</code> syntax.</p>
<p>Let’s see the <code>time_bnds</code> variable. This contains a 2d
array which has both a starting and ending time for each one averaging
period.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>ds.time_bnds</span></code></pre></div>
<p>The main variable of interest is = <code>tempanomaly</code> -
containing the grid of temperature anomaly values at different times.
Let’s select that variable and store it as <code>da</code>.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a>da <span class="op">=</span> ds.tempanomaly</span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a>da</span></code></pre></div>
</div>
<div class="section level2" id="selecting-data">
<h2>Selecting Data</h2>
<p>XArray provides a very powerful way to select subsets of data, using
similar framework as Pandas. Similar to Panda’s <code>loc</code> and
<code>iloc</code> methods, XArray provides <code>sel</code> and
<code>isel</code> methods. Since DataArray dimensions have names, these
methods allow you to specify which dimension to query.</p>
<p>Let’s select the temperature anomany values for the last time step.
Since we know the index (-1) of the datam we can use <code>isel</code>
method.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>)</span></code></pre></div>
<p>We can also specify a value to query using the <code>sel()</code>
method.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="st">'2021-12-15'</span>)</span></code></pre></div>
<p>We can specify multiple dimensions to query for a subset. Let’s
extract the temperature anomaly at <code>lat=49</code>,
<code>lon=-123</code> and <code>time='2021-06-15'</code>. This region
experienced abnormally high temperatures in June 2021.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a>da.sel(lat<span class="op">=</span><span class="dv">49</span>, lon<span class="op">=-</span><span class="dv">123</span>, time<span class="op">=</span><span class="st">'2021-06-15'</span>)</span></code></pre></div>
<p>The <code>sel()</code> method also support nearest neighbor lookups.
This is useful when you do not know the exact label of the dimension,
but want to find the closest one.</p>
<blockquote>
<p>Tip: You can use <code>interp()</code> instead of <code>sel()</code>
to interpolate the value instead of closest lookup.</p>
</blockquote>
<div class="sourceCode" id="cb76"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a>da.sel(lat<span class="op">=</span><span class="fl">28.6</span>, lon<span class="op">=</span><span class="fl">77.2</span>, time<span class="op">=</span><span class="st">'2021-05-01'</span>, method<span class="op">=</span><span class="st">'nearest'</span>)</span></code></pre></div>
<p>You can call <code>.values</code> on a DataArray to get an array of
the values.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a>selected <span class="op">=</span> da.sel(lat<span class="op">=</span><span class="fl">28.6</span>, lon<span class="op">=</span><span class="fl">77.2</span>, time<span class="op">=</span><span class="st">'2021-05-01'</span>, method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a><span class="bu">print</span>(selected.values)</span></code></pre></div>
<p>The <code>sel()</code> method also allows specifying range of values
using Python’s built-in <code>slice()</code> function. The code below
will select all observationss in the year 2021.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">'2021-01-01'</span>, <span class="st">'2021-12-31'</span>))</span></code></pre></div>
</div>
<div class="section level2" id="masking-and-subsetting-data">
<h2>Masking and Subsetting Data</h2>
<p>XArray has a <a href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.where.html"><code>where()</code></a>
function that allows you to extract a subset of the array. The code
block below extracts the anomaly at a specific Lat/Lon. We then use the
<code>.where()</code> function to select items that have a positive
anomaly.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a>selected <span class="op">=</span> da.sel(lat<span class="op">=</span><span class="fl">28.6</span>, lon<span class="op">=</span><span class="fl">77.2</span>, method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a>selected</span></code></pre></div>
<p>We can use <code>drop=True</code> to remove all items where the
condition did not match and create a subset of the data.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a>positive <span class="op">=</span> selected.where(selected <span class="op">&gt;</span> <span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a>positive</span></code></pre></div>
</div>
<div class="section level2" id="aggregating-data">
<h2>Aggregating Data</h2>
<p>A very-powerful feature of XArray is the ability to easily aggregate
data across dimensions - making it ideal for many remote sensing
analysis. Let’s calculate the average temperature anomany for the year
2021.</p>
<p>We first select the subset for year 2021 and apply the
<code>.mean()</code> aggregation across the <code>time</code>
dimension.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a>subset2021 <span class="op">=</span> da.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">'2021-01-01'</span>, <span class="st">'2021-12-31'</span>))</span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a>subset2021.mean(dim<span class="op">=</span><span class="st">'time'</span>)</span></code></pre></div>
<p>XArray has many features easily work with time-series data such as
this. We can use temporal components to aggregate the data across time.
Here we take our monthly time-series of anomalies and aggregate it to a
yearly time-series using the <code>groupby()</code> method.</p>
<p>Reference: <a href="https://docs.xarray.dev/en/stable/user-guide/time-series.html#resampling-and-grouped-operations">Resampling
and grouped operations</a></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a>yearly <span class="op">=</span> da.groupby(<span class="st">'time.year'</span>).mean(dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb82-2"><a href="#cb82-2" tabindex="-1"></a>yearly</span></code></pre></div>
</div>
<div class="section level2" id="exercise-4">
<h2>Exercise</h2>
<p>Can you find out when did the highest temperature anomaly occured at
a specific location?</p>
<p>Replace the <code>lat</code> and <code>lon</code> in the following
code with your chosen location. You will see the resulting
<code>max_anomaly</code> DataArray with the anomaly value along with
lat, lon and time coordinates. Extract the <code>time</code> coordinate
of the resulting array and print the time when the maximum anomaly
occured.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a>selected <span class="op">=</span> da.sel(lat<span class="op">=</span><span class="fl">28.6</span>, lon<span class="op">=</span><span class="fl">77.2</span>, method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a>max_anomaly <span class="op">=</span> selected.where(selected<span class="op">==</span>selected.<span class="bu">max</span>(), drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb83-3"><a href="#cb83-3" tabindex="-1"></a>max_anomaly</span></code></pre></div>
<hr/>
</div>
</div>
<div class="section level1" id="mapping-gridded-datasets">
<h1>Mapping Gridded Datasets</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/06_mapping_gridded_datasets.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level2" id="overview-4">
<h2>Overview</h2>
<p>In this section, we will take the <a href="https://data.giss.nasa.gov/gistemp/">Gridded Monthly Temperature
Anomaly Data</a> from 1880-present from GISTEMP and visualize the
temperature anomaly for the year 2021.</p>
</div>
<div class="section level2" id="setup-and-data-download-4">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a>  <span class="op">!</span>apt<span class="op">-</span>get <span class="op">-</span>qq remove python<span class="op">-</span>shapely python3<span class="op">-</span>shapely</span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a>  <span class="op">!</span>pip install <span class="op">--</span>no<span class="op">-</span>binary shapely shapely <span class="op">--</span>force</span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a>  <span class="op">!</span>pip install <span class="op">--</span>no<span class="op">-</span>binary cartopy cartopy<span class="op">==</span><span class="fl">0.19.0</span>.post1</span></code></pre></div>
<div class="sourceCode" id="cb85"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a><span class="im">import</span> cartopy</span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs </span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb85-4"><a href="#cb85-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb85-5"><a href="#cb85-5" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code></pre></div>
<div class="sourceCode" id="cb86"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb86-3"><a href="#cb86-3" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb86-5"><a href="#cb86-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb86-6"><a href="#cb86-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb86-7"><a href="#cb86-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb87"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb87-3"><a href="#cb87-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb87-4"><a href="#cb87-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb87-5"><a href="#cb87-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb87-6"><a href="#cb87-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb87-7"><a href="#cb87-7" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gistemp1200_GHCNv4_ERSSTv5.nc'</span></span>
<span id="cb87-9"><a href="#cb87-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/gistemp/'</span></span>
<span id="cb87-10"><a href="#cb87-10" tabindex="-1"></a></span>
<span id="cb87-11"><a href="#cb87-11" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div class="section level2" id="data-pre-processing-3">
<h2>Data Pre-Processing</h2>
<p>We read the data using <code>XArray</code>, select the
<code>tempanomaly</code> variable and aggregate it to yearly
anoamalies.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a>file_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(file_path)</span>
<span id="cb88-3"><a href="#cb88-3" tabindex="-1"></a>da <span class="op">=</span> ds.tempanomaly</span></code></pre></div>
<div class="sourceCode" id="cb89"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a>yearly <span class="op">=</span> da.groupby(<span class="st">'time.year'</span>).mean(dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a>yearly</span></code></pre></div>
</div>
<div class="section level2" id="plotting-using-matplotlib">
<h2>Plotting using Matplotlib</h2>
<p>XArray provides a <code>plot()</code> method based on Matplotlib.
When you call <code>plot()</code> on a 2D DataArray, it uses the
<code>xarray.plot.pcolormesh()</code> function that creates a
Pseudocolor plot.</p>
<p>Reference: <a href="https://docs.xarray.dev/en/stable/user-guide/plotting.html#two-dimensions">xarray.plot</a></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" tabindex="-1"></a>anomaly2021 <span class="op">=</span> yearly.sel(year<span class="op">=</span><span class="dv">2021</span>)</span>
<span id="cb90-2"><a href="#cb90-2" tabindex="-1"></a>anomaly2021</span></code></pre></div>
<div class="sourceCode" id="cb91"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb91-3"><a href="#cb91-3" tabindex="-1"></a>anomaly2021.plot(ax<span class="op">=</span>ax)</span>
<span id="cb91-4"><a href="#cb91-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>While the <code>plot()</code> method works, it is slower than the
<code>plot.imshow()</code> method when rendering large 2D-arrays. So we
would prefer using it instead of the `plot() method.</p>
<p>Reference : <a href="https://docs.xarray.dev/en/stable/generated/xarray.plot.imshow.html">xarray.plot.imshow</a></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb92-2"><a href="#cb92-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb92-3"><a href="#cb92-3" tabindex="-1"></a>anomaly2021.plot.imshow(ax<span class="op">=</span>ax)</span>
<span id="cb92-4"><a href="#cb92-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can customize the plot using Matplotlib’s options.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" tabindex="-1"></a>anomaly2021.plot.imshow(ax<span class="op">=</span>ax,</span>
<span id="cb93-5"><a href="#cb93-5" tabindex="-1"></a>    vmin<span class="op">=-</span><span class="dv">3</span>, vmax<span class="op">=</span><span class="dv">3</span>, add_labels<span class="op">=</span><span class="va">False</span>, cmap<span class="op">=</span><span class="st">'coolwarm'</span>)</span>
<span id="cb93-6"><a href="#cb93-6" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" tabindex="-1"></a>ax.set_title(<span class="st">'Temperature Anomaly in 2021 (°C)'</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb93-8"><a href="#cb93-8" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div class="section level2" id="plotting-using-cartopy">
<h2>Plotting using CartoPy</h2>
<p>To create more informative map visualization, we need to reproject
this grid to another projection. CartoPy supports a wide range of
projections and can plot them using matplotlib. CartoPy creates a
GeoAxes object and replaces the default Axes with it. This allows you to
plot the data on a specified projection.</p>
<p>We start as usual by create a subplot but specify an additional
argument to set the CRS from CartoPy.</p>
<p>Reference: <a href="https://scitools.org.uk/cartopy/docs/latest/reference/crs.html?highlight=list#list-of-projections">CartoPy
List of Projections</a></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, subplot_kw<span class="op">=</span>{<span class="st">'projection'</span>: ccrs.Orthographic(<span class="dv">0</span>, <span class="dv">30</span>)})</span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb94-3"><a href="#cb94-3" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" tabindex="-1"></a>anomaly2021.plot.imshow(ax<span class="op">=</span>ax,</span>
<span id="cb94-5"><a href="#cb94-5" tabindex="-1"></a>    vmin<span class="op">=-</span><span class="dv">3</span>, vmax<span class="op">=</span><span class="dv">3</span>, cmap<span class="op">=</span><span class="st">'coolwarm'</span>,</span>
<span id="cb94-6"><a href="#cb94-6" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree())</span>
<span id="cb94-7"><a href="#cb94-7" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb94-9"><a href="#cb94-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can further customize the map by adjusting the colorbar.</p>
<p>Reference: <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.colorbar.html">matplotlib.pyplot.colorbar</a></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a>cbar_kwargs <span class="op">=</span> {</span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a>    <span class="st">'orientation'</span>:<span class="st">'horizontal'</span>,</span>
<span id="cb95-3"><a href="#cb95-3" tabindex="-1"></a>    <span class="st">'fraction'</span>: <span class="fl">0.025</span>,</span>
<span id="cb95-4"><a href="#cb95-4" tabindex="-1"></a>    <span class="st">'pad'</span>: <span class="fl">0.05</span>,</span>
<span id="cb95-5"><a href="#cb95-5" tabindex="-1"></a>    <span class="st">'extend'</span>:<span class="st">'neither'</span></span>
<span id="cb95-6"><a href="#cb95-6" tabindex="-1"></a>}</span>
<span id="cb95-7"><a href="#cb95-7" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, subplot_kw<span class="op">=</span>{<span class="st">'projection'</span>: ccrs.Orthographic(<span class="dv">0</span>, <span class="dv">30</span>)})</span>
<span id="cb95-9"><a href="#cb95-9" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb95-10"><a href="#cb95-10" tabindex="-1"></a>anomaly2021.plot.imshow(</span>
<span id="cb95-11"><a href="#cb95-11" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb95-12"><a href="#cb95-12" tabindex="-1"></a>    vmin<span class="op">=-</span><span class="dv">3</span>, vmax<span class="op">=</span><span class="dv">3</span>, cmap<span class="op">=</span><span class="st">'coolwarm'</span>,</span>
<span id="cb95-13"><a href="#cb95-13" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb95-14"><a href="#cb95-14" tabindex="-1"></a>    add_labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb95-15"><a href="#cb95-15" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>cbar_kwargs)</span>
<span id="cb95-16"><a href="#cb95-16" tabindex="-1"></a></span>
<span id="cb95-17"><a href="#cb95-17" tabindex="-1"></a>ax.coastlines()</span>
<span id="cb95-18"><a href="#cb95-18" tabindex="-1"></a>plt.title(<span class="st">'Temperature Anomaly in 2021 (°C)'</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb95-19"><a href="#cb95-19" tabindex="-1"></a></span>
<span id="cb95-20"><a href="#cb95-20" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb95-21"><a href="#cb95-21" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'anomaly.jpg'</span>)</span>
<span id="cb95-22"><a href="#cb95-22" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb95-23"><a href="#cb95-23" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/06_mapping_gridded_datasets_files/06_mapping_gridded_datasets_20_0.png"/></p>
</div>
<div class="section level2" id="exercise-5">
<h2>Exercise</h2>
<p>Display the map in the Robinson projection.</p>
<hr/>
</div>
</div>
<div class="section level1" id="visualizing-rasters">
<h1>Visualizing Rasters</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/07_visualizing_rasters.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level2" id="overview-5">
<h2>Overview</h2>
<p>In the previous notebook, we learnt how to use <a href="http://xarray.pydata.org/">Xarray</a> to work with gridded
datasets. XArray is also well suited to work with georeferenced rasters
- such as satellite imagery, population grids, or elevation data.<a href="https://corteva.github.io/rioxarray/stable/index.html">rioxarray</a>
is an extension of xarray that makes it easy to work with geospatial
rasters. You can install the <code>rioxarray</code> package from the
<code>conda-forge</code> channel.</p>
<p>In this section, we will take 4 individual SRTM tiles around the Mt.
Everest region and merge them to a single GeoTiff using RasterIO. We
will also use <code>matplotlib</code> to visualize the result with some
annonations.</p>
</div>
<div class="section level2" id="setup-and-data-download-5">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb96-2"><a href="#cb96-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb96-3"><a href="#cb96-3" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">--</span>quiet rioxarray</span></code></pre></div>
<p>By convention, <code>rioxarray</code> is imported as
<code>rxr</code>.</p>
<blockquote>
<p>Remember to always import <code>rioxarray</code> even if you are
using sub-modules such as <code>merge_arrays</code>. Importing
<code>rioxarray</code> activates the <code>rio</code> accessor which is
required for all operations.</p>
</blockquote>
<div class="sourceCode" id="cb97"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb97-3"><a href="#cb97-3" tabindex="-1"></a><span class="im">from</span> rioxarray.merge <span class="im">import</span> merge_arrays</span>
<span id="cb97-4"><a href="#cb97-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb98-2"><a href="#cb98-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb98-3"><a href="#cb98-3" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb98-5"><a href="#cb98-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb98-6"><a href="#cb98-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb98-7"><a href="#cb98-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb99"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb99-3"><a href="#cb99-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb99-4"><a href="#cb99-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb99-5"><a href="#cb99-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb99-6"><a href="#cb99-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb99-7"><a href="#cb99-7" tabindex="-1"></a></span>
<span id="cb99-8"><a href="#cb99-8" tabindex="-1"></a>srtm_tiles <span class="op">=</span> [</span>
<span id="cb99-9"><a href="#cb99-9" tabindex="-1"></a>  <span class="st">'N27E086.hgt'</span>,</span>
<span id="cb99-10"><a href="#cb99-10" tabindex="-1"></a>  <span class="st">'N27E087.hgt'</span>,</span>
<span id="cb99-11"><a href="#cb99-11" tabindex="-1"></a>  <span class="st">'N28E086.hgt'</span>,</span>
<span id="cb99-12"><a href="#cb99-12" tabindex="-1"></a>  <span class="st">'N28E087.hgt'</span></span>
<span id="cb99-13"><a href="#cb99-13" tabindex="-1"></a>]</span>
<span id="cb99-14"><a href="#cb99-14" tabindex="-1"></a></span>
<span id="cb99-15"><a href="#cb99-15" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/srtm/'</span></span>
<span id="cb99-16"><a href="#cb99-16" tabindex="-1"></a></span>
<span id="cb99-17"><a href="#cb99-17" tabindex="-1"></a><span class="cf">for</span> tile <span class="kw">in</span> srtm_tiles:</span>
<span id="cb99-18"><a href="#cb99-18" tabindex="-1"></a>  url <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(data_url, tile)</span>
<span id="cb99-19"><a href="#cb99-19" tabindex="-1"></a>  download(url)</span></code></pre></div>
</div>
<div class="section level2" id="rioxarray-basics">
<h2>Rioxarray Basics</h2>
<p>The <code>open_rasterio()</code> method from <code>rioxarray</code>
is able to read any data source supported by. the <a href="https://rasterio.readthedocs.io/en/latest/"><code>rasterio</code></a>
library. Let’s open a single SRTM tile using <code>rioxarray</code>.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'N28E087.hgt'</span></span>
<span id="cb100-2"><a href="#cb100-2" tabindex="-1"></a>file_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb100-3"><a href="#cb100-3" tabindex="-1"></a>rds <span class="op">=</span> rxr.open_rasterio(file_path)</span></code></pre></div>
<p>The result is a <code>xarray.DataArray</code> object.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" tabindex="-1"></a>rds</span></code></pre></div>
<p>You can access the pixel values using the <code>values</code>
property which returns the array’s data as a numpy array.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" tabindex="-1"></a>rds.values</span></code></pre></div>
<p>A <code>xarray.DataArray</code> object also contains 1 or more
<code>coordinates</code>. Each coordinate is a 1-dimensional array
representing values along one of the data axes. In case of the 1-band
SRTM elevation data, we have 3 coordinates - <code>x</code>,
<code>y</code> and <code>band</code>.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a>rds.coords</span></code></pre></div>
<p>The raster metadata is stored in the <a href="https://corteva.github.io/rioxarray/stable/rioxarray.html#rioxarray-rio-accessors"><code>rio</code></a>
accessor. This is enabled by the <code>rioxarray</code> library which
provides geospatial functions on top of <code>xarray</code>.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'CRS:'</span>, rds.rio.crs)</span>
<span id="cb104-2"><a href="#cb104-2" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Resolution:'</span>, rds.rio.resolution())</span>
<span id="cb104-3"><a href="#cb104-3" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Bounds:'</span>, rds.rio.bounds())</span>
<span id="cb104-4"><a href="#cb104-4" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Width:'</span>, rds.rio.width)</span>
<span id="cb104-5"><a href="#cb104-5" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Height:'</span>, rds.rio.height)</span></code></pre></div>
<div class="sourceCode" id="cb105"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a>band1 <span class="op">=</span> rds.sel(band<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb105-2"><a href="#cb105-2" tabindex="-1"></a>band1</span></code></pre></div>
</div>
<div class="section level2" id="plotting-multiple-rasters">
<h2>Plotting Multiple Rasters</h2>
<p>Open each source file using <code>open_rasterio()</code> method and
store the resulting datasets in a list.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" tabindex="-1"></a>datasets <span class="op">=</span> []</span>
<span id="cb106-2"><a href="#cb106-2" tabindex="-1"></a><span class="cf">for</span> tile <span class="kw">in</span> srtm_tiles:</span>
<span id="cb106-3"><a href="#cb106-3" tabindex="-1"></a>    path <span class="op">=</span> os.path.join(data_folder, tile)</span>
<span id="cb106-4"><a href="#cb106-4" tabindex="-1"></a>    rds <span class="op">=</span> rxr.open_rasterio(path)</span>
<span id="cb106-5"><a href="#cb106-5" tabindex="-1"></a>    band <span class="op">=</span> rds.sel(band<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb106-6"><a href="#cb106-6" tabindex="-1"></a>    datasets.append(band)</span></code></pre></div>
<p>You can visualize any <code>DataArray</code> object by calling
<code>plot()</code> method. Here we create a subplot with 1 row and 4
columns. The <code>subplots()</code> method will return a list of Axes
that we can use to render each of the source SRTM rasters. For plots
with multiple columns, the Axes will be a nested list. To easily iterate
over it, we can use <code>.flat</code> which returns a 1D iterator on
the axes.</p>
<p>While plotting the data, we can use the <code>cmap</code> option to
specify a color ramp. Here we are using the built-in <em>Greys</em>
ramp. Appending **_r** gives us the inverted ramp with blacks
representing lower elevation values.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb107-2"><a href="#cb107-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">3</span>)</span>
<span id="cb107-3"><a href="#cb107-3" tabindex="-1"></a><span class="cf">for</span> index, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb107-4"><a href="#cb107-4" tabindex="-1"></a>    da <span class="op">=</span> datasets[index]</span>
<span id="cb107-5"><a href="#cb107-5" tabindex="-1"></a>    im <span class="op">=</span> da.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'Greys_r'</span>)</span>
<span id="cb107-6"><a href="#cb107-6" tabindex="-1"></a>    filename <span class="op">=</span> srtm_tiles[index]</span>
<span id="cb107-7"><a href="#cb107-7" tabindex="-1"></a>    ax.set_title(filename)</span>
<span id="cb107-8"><a href="#cb107-8" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb107-10"><a href="#cb107-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/07_visualizing_rasters_files/07_visualizing_rasters_23_0.png"/></p>
</div>
<div class="section level2" id="merging-rasters">
<h2>Merging Rasters</h2>
<p>Now that you understand the basic data structure of <em>xarray</em>
and the &amp;rio* extension, let’s use it to process some data. We will
take 4 individual SRTM tiles and merge them to a single GeoTiff. You
will note that <code>rioxarray</code> handles the CRS and transform much
better - taking care of internal details and providing a simple API.</p>
<p>We will use the <code>merge_arrays()</code> method from the
<code>rioxarray.merge</code> module to merge the rasters. We can also
specify an optional <code>method</code> that controls how overlapping
tiles are merged. Here we have chosen <code>first</code> which takes the
value of the first raster in the overlapping region.</p>
<p>Reference: <a href="https://corteva.github.io/rioxarray/html/rioxarray.html#rioxarray.merge.merge_arrays"><code>merge_arrays()</code></a></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" tabindex="-1"></a>merged <span class="op">=</span> merge_arrays(datasets, method<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb108-2"><a href="#cb108-2" tabindex="-1"></a>merged</span></code></pre></div>
<p>We can now visualize the merged raster.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb109-2"><a href="#cb109-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>, <span class="dv">10</span>)</span>
<span id="cb109-3"><a href="#cb109-3" tabindex="-1"></a>merged.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'Greys_r'</span>)</span>
<span id="cb109-4"><a href="#cb109-4" tabindex="-1"></a>ax.set_title(<span class="st">'merged'</span>)</span>
<span id="cb109-5"><a href="#cb109-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div class="section level2" id="annotating-plots">
<h2>Annotating Plots</h2>
<p>Sometime it is helpful to add annotations on your plot to highlight a
feature or add a text label. In this section we will learn how to use
the annotate the DEM to show the location and elevation of Mt.
Everest.</p>
<p>First, we locate the coordinates of the maximum elevation in the
<code>merged</code> DataArray using the <code>max()</code> function. We
can then use <code>where()</code> function to filter the elements where
the value equals the maximum elevation. Lastly, we run
<code>squeeze()</code> to remove the extra empty dimension from the
result.</p>
<p>References:</p>
<ul>
<li><a href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.max.html">xarray.DataArray.max</a></li>
<li><a href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.where.html">xarray.DataArray.where</a></li>
</ul>
<div class="sourceCode" id="cb110"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" tabindex="-1"></a>max_da <span class="op">=</span> merged.where(merged<span class="op">==</span>merged.<span class="bu">max</span>(), drop<span class="op">=</span><span class="va">True</span>).squeeze()</span>
<span id="cb110-2"><a href="#cb110-2" tabindex="-1"></a>max_da</span></code></pre></div>
<p>We now extract the x,y coordinates and the value of the maximum
elevation.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" tabindex="-1"></a>max_x <span class="op">=</span> max_da.x.values</span>
<span id="cb111-2"><a href="#cb111-2" tabindex="-1"></a>max_y <span class="op">=</span> max_da.y.values</span>
<span id="cb111-3"><a href="#cb111-3" tabindex="-1"></a>max_elev <span class="op">=</span> <span class="bu">int</span>(max_da.values)</span>
<span id="cb111-4"><a href="#cb111-4" tabindex="-1"></a><span class="bu">print</span>(max_x, max_y, max_elev)</span></code></pre></div>
<p>Now we plot the <code>merged</code> raster and annotate it using the
<code>annotate()</code> function.</p>
<p>Reference: <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.annotate.html">matplotlib.pyplot.annotate</a></p>
<div class="sourceCode" id="cb112"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb112-2"><a href="#cb112-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>, <span class="dv">10</span>)</span>
<span id="cb112-3"><a href="#cb112-3" tabindex="-1"></a>merged.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'viridis'</span>, add_labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb112-4"><a href="#cb112-4" tabindex="-1"></a>ax.plot(max_x, max_y, <span class="st">'^r'</span>, markersize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb112-5"><a href="#cb112-5" tabindex="-1"></a>ax.annotate(<span class="st">'Mt. Everest (elevation:</span><span class="sc">{}</span><span class="st">m)'</span>.<span class="bu">format</span>(max_elev),</span>
<span id="cb112-6"><a href="#cb112-6" tabindex="-1"></a>            xy<span class="op">=</span>(max_x, max_y), xycoords<span class="op">=</span><span class="st">'data'</span>,</span>
<span id="cb112-7"><a href="#cb112-7" tabindex="-1"></a>            xytext<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">20</span>), textcoords<span class="op">=</span><span class="st">'offset points'</span>,</span>
<span id="cb112-8"><a href="#cb112-8" tabindex="-1"></a>            arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb112-9"><a href="#cb112-9" tabindex="-1"></a>            )</span>
<span id="cb112-10"><a href="#cb112-10" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb112-11"><a href="#cb112-11" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/07_visualizing_rasters_files/07_visualizing_rasters_36_0.png"/></p>
<p>Finally, save the merged array to disk as a GeoTiff file.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" tabindex="-1"></a>output_filename <span class="op">=</span> <span class="st">'merged.tif'</span></span>
<span id="cb113-2"><a href="#cb113-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_filename)</span>
<span id="cb113-3"><a href="#cb113-3" tabindex="-1"></a>merged.rio.to_raster(output_path)</span></code></pre></div>
</div>
<div class="section level2" id="exercise-6">
<h2>Exercise</h2>
<p>Add contours to the elevation plot below. You can use the <a href="https://docs.xarray.dev/en/stable/generated/xarray.plot.contour.html"><code>xarray.plot.contour</code></a>
function to create the contour plot.</p>
<p>Hint: Use the options <code>colors=black</code> and
<code>levels=10</code>.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb114-2"><a href="#cb114-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>, <span class="dv">10</span>)</span>
<span id="cb114-3"><a href="#cb114-3" tabindex="-1"></a>merged.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'viridis'</span>, add_labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb114-4"><a href="#cb114-4" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb114-5"><a href="#cb114-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<hr/>
</div>
</div>
<div class="section level1" id="interactive-maps-with-folium">
<h1>Interactive Maps with Folium</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/08_interactive_maps_folium.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level2" id="overview-6">
<h2>Overview</h2>
<p><a href="https://python-visualization.github.io/folium/">Folium</a>
is a Python library that allows you to create interactive maps based on
the popular <a href="https://leafletjs.com/">Leaflet</a> javascript
library.</p>
<p>In this section, we will learn how to create an interactive map
showing driving directions between two locations.</p>
</div>
<div class="section level2" id="setup-1">
<h2>Setup</h2>
<div class="sourceCode" id="cb115"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb115-2"><a href="#cb115-2" tabindex="-1"></a><span class="im">import</span> folium</span></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb116-2"><a href="#cb116-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb116-3"><a href="#cb116-3" tabindex="-1"></a></span>
<span id="cb116-4"><a href="#cb116-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb116-5"><a href="#cb116-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb116-6"><a href="#cb116-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb116-7"><a href="#cb116-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<p>We will be using <a href="https://openrouteservice.org/">OpenRouteService API</a> to
calculate the directions. Please sign-up for a free account and create
an API key. If you already have an account, the API key is obtained from
the <a href="https://openrouteservice.org/dev/#/home">OpenRouteService
Dashboard</a>. Enter your API key below.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">''</span></span></code></pre></div>
</div>
<div class="section level2" id="folium-basics">
<h2>Folium Basics</h2>
<p>We will learn the basics of folium by creating an interactive map
showing the driving directions between two chosen locations. Let’s start
by defining the coordinates of two cities.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb118-2"><a href="#cb118-2" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span></code></pre></div>
<p>To create a map, we initialize the <code>folium.Map()</code> class
which creates a map object with the default basemap. To display the map
a Jupyter notebook, we can simply enter the name of the map object.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" tabindex="-1"></a>m <span class="op">=</span> folium.Map()</span>
<span id="cb119-2"><a href="#cb119-2" tabindex="-1"></a>m</span></code></pre></div>
<p>The default map spans the full width of the Jupyter notebook - making
it difficult to navigate. The <code>Map()</code> constructor supports
<code>width</code> and <code>height</code> parameters that control the
size of the leaflet map, but you still end up with a lot of extra empty
space below the map. The preferred way to get a map of exact size is to
create a <em>Figure</em> first and add the map object to it.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb120-2"><a href="#cb120-2" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb120-3"><a href="#cb120-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">39.83</span>, <span class="op">-</span><span class="fl">98.58</span>], zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb120-4"><a href="#cb120-4" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>The map object <code>m</code> can be manipulated by adding different
elements to it. Contrary to how Matplotlib objects work, the map object
does not get emptied when displayed. So you are able to visualize and
incrementally add elements to it. Let’s add some markers to the map
using <a href="https://python-visualization.github.io/folium/modules.html#folium.map.Marker"><code>folium.map.Marker</code></a>
class.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" tabindex="-1"></a>folium.Marker(san_francisco, popup<span class="op">=</span><span class="st">'San Francisco'</span>).add_to(m)</span>
<span id="cb121-2"><a href="#cb121-2" tabindex="-1"></a>folium.Marker(new_york, popup<span class="op">=</span><span class="st">'New York'</span>).add_to(m)</span>
<span id="cb121-3"><a href="#cb121-3" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" tabindex="-1"></a>m</span></code></pre></div>
<p>The markers can be customized to have a different color or icons. You
can check the <a href="https://python-visualization.github.io/folium/modules.html#folium.map.Icon"><code>folium.map.Icon</code></a>
class for options for creating icons. This class supports a vast range
of icons from the <a href="https://fontawesome.com/search?m=free&amp;c=maps">fontawesome
icons</a> and <a href="https://getbootstrap.com/docs/3.3/components/">bootstrap icons</a>
libraries. You can choose the name of the icon from there to use it in
your Folium map. The <code>prefix</code> parameter can be <em>fa</em>
for FontAwesome icons or <em>glyphicon</em> for Bootstrap3.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb122-2"><a href="#cb122-2" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb122-3"><a href="#cb122-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">39.83</span>, <span class="op">-</span><span class="fl">98.58</span>], zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb122-4"><a href="#cb122-4" tabindex="-1"></a>folium.Marker(san_francisco, popup<span class="op">=</span><span class="st">'San Francisco'</span>,</span>
<span id="cb122-5"><a href="#cb122-5" tabindex="-1"></a>              icon<span class="op">=</span>folium.Icon(</span>
<span id="cb122-6"><a href="#cb122-6" tabindex="-1"></a>                  color<span class="op">=</span><span class="st">'green'</span>, icon<span class="op">=</span><span class="st">'crosshairs'</span>, prefix<span class="op">=</span><span class="st">'fa'</span>)</span>
<span id="cb122-7"><a href="#cb122-7" tabindex="-1"></a>             ).add_to(m)</span>
<span id="cb122-8"><a href="#cb122-8" tabindex="-1"></a>folium.Marker(new_york, popup<span class="op">=</span><span class="st">'New York'</span>, </span>
<span id="cb122-9"><a href="#cb122-9" tabindex="-1"></a>              icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">'red'</span>, icon<span class="op">=</span><span class="st">'crosshairs'</span>, prefix<span class="op">=</span><span class="st">'fa'</span>)</span>
<span id="cb122-10"><a href="#cb122-10" tabindex="-1"></a>             ).add_to(m)</span>
<span id="cb122-11"><a href="#cb122-11" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<div class="sourceCode" id="cb123"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb123-2"><a href="#cb123-2" tabindex="-1"></a></span>
<span id="cb123-3"><a href="#cb123-3" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb123-4"><a href="#cb123-4" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb123-5"><a href="#cb123-5" tabindex="-1"></a></span>
<span id="cb123-6"><a href="#cb123-6" tabindex="-1"></a>parameters <span class="op">=</span> {</span>
<span id="cb123-7"><a href="#cb123-7" tabindex="-1"></a>    <span class="st">'api_key'</span>: ORS_API_KEY,</span>
<span id="cb123-8"><a href="#cb123-8" tabindex="-1"></a>    <span class="st">'start'</span> : <span class="st">'</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(san_francisco[<span class="dv">1</span>], san_francisco[<span class="dv">0</span>]),</span>
<span id="cb123-9"><a href="#cb123-9" tabindex="-1"></a>    <span class="st">'end'</span> : <span class="st">'</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(new_york[<span class="dv">1</span>], new_york[<span class="dv">0</span>])</span>
<span id="cb123-10"><a href="#cb123-10" tabindex="-1"></a>}</span>
<span id="cb123-11"><a href="#cb123-11" tabindex="-1"></a></span>
<span id="cb123-12"><a href="#cb123-12" tabindex="-1"></a>response <span class="op">=</span> requests.get(</span>
<span id="cb123-13"><a href="#cb123-13" tabindex="-1"></a>    <span class="st">'https://api.openrouteservice.org/v2/directions/driving-car'</span>, params<span class="op">=</span>parameters)</span>
<span id="cb123-14"><a href="#cb123-14" tabindex="-1"></a></span>
<span id="cb123-15"><a href="#cb123-15" tabindex="-1"></a><span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb123-16"><a href="#cb123-16" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Request successful.'</span>)</span>
<span id="cb123-17"><a href="#cb123-17" tabindex="-1"></a>    data <span class="op">=</span> response.json()</span>
<span id="cb123-18"><a href="#cb123-18" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb123-19"><a href="#cb123-19" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Request failed.'</span>)</span></code></pre></div>
<p>Extract the coordinates for the driving directions.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" tabindex="-1"></a>route<span class="op">=</span> data[<span class="st">'features'</span>][<span class="dv">0</span>][<span class="st">'geometry'</span>][<span class="st">'coordinates'</span>]</span></code></pre></div>
<div class="sourceCode" id="cb125"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" tabindex="-1"></a>route[:<span class="dv">5</span>]</span></code></pre></div>
<p>The coordinates returned by OpenRouteService API is in the order
[X,Y] (i.e. [Longitude, Latitude]) whereas Folium requires the
coordinates in [Y,X] (i.e. [Latitude, Longitude]) order. We can swap
them before plotting.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" tabindex="-1"></a>route_xy <span class="op">=</span> []</span>
<span id="cb126-2"><a href="#cb126-2" tabindex="-1"></a><span class="cf">for</span> x, y <span class="kw">in</span> route:</span>
<span id="cb126-3"><a href="#cb126-3" tabindex="-1"></a>    route_xy.append((y,x))</span>
<span id="cb126-4"><a href="#cb126-4" tabindex="-1"></a>route_xy[:<span class="dv">5</span>]</span></code></pre></div>
<p>An easier way to accomplish the same is by using a Python <a href="https://www.w3schools.com/python/python_lists_comprehension.asp">List
Comprehension</a>.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" tabindex="-1"></a>route_xy <span class="op">=</span> [(y, x) <span class="cf">for</span> x, y <span class="kw">in</span> route]</span>
<span id="cb127-2"><a href="#cb127-2" tabindex="-1"></a>route_xy[:<span class="dv">5</span>]</span></code></pre></div>
<p>We extract the route summary returned by the API which contains the
total driving distance in meters.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" tabindex="-1"></a>summary <span class="op">=</span> data[<span class="st">'features'</span>][<span class="dv">0</span>][<span class="st">'properties'</span>][<span class="st">'summary'</span>]</span>
<span id="cb128-2"><a href="#cb128-2" tabindex="-1"></a>distance <span class="op">=</span> <span class="bu">round</span>(summary[<span class="st">'distance'</span>]<span class="op">/</span><span class="dv">1000</span>)</span>
<span id="cb128-3"><a href="#cb128-3" tabindex="-1"></a>tooltip <span class="op">=</span> <span class="st">'Driving Distance: </span><span class="sc">{}</span><span class="st">km'</span>.<span class="bu">format</span>(distance)</span></code></pre></div>
<p>We can use the <a href="https://python-visualization.github.io/folium/modules.html#folium.vector_layers.PolyLine"><code>folium.vector_layers.Polyline</code></a>
class to add a line to the map. The class has a
<code>smooth_factor</code> parameter which can be used to simplify the
line displayed when zoomed-out. Setting a higher number results in
better performance.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" tabindex="-1"></a>folium.PolyLine(route_xy, tooltip<span class="op">=</span>tooltip, smooth_factor<span class="op">=</span><span class="dv">1</span>).add_to(m)</span>
<span id="cb129-2"><a href="#cb129-2" tabindex="-1"></a>m</span></code></pre></div>
<p>Folium maps can be saved to a HTML file by calling
<code>save()</code> on the map object.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb130-2"><a href="#cb130-2" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb130-3"><a href="#cb130-3" tabindex="-1"></a>    os.mkdir(output_folder)</span>
<span id="cb130-4"><a href="#cb130-4" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'directions.html'</span>)</span>
<span id="cb130-5"><a href="#cb130-5" tabindex="-1"></a>m.save(output_path)</span></code></pre></div>
</div>
<div class="section level2" id="exercise-7">
<h2>Exercise</h2>
<p>Below is the complete code to create an interactive map with the
driving directions between two cities. Replace the origin and
destination with your chosen cities and create an interactive map.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb131-2"><a href="#cb131-2" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb131-3"><a href="#cb131-3" tabindex="-1"></a></span>
<span id="cb131-4"><a href="#cb131-4" tabindex="-1"></a><span class="co">###############################</span></span>
<span id="cb131-5"><a href="#cb131-5" tabindex="-1"></a><span class="co">###  Replace Variables Below </span></span>
<span id="cb131-6"><a href="#cb131-6" tabindex="-1"></a><span class="co">###############################</span></span>
<span id="cb131-7"><a href="#cb131-7" tabindex="-1"></a>origin <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb131-8"><a href="#cb131-8" tabindex="-1"></a>origin_name <span class="op">=</span> <span class="st">'San Francisco'</span></span>
<span id="cb131-9"><a href="#cb131-9" tabindex="-1"></a>destination <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb131-10"><a href="#cb131-10" tabindex="-1"></a>destination_name <span class="op">=</span> <span class="st">'New York'</span></span>
<span id="cb131-11"><a href="#cb131-11" tabindex="-1"></a>map_center <span class="op">=</span> (<span class="fl">39.83</span>, <span class="op">-</span><span class="fl">98.58</span>)</span>
<span id="cb131-12"><a href="#cb131-12" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">''</span></span>
<span id="cb131-13"><a href="#cb131-13" tabindex="-1"></a><span class="co">###############################</span></span>
<span id="cb131-14"><a href="#cb131-14" tabindex="-1"></a>parameters <span class="op">=</span> {</span>
<span id="cb131-15"><a href="#cb131-15" tabindex="-1"></a>    <span class="st">'api_key'</span>: ORS_API_KEY,</span>
<span id="cb131-16"><a href="#cb131-16" tabindex="-1"></a>    <span class="st">'start'</span> : <span class="st">'</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(origin[<span class="dv">1</span>], origin[<span class="dv">0</span>]),</span>
<span id="cb131-17"><a href="#cb131-17" tabindex="-1"></a>    <span class="st">'end'</span> : <span class="st">'</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(destination[<span class="dv">1</span>], destination[<span class="dv">0</span>])</span>
<span id="cb131-18"><a href="#cb131-18" tabindex="-1"></a>}</span>
<span id="cb131-19"><a href="#cb131-19" tabindex="-1"></a></span>
<span id="cb131-20"><a href="#cb131-20" tabindex="-1"></a>response <span class="op">=</span> requests.get(</span>
<span id="cb131-21"><a href="#cb131-21" tabindex="-1"></a>    <span class="st">'https://api.openrouteservice.org/v2/directions/driving-car'</span>, params<span class="op">=</span>parameters)</span>
<span id="cb131-22"><a href="#cb131-22" tabindex="-1"></a></span>
<span id="cb131-23"><a href="#cb131-23" tabindex="-1"></a><span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb131-24"><a href="#cb131-24" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Request successful.'</span>)</span>
<span id="cb131-25"><a href="#cb131-25" tabindex="-1"></a>    data <span class="op">=</span> response.json()</span>
<span id="cb131-26"><a href="#cb131-26" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb131-27"><a href="#cb131-27" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Request failed.'</span>)</span>
<span id="cb131-28"><a href="#cb131-28" tabindex="-1"></a></span>
<span id="cb131-29"><a href="#cb131-29" tabindex="-1"></a>route<span class="op">=</span> data[<span class="st">'features'</span>][<span class="dv">0</span>][<span class="st">'geometry'</span>][<span class="st">'coordinates'</span>]</span>
<span id="cb131-30"><a href="#cb131-30" tabindex="-1"></a>summary <span class="op">=</span> data[<span class="st">'features'</span>][<span class="dv">0</span>][<span class="st">'properties'</span>][<span class="st">'summary'</span>]</span>
<span id="cb131-31"><a href="#cb131-31" tabindex="-1"></a></span>
<span id="cb131-32"><a href="#cb131-32" tabindex="-1"></a>route_xy <span class="op">=</span> [(y, x) <span class="cf">for</span> x, y <span class="kw">in</span> route]</span>
<span id="cb131-33"><a href="#cb131-33" tabindex="-1"></a>distance <span class="op">=</span> <span class="bu">round</span>(summary[<span class="st">'distance'</span>]<span class="op">/</span><span class="dv">1000</span>)</span>
<span id="cb131-34"><a href="#cb131-34" tabindex="-1"></a>tooltip <span class="op">=</span> <span class="st">'Driving Distance: </span><span class="sc">{}</span><span class="st">km'</span>.<span class="bu">format</span>(distance)</span>
<span id="cb131-35"><a href="#cb131-35" tabindex="-1"></a></span>
<span id="cb131-36"><a href="#cb131-36" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb131-37"><a href="#cb131-37" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb131-38"><a href="#cb131-38" tabindex="-1"></a></span>
<span id="cb131-39"><a href="#cb131-39" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>map_center, zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb131-40"><a href="#cb131-40" tabindex="-1"></a>folium.Marker(origin, popup<span class="op">=</span>origin_name,</span>
<span id="cb131-41"><a href="#cb131-41" tabindex="-1"></a>              icon<span class="op">=</span>folium.Icon(</span>
<span id="cb131-42"><a href="#cb131-42" tabindex="-1"></a>                  color<span class="op">=</span><span class="st">'green'</span>, icon<span class="op">=</span><span class="st">'crosshairs'</span>, prefix<span class="op">=</span><span class="st">'fa'</span>)</span>
<span id="cb131-43"><a href="#cb131-43" tabindex="-1"></a>             ).add_to(m)</span>
<span id="cb131-44"><a href="#cb131-44" tabindex="-1"></a>folium.Marker(destination, popup<span class="op">=</span>destination_name, </span>
<span id="cb131-45"><a href="#cb131-45" tabindex="-1"></a>              icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">'red'</span>, icon<span class="op">=</span><span class="st">'crosshairs'</span>, prefix<span class="op">=</span><span class="st">'fa'</span>)</span>
<span id="cb131-46"><a href="#cb131-46" tabindex="-1"></a>             ).add_to(m)</span>
<span id="cb131-47"><a href="#cb131-47" tabindex="-1"></a>folium.PolyLine(route_xy, tooltip<span class="op">=</span>tooltip).add_to(m)</span>
<span id="cb131-48"><a href="#cb131-48" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<hr/>
<hr/>
</div>
</div>
<div class="section level1" id="multi-layer-interactive-maps">
<h1>Multi-layer Interactive Maps</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/09_multilayer_maps.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<p>Open the notebook named <code>09_multilayer_maps.ipynb</code>.</p>
<hr/>
<div class="section level2" id="overview-7">
<h2>Overview</h2>
<p><a href="https://python-visualization.github.io/folium/">Folium</a>
supports creating maps with multiple layers. Recent versions of
GeoPandas have built-in support to create interactive folium maps from a
GeoDataFrame.</p>
<p>In this section, we will create a multi-layer interactive map using 2
vector datasets.</p>
</div>
<div class="section level2" id="setup-and-data-download-6">
<h2>Setup and Data Download</h2>
<div class="sourceCode" id="cb132"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb132-2"><a href="#cb132-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb132-3"><a href="#cb132-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb132-4"><a href="#cb132-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree mapclassify</span>
<span id="cb132-5"><a href="#cb132-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span></code></pre></div>
<div class="sourceCode" id="cb133"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb133-2"><a href="#cb133-2" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb133-3"><a href="#cb133-3" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb133-4"><a href="#cb133-4" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code></pre></div>
<div class="sourceCode" id="cb134"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb134-2"><a href="#cb134-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb134-3"><a href="#cb134-3" tabindex="-1"></a></span>
<span id="cb134-4"><a href="#cb134-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb134-5"><a href="#cb134-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb134-6"><a href="#cb134-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb134-7"><a href="#cb134-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb135"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb135-2"><a href="#cb135-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb135-3"><a href="#cb135-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb135-4"><a href="#cb135-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb135-5"><a href="#cb135-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb135-6"><a href="#cb135-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb135-7"><a href="#cb135-7" tabindex="-1"></a></span>
<span id="cb135-8"><a href="#cb135-8" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'karnataka.gpkg'</span></span>
<span id="cb135-9"><a href="#cb135-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/osm/'</span></span>
<span id="cb135-10"><a href="#cb135-10" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div class="section level2" id="using-geopandas-explore">
<h2>Using GeoPandas explore()</h2>
<div class="sourceCode" id="cb136"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" tabindex="-1"></a>data_pkg_path <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb136-2"><a href="#cb136-2" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'karnataka.gpkg'</span></span>
<span id="cb136-3"><a href="#cb136-3" tabindex="-1"></a>path <span class="op">=</span> os.path.join(data_pkg_path, filename)</span>
<span id="cb136-4"><a href="#cb136-4" tabindex="-1"></a>roads_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">'karnataka_highways'</span>)</span>
<span id="cb136-5"><a href="#cb136-5" tabindex="-1"></a>districts_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">'karnataka_districts'</span>)</span>
<span id="cb136-6"><a href="#cb136-6" tabindex="-1"></a>state_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">'karnataka'</span>)</span></code></pre></div>
<p>We can use the <a href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explore.html">explore()</a>
method to create an interactive folium map from the GeoDataFrame. When
you call <code>explore()</code> a folium object is created. You can save
that object and use it to display or add more layers to the map.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" tabindex="-1"></a>m <span class="op">=</span> districts_gdf.explore()</span>
<span id="cb137-2"><a href="#cb137-2" tabindex="-1"></a>m</span></code></pre></div>
<p>The default output of the <code>explore()</code> method is a
full-width folium map. If you need more control, a better approach is to
create a <code>follium.Figure</code> object and add the map to it. For
this approach we need to first compute the extent of the map.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" tabindex="-1"></a>bounds <span class="op">=</span> districts_gdf.total_bounds</span>
<span id="cb138-2"><a href="#cb138-2" tabindex="-1"></a>bounds</span></code></pre></div>
<p>Now we can create a figure of the required size, and add a folium map
to it. The <code>explore()</code> function takes a <code>m</code>
agrument where we can supply an existing folium map to which to render
the GeoDataFrame.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb139-2"><a href="#cb139-2" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map()</span>
<span id="cb139-4"><a href="#cb139-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb139-5"><a href="#cb139-5" tabindex="-1"></a></span>
<span id="cb139-6"><a href="#cb139-6" tabindex="-1"></a>districts_gdf.explore(m<span class="op">=</span>m)</span>
<span id="cb139-7"><a href="#cb139-7" tabindex="-1"></a></span>
<span id="cb139-8"><a href="#cb139-8" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>Folium supports a variety of basemaps. Let’s change the basemap to
use <em>Stamen Terrain</em> tiles. Additionally, we can change the
styling using the <code>color</code> and <code>style_kwds</code>
parameters.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb140-2"><a href="#cb140-2" tabindex="-1"></a></span>
<span id="cb140-3"><a href="#cb140-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">'Stamen Terrain'</span>)</span>
<span id="cb140-4"><a href="#cb140-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb140-5"><a href="#cb140-5" tabindex="-1"></a></span>
<span id="cb140-6"><a href="#cb140-6" tabindex="-1"></a>districts_gdf.explore(</span>
<span id="cb140-7"><a href="#cb140-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb140-8"><a href="#cb140-8" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'black'</span>, </span>
<span id="cb140-9"><a href="#cb140-9" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">'fillOpacity'</span>: <span class="fl">0.3</span>, <span class="st">'weight'</span>: <span class="fl">0.5</span>},</span>
<span id="cb140-10"><a href="#cb140-10" tabindex="-1"></a>  )</span>
<span id="cb140-11"><a href="#cb140-11" tabindex="-1"></a></span>
<span id="cb140-12"><a href="#cb140-12" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>Let’s add the <code>roads_gdf</code> layer to the map.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" tabindex="-1"></a>roads_gdf</span></code></pre></div>
<p>The GeoDataFrame contains roads of different categories as given in
the <code>ref</code> column. Let’s add a category column so we can use
it to apply different styles to each category of the road.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" tabindex="-1"></a><span class="kw">def</span> get_category(row):</span>
<span id="cb142-2"><a href="#cb142-2" tabindex="-1"></a>    ref <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">'ref'</span>])</span>
<span id="cb142-3"><a href="#cb142-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'NH'</span> <span class="kw">in</span> ref:</span>
<span id="cb142-4"><a href="#cb142-4" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'NH'</span></span>
<span id="cb142-5"><a href="#cb142-5" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'SH'</span> <span class="kw">in</span> ref:</span>
<span id="cb142-6"><a href="#cb142-6" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'SH'</span></span>
<span id="cb142-7"><a href="#cb142-7" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb142-8"><a href="#cb142-8" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'NA'</span></span>
<span id="cb142-9"><a href="#cb142-9" tabindex="-1"></a>    </span>
<span id="cb142-10"><a href="#cb142-10" tabindex="-1"></a>roads_gdf[<span class="st">'category'</span>] <span class="op">=</span> roads_gdf.<span class="bu">apply</span>(get_category, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb142-11"><a href="#cb142-11" tabindex="-1"></a>roads_gdf</span></code></pre></div>
<div class="sourceCode" id="cb143"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb143-2"><a href="#cb143-2" tabindex="-1"></a></span>
<span id="cb143-3"><a href="#cb143-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map()</span>
<span id="cb143-4"><a href="#cb143-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb143-5"><a href="#cb143-5" tabindex="-1"></a></span>
<span id="cb143-6"><a href="#cb143-6" tabindex="-1"></a>roads_gdf.explore(</span>
<span id="cb143-7"><a href="#cb143-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb143-8"><a href="#cb143-8" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'category'</span>, </span>
<span id="cb143-9"><a href="#cb143-9" tabindex="-1"></a>    categories<span class="op">=</span>[<span class="st">'NH'</span>, <span class="st">'SH'</span>], </span>
<span id="cb143-10"><a href="#cb143-10" tabindex="-1"></a>    cmap<span class="op">=</span>[<span class="st">'#1f78b4'</span>, <span class="st">'#e31a1c'</span>],</span>
<span id="cb143-11"><a href="#cb143-11" tabindex="-1"></a>    categorical<span class="op">=</span><span class="va">True</span></span>
<span id="cb143-12"><a href="#cb143-12" tabindex="-1"></a>)</span>
<span id="cb143-13"><a href="#cb143-13" tabindex="-1"></a></span>
<span id="cb143-14"><a href="#cb143-14" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
</div>
<div class="section level2" id="create-multi-layer-maps">
<h2>Create Multi-layer Maps</h2>
<p>When you call <code>explore()</code> a folium object is created. You
can save that object and add more layers to the same object.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb144-2"><a href="#cb144-2" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">'Stamen Terrain'</span>)</span>
<span id="cb144-4"><a href="#cb144-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb144-5"><a href="#cb144-5" tabindex="-1"></a></span>
<span id="cb144-6"><a href="#cb144-6" tabindex="-1"></a>districts_gdf.explore(</span>
<span id="cb144-7"><a href="#cb144-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb144-8"><a href="#cb144-8" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'black'</span>, </span>
<span id="cb144-9"><a href="#cb144-9" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">'fillOpacity'</span>: <span class="fl">0.3</span>, <span class="st">'weight'</span>:<span class="fl">0.5</span>},</span>
<span id="cb144-10"><a href="#cb144-10" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'districts'</span>,</span>
<span id="cb144-11"><a href="#cb144-11" tabindex="-1"></a>    tooltip<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb144-12"><a href="#cb144-12" tabindex="-1"></a></span>
<span id="cb144-13"><a href="#cb144-13" tabindex="-1"></a>roads_gdf.explore(</span>
<span id="cb144-14"><a href="#cb144-14" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb144-15"><a href="#cb144-15" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'category'</span>, </span>
<span id="cb144-16"><a href="#cb144-16" tabindex="-1"></a>    categories<span class="op">=</span>[<span class="st">'NH'</span>, <span class="st">'SH'</span>], </span>
<span id="cb144-17"><a href="#cb144-17" tabindex="-1"></a>    cmap<span class="op">=</span>[<span class="st">'#1f78b4'</span>, <span class="st">'#e31a1c'</span>],</span>
<span id="cb144-18"><a href="#cb144-18" tabindex="-1"></a>    categorical<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb144-19"><a href="#cb144-19" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'highways'</span></span>
<span id="cb144-20"><a href="#cb144-20" tabindex="-1"></a>)</span>
<span id="cb144-21"><a href="#cb144-21" tabindex="-1"></a></span>
<span id="cb144-22"><a href="#cb144-22" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>To make our map easier to explore, we also add a <em>Layer
Control</em> that displays the list of layers on the top-right corner
and also allows the users to turn them on or off. The <code>name</code>
parameter to the <code>explore()</code> function controls the name that
will be displayed in the layer control.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb145-2"><a href="#cb145-2" tabindex="-1"></a>m</span></code></pre></div>
</div>
<div class="section level2" id="exercise-8">
<h2>Exercise</h2>
<p>Add the <code>state_gdf</code> layer to the folium map below with a
thick blue border and no fill. Save the resulting map as a HTML file on
your computer.</p>
<p>Hint: Use the <code>style_kwds</code> with <em>‘fill’</em> and
<em>‘weight’</em> options.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb146-2"><a href="#cb146-2" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">'Stamen Terrain'</span>)</span>
<span id="cb146-4"><a href="#cb146-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb146-5"><a href="#cb146-5" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" tabindex="-1"></a>districts_gdf.explore(</span>
<span id="cb146-7"><a href="#cb146-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb146-8"><a href="#cb146-8" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'black'</span>, </span>
<span id="cb146-9"><a href="#cb146-9" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">'fillOpacity'</span>: <span class="fl">0.3</span>, <span class="st">'weight'</span>:<span class="fl">0.5</span>},</span>
<span id="cb146-10"><a href="#cb146-10" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'districts'</span>,</span>
<span id="cb146-11"><a href="#cb146-11" tabindex="-1"></a>    tooltip<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb146-12"><a href="#cb146-12" tabindex="-1"></a></span>
<span id="cb146-13"><a href="#cb146-13" tabindex="-1"></a>roads_gdf.explore(</span>
<span id="cb146-14"><a href="#cb146-14" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb146-15"><a href="#cb146-15" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'category'</span>, </span>
<span id="cb146-16"><a href="#cb146-16" tabindex="-1"></a>    categories<span class="op">=</span>[<span class="st">'NH'</span>, <span class="st">'SH'</span>], </span>
<span id="cb146-17"><a href="#cb146-17" tabindex="-1"></a>    cmap<span class="op">=</span>[<span class="st">'#1f78b4'</span>, <span class="st">'#e31a1c'</span>],</span>
<span id="cb146-18"><a href="#cb146-18" tabindex="-1"></a>    categorical<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb146-19"><a href="#cb146-19" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'highways'</span></span>
<span id="cb146-20"><a href="#cb146-20" tabindex="-1"></a>)</span>
<span id="cb146-21"><a href="#cb146-21" tabindex="-1"></a></span>
<span id="cb146-22"><a href="#cb146-22" tabindex="-1"></a>fig.add_child(m)</span>
<span id="cb146-23"><a href="#cb146-23" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb146-24"><a href="#cb146-24" tabindex="-1"></a>m</span></code></pre></div>
</div>
</div>
<div class="section level1" id="leafmap-basics">
<h1>Leafmap Basics</h1>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/10_leafmap_basics.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<hr/>
<div class="section level2" id="overview-8">
<h2>Overview</h2>
<p><a href="https://leafmap.org/">Leafmap</a> is a Python package for
interactive mapping that supports a wide-variety of plotting
backends.</p>
<p>We will explore the capabilities of Leafmap and create a map that
includes vector and raster layers. For a more comprehensive overview,
check out <a href="https://leafmap.org/notebooks/00_key_features/">leafmap key
Features</a>.</p>
</div>
<div class="section level2" id="setup-and-data-download-7">
<h2>Setup and Data Download</h2>
<div class="sourceCode" id="cb147"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb147-2"><a href="#cb147-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb147-3"><a href="#cb147-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb147-4"><a href="#cb147-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree mapclassify</span>
<span id="cb147-5"><a href="#cb147-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span>
<span id="cb147-6"><a href="#cb147-6" tabindex="-1"></a>  <span class="op">!</span>pip install leafmap</span></code></pre></div>
<div class="sourceCode" id="cb148"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb148-2"><a href="#cb148-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb148-3"><a href="#cb148-3" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span></code></pre></div>
<div class="sourceCode" id="cb149"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb149-2"><a href="#cb149-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb149-3"><a href="#cb149-3" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb149-5"><a href="#cb149-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb149-6"><a href="#cb149-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb149-7"><a href="#cb149-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb150"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb150-2"><a href="#cb150-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb150-3"><a href="#cb150-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb150-4"><a href="#cb150-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb150-5"><a href="#cb150-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb150-6"><a href="#cb150-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb150-7"><a href="#cb150-7" tabindex="-1"></a></span>
<span id="cb150-8"><a href="#cb150-8" tabindex="-1"></a>json_file <span class="op">=</span> <span class="st">'bangalore_wards.json'</span></span>
<span id="cb150-9"><a href="#cb150-9" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">'bangalore_roads.gpkg'</span></span>
<span id="cb150-10"><a href="#cb150-10" tabindex="-1"></a></span>
<span id="cb150-11"><a href="#cb150-11" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/bangalore/'</span></span>
<span id="cb150-12"><a href="#cb150-12" tabindex="-1"></a></span>
<span id="cb150-13"><a href="#cb150-13" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> json_file, gpkg_file:</span>
<span id="cb150-14"><a href="#cb150-14" tabindex="-1"></a>  download(data_url <span class="op">+</span> f)</span></code></pre></div>
</div>
<div class="section level2" id="creating-a-map">
<h2>Creating a Map</h2>
<div class="sourceCode" id="cb151"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb151-2"><a href="#cb151-2" tabindex="-1"></a>m</span></code></pre></div>
<p>You can change the basemap to a Google basemap and set the center of
the map. <code>leafmap.Map()</code> supports many arguments to customize
the map and available controls.</p>
<p>References:</p>
<ul>
<li><a href="https://leafmap.org/leafmap/#leafmap.leafmap.Map"><code>leafmap.leafmap.Map</code></a></li>
<li><a href="https://ipyleaflet.readthedocs.io/en/latest/api_reference/index.html#ipyleaflet.leaflet.Map"><code>ipyleaflet.leaflet.Map</code></a></li>
</ul>
<div class="sourceCode" id="cb152"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>, google_map<span class="op">=</span><span class="st">'HYBRID'</span>, center<span class="op">=</span>(<span class="fl">12.97</span>, <span class="fl">77.59</span>), zoom<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb152-2"><a href="#cb152-2" tabindex="-1"></a>m</span></code></pre></div>
</div>
<div class="section level2" id="adding-data-layers">
<h2>Adding Data Layers</h2>
<p>Leafmap’s <code>foliummap</code> module supports adding a variety of
data types along with helper functions such as
<code>set_center()</code>. Let’s add a GeoJSON file to the map using
<code>add_geojson()</code>.</p>
<p>Reference: <a href="https://leafmap.org/foliumap/#leafmap.foliumap.Map.add_geojson">leafmap.foliumap.Map.add_geojson</a></p>
<div class="sourceCode" id="cb153"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb153-2"><a href="#cb153-2" tabindex="-1"></a></span>
<span id="cb153-3"><a href="#cb153-3" tabindex="-1"></a>json_filepath <span class="op">=</span> os.path.join(data_folder, json_file)</span>
<span id="cb153-4"><a href="#cb153-4" tabindex="-1"></a></span>
<span id="cb153-5"><a href="#cb153-5" tabindex="-1"></a>m.add_geojson(json_filepath, layer_name<span class="op">=</span><span class="st">'City'</span>)</span>
<span id="cb153-6"><a href="#cb153-6" tabindex="-1"></a>m.set_center(<span class="fl">77.59</span>, <span class="fl">12.97</span>, <span class="dv">10</span>)</span>
<span id="cb153-7"><a href="#cb153-7" tabindex="-1"></a>m</span></code></pre></div>
<p>We can also add any vector layer that can be read by GeoPandas. Here
we add a line layer from a GeoPackage using the <code>add_gdf()</code>
function. The styling parameters can be any folium supported styles.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb154-2"><a href="#cb154-2" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" tabindex="-1"></a>gpkg_filepath <span class="op">=</span> os.path.join(data_folder, gpkg_file)</span>
<span id="cb154-4"><a href="#cb154-4" tabindex="-1"></a></span>
<span id="cb154-5"><a href="#cb154-5" tabindex="-1"></a>roads_gdf <span class="op">=</span> gpd.read_file(gpkg_filepath)</span>
<span id="cb154-6"><a href="#cb154-6" tabindex="-1"></a></span>
<span id="cb154-7"><a href="#cb154-7" tabindex="-1"></a>m.add_gdf(roads_gdf, layer_name<span class="op">=</span><span class="st">'Roads'</span>, style<span class="op">=</span>{<span class="st">'color'</span>:<span class="st">'blue'</span>, <span class="st">'weight'</span>:<span class="fl">0.5</span>})</span>
<span id="cb154-8"><a href="#cb154-8" tabindex="-1"></a>m.zoom_to_gdf(roads_gdf)</span>
<span id="cb154-9"><a href="#cb154-9" tabindex="-1"></a>m</span></code></pre></div>
<p>A very useful feature of LeafMap is the ability to load a
Cloud-Optimized GeoTIFF (COG) file directly from a URL without the need
of a server. The file is streamed directly and high-resolution tiles are
automatically fetched as you zoom in. We load a 8-bit RGB image hosted
on GitHub using the <code>add_cog_layer()</code> function.</p>
<p>Reference: <a href="https://leafmap.org/leafmap/#leafmap.leafmap.Map.add_cog_layer"><code>leafmap.Map.add_cog_layer</code></a></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb155-2"><a href="#cb155-2" tabindex="-1"></a></span>
<span id="cb155-3"><a href="#cb155-3" tabindex="-1"></a>cog_url <span class="op">=</span> os.path.join(data_url, <span class="st">'bangalore_lulc_rgb.tif'</span>)</span>
<span id="cb155-4"><a href="#cb155-4" tabindex="-1"></a>bounds <span class="op">=</span> leafmap.cog_bounds(cog_url)</span>
<span id="cb155-5"><a href="#cb155-5" tabindex="-1"></a></span>
<span id="cb155-6"><a href="#cb155-6" tabindex="-1"></a>m.add_cog_layer(cog_url, name<span class="op">=</span><span class="st">'Land Use Land Cover'</span>)</span>
<span id="cb155-7"><a href="#cb155-7" tabindex="-1"></a>m.zoom_to_bounds(bounds)</span>
<span id="cb155-8"><a href="#cb155-8" tabindex="-1"></a>m</span></code></pre></div>
<p>Leafmap also supports adding custom legends. We define a list of
color codes and labels for the land cover classes contained in the
<code>bangalore_lulc.tif</code> image. We can now add a legend to the
map using the <code>add_legend()</code> function.</p>
<p>Reference: <a href="https://leafmap.org/foliumap/#leafmap.foliumap.Map.add_legend">leafmap.foliumap.Map.add_legend</a></p>
<div class="sourceCode" id="cb156"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb156-2"><a href="#cb156-2" tabindex="-1"></a></span>
<span id="cb156-3"><a href="#cb156-3" tabindex="-1"></a>cog_url <span class="op">=</span> os.path.join(data_url, <span class="st">'bangalore_lulc_rgb.tif'</span>)</span>
<span id="cb156-4"><a href="#cb156-4" tabindex="-1"></a>bounds <span class="op">=</span> leafmap.cog_bounds(cog_url)</span>
<span id="cb156-5"><a href="#cb156-5" tabindex="-1"></a></span>
<span id="cb156-6"><a href="#cb156-6" tabindex="-1"></a>m.add_cog_layer(cog_url, name<span class="op">=</span><span class="st">'Land Use Land Cover'</span>)</span>
<span id="cb156-7"><a href="#cb156-7" tabindex="-1"></a>m.zoom_to_bounds(bounds)</span>
<span id="cb156-8"><a href="#cb156-8" tabindex="-1"></a></span>
<span id="cb156-9"><a href="#cb156-9" tabindex="-1"></a><span class="co"># Add a Legend</span></span>
<span id="cb156-10"><a href="#cb156-10" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#006400'</span>, <span class="st">'#ffbb22'</span>,<span class="st">'#ffff4c'</span>,<span class="st">'#f096ff'</span>,<span class="st">'#fa0000'</span>,</span>
<span id="cb156-11"><a href="#cb156-11" tabindex="-1"></a>          <span class="st">'#b4b4b4'</span>,<span class="st">'#f0f0f0'</span>,<span class="st">'#0064c8'</span>,<span class="st">'#0096a0'</span>,<span class="st">'#00cf75'</span>,<span class="st">'#fae6a0'</span>]</span>
<span id="cb156-12"><a href="#cb156-12" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">"Trees"</span>,<span class="st">"Shrubland"</span>,<span class="st">"Grassland"</span>,<span class="st">"Cropland"</span>,<span class="st">"Built-up"</span>,</span>
<span id="cb156-13"><a href="#cb156-13" tabindex="-1"></a>          <span class="st">"Barren / sparse vegetation"</span>,<span class="st">"Snow and ice"</span>,<span class="st">"Open water"</span>,</span>
<span id="cb156-14"><a href="#cb156-14" tabindex="-1"></a>          <span class="st">"Herbaceous wetland"</span>,<span class="st">"Mangroves"</span>,<span class="st">"Moss and lichen"</span>]</span>
<span id="cb156-15"><a href="#cb156-15" tabindex="-1"></a>m.add_legend(colors<span class="op">=</span>colors, labels<span class="op">=</span>labels)</span>
<span id="cb156-16"><a href="#cb156-16" tabindex="-1"></a>m</span></code></pre></div>
<p>We can save the resulting map to a HTML file using the
<code>to_html()</code> function.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb157-2"><a href="#cb157-2" tabindex="-1"></a></span>
<span id="cb157-3"><a href="#cb157-3" tabindex="-1"></a>cog_url <span class="op">=</span> os.path.join(data_url, <span class="st">'bangalore_lulc_rgb.tif'</span>)</span>
<span id="cb157-4"><a href="#cb157-4" tabindex="-1"></a>bounds <span class="op">=</span> leafmap.cog_bounds(cog_url)</span>
<span id="cb157-5"><a href="#cb157-5" tabindex="-1"></a></span>
<span id="cb157-6"><a href="#cb157-6" tabindex="-1"></a>m.add_cog_layer(cog_url, name<span class="op">=</span><span class="st">'Land Use Land Cover'</span>)</span>
<span id="cb157-7"><a href="#cb157-7" tabindex="-1"></a>m.zoom_to_bounds(bounds)</span>
<span id="cb157-8"><a href="#cb157-8" tabindex="-1"></a></span>
<span id="cb157-9"><a href="#cb157-9" tabindex="-1"></a><span class="co"># Add a Legend</span></span>
<span id="cb157-10"><a href="#cb157-10" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#006400'</span>, <span class="st">'#ffbb22'</span>,<span class="st">'#ffff4c'</span>,<span class="st">'#f096ff'</span>,<span class="st">'#fa0000'</span>,</span>
<span id="cb157-11"><a href="#cb157-11" tabindex="-1"></a>          <span class="st">'#b4b4b4'</span>,<span class="st">'#f0f0f0'</span>,<span class="st">'#0064c8'</span>,<span class="st">'#0096a0'</span>,<span class="st">'#00cf75'</span>,<span class="st">'#fae6a0'</span>]</span>
<span id="cb157-12"><a href="#cb157-12" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">"Trees"</span>,<span class="st">"Shrubland"</span>,<span class="st">"Grassland"</span>,<span class="st">"Cropland"</span>,<span class="st">"Built-up"</span>,</span>
<span id="cb157-13"><a href="#cb157-13" tabindex="-1"></a>          <span class="st">"Barren / sparse vegetation"</span>,<span class="st">"Snow and ice"</span>,<span class="st">"Open water"</span>,</span>
<span id="cb157-14"><a href="#cb157-14" tabindex="-1"></a>          <span class="st">"Herbaceous wetland"</span>,<span class="st">"Mangroves"</span>,<span class="st">"Moss and lichen"</span>]</span>
<span id="cb157-15"><a href="#cb157-15" tabindex="-1"></a>m.add_legend(colors<span class="op">=</span>colors, labels<span class="op">=</span>labels)</span>
<span id="cb157-16"><a href="#cb157-16" tabindex="-1"></a></span>
<span id="cb157-17"><a href="#cb157-17" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">'lulc.html'</span></span>
<span id="cb157-18"><a href="#cb157-18" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb157-19"><a href="#cb157-19" tabindex="-1"></a>m.to_html(output_path)</span></code></pre></div>
</div>
<div class="section level2" id="exercise-9">
<h2>Exercise</h2>
<p>The code below contains a basic leafmap map. We want to a raster
layers of VIIRS Nighttime Lights over India. The URL to a Cloud Optmized
GeoTiff (COG) file hosted on Google Cloud Storage is given below.</p>
<p>Add the data to the map and visualize it.</p>
<p>Reference: <a href="https://leafmap.org/leafmap/#leafmap.leafmap.Map.add_cog_layer"><code>leafmap.Map.add_cog_layer</code></a></p>
<p>You will need to specify additional <code>kwargs</code> parameters to
create a correct visualization.</p>
<ol style="list-style-type: decimal">
<li>The GeoTIFF image is a single-band image with grayscale values of
night light intensities. The range of these values are between 0-60. Use
<code>rescale='0,60'</code>.</li>
<li>The image has a nodata values stored as <code>nan</code>. Use
<code>nodata='nan'</code>.</li>
<li>A grayscale image can be displayed in color using a colormap. Use
<code>colormap_name=viridis</code>.</li>
</ol>
<div class="sourceCode" id="cb158"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" tabindex="-1"></a>gcs_bucket <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/'</span></span>
<span id="cb158-2"><a href="#cb158-2" tabindex="-1"></a>cog_url <span class="op">=</span> os.path.join(gcs_bucket, <span class="st">'viirs_ntl_2021_india.tif'</span>)</span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="section level1" id="streamlit-basics">
<h1>Streamlit Basics</h1>
<p>Streamlit is a Python library that allows you to create web-apps and
dashboard by just writing Python code. It provides you with a wide range
of UI widgets and layouts that can be used to build user- interfaces.
Your streamlit app is just a regular Python file with a <code>.py</code>
extension.</p>
<div class="section level2" id="installation-and-setting-up-the-environment">
<h2>Installation and Setting up the Environment</h2>
<p>You need to install the <code>streamlit</code> package to create the
app. We will be using Anaconda to install <code>streamlit</code> and
related packages on your machine. Please review the <a href="https://courses.spatialthoughts.com/python-foundation.html#installation-and-setting-up-the-environment">Anaconda
Installation Guide</a> for step-by-step instructions.</p>
<ol style="list-style-type: decimal">
<li>Once you have installed Anaconda, open <em>Anaconda Prompt</em> or a
<em>Terminal</em> and run the following commands.</li>
</ol>
<pre><code>conda update --all
conda create --name streamlit -y
conda activate streamlit</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Now your environment is ready. We will install the required
packages. First install <code>geopandas</code>.</li>
</ol>
<pre><code>conda install -c conda-forge geopandas  -y</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Next we will install <code>streamlit</code> and
<code>leafmap</code>.</li>
</ol>
<pre><code>conda install -c conda-forge streamlit streamlit-folium leafmap -y</code></pre>
<p>Some users have reported problems where conda is not able to resolve
the environment for installing these packages. Here is an alternate
installation procedure if you face difficulties with above. After
install geopandas, switch to using <code>pip</code> for installing the
remaining packages.</p>
<pre><code>pip install streamlit streamlit-folium leafmap</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>After the installation is done, run the following command.</li>
</ol>
<pre><code>streamlit hello</code></pre>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/streamlit1.png" style="display: block; margin: auto;" width="75%"/></p>
<p>A new browser tab will open and display the streamlit Hello app.</p>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/streamlit2.png" style="display: block; margin: auto;" width="75%"/></p>
<p>Your installation is now complete. You can close the terminal window
to stop the streamlit server.</p>
</div>
<div class="section level2" id="create-a-simple-dashboard">
<h2>Create a Simple Dashboard</h2>
<p>Let’s create a simple interactive dashboard by loading a CSV file and
displaying a chart with some statistics. We will get familiar with the
streamlit app development workflow and explore different widgets and
layout elements.</p>
<ol style="list-style-type: decimal">
<li>Create a folder named <strong>simple_dashboard</strong> on your
Desktop.</li>
</ol>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard1.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="2" style="list-style-type: decimal">
<li>Open your favorite text editor and create a file with the following
content. By convention, we import <code>streamlit as st</code>. Then we
can use the <code>st.title()</code> to display the title of our
dashboard and <code>st.write()</code> to add a paragraph of text. Save
the file in the <strong>simple_dashboard</strong> folder on your desktop
as <code>app.py</code></li>
</ol>
<div class="sourceCode" id="cb164"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb164-2"><a href="#cb164-2" tabindex="-1"></a></span>
<span id="cb164-3"><a href="#cb164-3" tabindex="-1"></a>st.title(<span class="st">'A Simple Dashboard'</span>)</span>
<span id="cb164-4"><a href="#cb164-4" tabindex="-1"></a>st.write(<span class="st">'This dashboard displays a chart for the selected region.'</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard2.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="3" style="list-style-type: decimal">
<li>Once the file is saved, open <em>Anaconda Prompt</em> (Windows) or
<em>Terminal</em> (Mac/Linux). Switch to the conda environment where you
have installed the required packages. We then use <code>cd</code>
command to change the current directory to the once with the
<code>app.py</code> file. Then run the following command to start the
streamlit server and launch the app.</li>
</ol>
<div class="sourceCode" id="cb165"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" tabindex="-1"></a>streamlit run app.py</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard3.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="4" style="list-style-type: decimal">
<li>A new browser tab will open and display the output of the app.</li>
</ol>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard4.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="5" style="list-style-type: decimal">
<li>Let’s read some data and display it. We load a CSV file from a URL
using Pandas and get a DataFrame object. We then use
<code>st.dataframe()</code> widget to render the dataframe. Update your
<code>app.py</code> with the following code. As you save the file, you
will notice that streamlit will detect it and display a prompt to re-run
your app. Choose <em>Always rerun</em>.</li>
</ol>
<div class="sourceCode" id="cb166"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb166-2"><a href="#cb166-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb166-3"><a href="#cb166-3" tabindex="-1"></a></span>
<span id="cb166-4"><a href="#cb166-4" tabindex="-1"></a></span>
<span id="cb166-5"><a href="#cb166-5" tabindex="-1"></a>st.title(<span class="st">'A Simple Dashboard'</span>)</span>
<span id="cb166-6"><a href="#cb166-6" tabindex="-1"></a>st.write(<span class="st">'This dashboard displays a chart for the selected region.'</span>)</span>
<span id="cb166-7"><a href="#cb166-7" tabindex="-1"></a></span>
<span id="cb166-8"><a href="#cb166-8" tabindex="-1"></a></span>
<span id="cb166-9"><a href="#cb166-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb166-10"><a href="#cb166-10" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb166-11"><a href="#cb166-11" tabindex="-1"></a></span>
<span id="cb166-12"><a href="#cb166-12" tabindex="-1"></a>url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb166-13"><a href="#cb166-13" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb166-14"><a href="#cb166-14" tabindex="-1"></a></span>
<span id="cb166-15"><a href="#cb166-15" tabindex="-1"></a>st.dataframe(df)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard5.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="6" style="list-style-type: decimal">
<li>The app will now display the dataframe. The dataframe consists of 3
columns. The <code>DISTRICT</code> column contains a unique name for the
admin region. The <em>NH</em> and <em>SH</em> columns contain the length
of <em>National Highways</em> and <em>State Highways</em> in Kilometers
for each admin region. We will now create a dashboard that displays a
chart with the lengths of highways for the user-selected admin
region.</li>
</ol>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard6.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="7" style="list-style-type: decimal">
<li>Let’s add a dropdown menu with the list of admin regions. We first
get the names from the <code>DISTRICT</code> column and use
<code>st.selectbox()</code> to add a dropdown selector. Streamlit apps
always run the entire <code>app.py</code> whenever any selection is
changed. With our current app structure, whenever the user selected a
new admin region, the source file will be fetched again and a new
dataframe will be created. This is not required as the source data does
not change on every interaction. A good practice is to put the data
fetching in a function and use the <code>@st.cache_data</code> decorator
which will cache the results. Anytime the function is called with the
same arguments, it will return the cached version of the data instead of
fetching it.</li>
</ol>
<div class="sourceCode" id="cb167"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb167-2"><a href="#cb167-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb167-3"><a href="#cb167-3" tabindex="-1"></a></span>
<span id="cb167-4"><a href="#cb167-4" tabindex="-1"></a></span>
<span id="cb167-5"><a href="#cb167-5" tabindex="-1"></a>st.title(<span class="st">'A Simple Dashboard'</span>)</span>
<span id="cb167-6"><a href="#cb167-6" tabindex="-1"></a>st.write(<span class="st">'This dashboard displays a chart for the selected region.'</span>)</span>
<span id="cb167-7"><a href="#cb167-7" tabindex="-1"></a></span>
<span id="cb167-8"><a href="#cb167-8" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb167-9"><a href="#cb167-9" tabindex="-1"></a><span class="kw">def</span> load_data():</span>
<span id="cb167-10"><a href="#cb167-10" tabindex="-1"></a>    data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb167-11"><a href="#cb167-11" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb167-12"><a href="#cb167-12" tabindex="-1"></a></span>
<span id="cb167-13"><a href="#cb167-13" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb167-14"><a href="#cb167-14" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb167-15"><a href="#cb167-15" tabindex="-1"></a>    </span>
<span id="cb167-16"><a href="#cb167-16" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb167-17"><a href="#cb167-17" tabindex="-1"></a></span>
<span id="cb167-18"><a href="#cb167-18" tabindex="-1"></a>df <span class="op">=</span> load_data()</span>
<span id="cb167-19"><a href="#cb167-19" tabindex="-1"></a></span>
<span id="cb167-20"><a href="#cb167-20" tabindex="-1"></a>districts <span class="op">=</span> df.DISTRICT.values</span>
<span id="cb167-21"><a href="#cb167-21" tabindex="-1"></a>district <span class="op">=</span> st.selectbox(<span class="st">'Select a district'</span>, districts)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard7.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="8" style="list-style-type: decimal">
<li>As the user selects an admin region from the selectbox, the selected
value is saved in the <code>district</code> variable. We use it to
filter the DataFrame to the selected district. Then we use Matplotlib to
create a bar-chart with the filtered dataframe and display it using
<code>st.pyplot()</code> widget.</li>
</ol>
<div class="sourceCode" id="cb168"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb168-2"><a href="#cb168-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb168-3"><a href="#cb168-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb168-4"><a href="#cb168-4" tabindex="-1"></a></span>
<span id="cb168-5"><a href="#cb168-5" tabindex="-1"></a></span>
<span id="cb168-6"><a href="#cb168-6" tabindex="-1"></a>st.title(<span class="st">'A Simple Dashboard'</span>)</span>
<span id="cb168-7"><a href="#cb168-7" tabindex="-1"></a>st.write(<span class="st">'This dashboard displays a chart for the selected region.'</span>)</span>
<span id="cb168-8"><a href="#cb168-8" tabindex="-1"></a></span>
<span id="cb168-9"><a href="#cb168-9" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb168-10"><a href="#cb168-10" tabindex="-1"></a><span class="kw">def</span> load_data():</span>
<span id="cb168-11"><a href="#cb168-11" tabindex="-1"></a>    data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb168-12"><a href="#cb168-12" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb168-13"><a href="#cb168-13" tabindex="-1"></a></span>
<span id="cb168-14"><a href="#cb168-14" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb168-15"><a href="#cb168-15" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb168-16"><a href="#cb168-16" tabindex="-1"></a>    </span>
<span id="cb168-17"><a href="#cb168-17" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb168-18"><a href="#cb168-18" tabindex="-1"></a></span>
<span id="cb168-19"><a href="#cb168-19" tabindex="-1"></a>df <span class="op">=</span> load_data()</span>
<span id="cb168-20"><a href="#cb168-20" tabindex="-1"></a></span>
<span id="cb168-21"><a href="#cb168-21" tabindex="-1"></a>districts <span class="op">=</span> df.DISTRICT.values</span>
<span id="cb168-22"><a href="#cb168-22" tabindex="-1"></a>district <span class="op">=</span> st.selectbox(<span class="st">'Select a district'</span>, districts)</span>
<span id="cb168-23"><a href="#cb168-23" tabindex="-1"></a>filtered <span class="op">=</span> df[df[<span class="st">'DISTRICT'</span>] <span class="op">==</span> district] </span>
<span id="cb168-24"><a href="#cb168-24" tabindex="-1"></a></span>
<span id="cb168-25"><a href="#cb168-25" tabindex="-1"></a></span>
<span id="cb168-26"><a href="#cb168-26" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb168-27"><a href="#cb168-27" tabindex="-1"></a></span>
<span id="cb168-28"><a href="#cb168-28" tabindex="-1"></a>filtered.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">'#0000FF'</span>, <span class="st">'#FF0000'</span>],</span>
<span id="cb168-29"><a href="#cb168-29" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">'Kilometers'</span>, xlabel<span class="op">=</span><span class="st">'Category'</span>)</span>
<span id="cb168-30"><a href="#cb168-30" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb168-31"><a href="#cb168-31" tabindex="-1"></a>stats <span class="op">=</span> st.pyplot(fig)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard8.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="9" style="list-style-type: decimal">
<li>Our dashboard now displays an updated chart every-time you change
the selection. Streamlit provides many other user-interface widgets.
Let’s explore some more of them. We will use
<code>st.color_picker()</code> widget to allow users to customize the
color of the bar chart. We can display 2 color-pickers side-by-side
using a column layout. We use <code>st.columns()</code> to create 2
columns <code>col1</code> and <code>col2</code>. We add a
<code>color_picker()</code> to each column with appropriate label and a
default color. If we have more than 1 widget of the same type in the
app, we need to provide a unique <code>key</code> that can be used to
identify the widget. We make some final tweaks to the chart and complete
the dashboard.</li>
</ol>
<div class="sourceCode" id="cb169"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb169-2"><a href="#cb169-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb169-3"><a href="#cb169-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb169-4"><a href="#cb169-4" tabindex="-1"></a></span>
<span id="cb169-5"><a href="#cb169-5" tabindex="-1"></a>st.title(<span class="st">'A Simple Dashboard'</span>)</span>
<span id="cb169-6"><a href="#cb169-6" tabindex="-1"></a>st.write(<span class="st">'This dashboard displays a chart for the selected region.'</span>)</span>
<span id="cb169-7"><a href="#cb169-7" tabindex="-1"></a></span>
<span id="cb169-8"><a href="#cb169-8" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb169-9"><a href="#cb169-9" tabindex="-1"></a><span class="kw">def</span> load_data():</span>
<span id="cb169-10"><a href="#cb169-10" tabindex="-1"></a>    data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb169-11"><a href="#cb169-11" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb169-12"><a href="#cb169-12" tabindex="-1"></a></span>
<span id="cb169-13"><a href="#cb169-13" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb169-14"><a href="#cb169-14" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb169-15"><a href="#cb169-15" tabindex="-1"></a>    </span>
<span id="cb169-16"><a href="#cb169-16" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb169-17"><a href="#cb169-17" tabindex="-1"></a></span>
<span id="cb169-18"><a href="#cb169-18" tabindex="-1"></a>df <span class="op">=</span> load_data()</span>
<span id="cb169-19"><a href="#cb169-19" tabindex="-1"></a></span>
<span id="cb169-20"><a href="#cb169-20" tabindex="-1"></a>districts <span class="op">=</span> df.DISTRICT.values</span>
<span id="cb169-21"><a href="#cb169-21" tabindex="-1"></a>district <span class="op">=</span> st.selectbox(<span class="st">'Select a district'</span>, districts)</span>
<span id="cb169-22"><a href="#cb169-22" tabindex="-1"></a>filtered <span class="op">=</span> df[df[<span class="st">'DISTRICT'</span>] <span class="op">==</span> district] </span>
<span id="cb169-23"><a href="#cb169-23" tabindex="-1"></a></span>
<span id="cb169-24"><a href="#cb169-24" tabindex="-1"></a>col1, col2 <span class="op">=</span> st.columns(<span class="dv">2</span>)</span>
<span id="cb169-25"><a href="#cb169-25" tabindex="-1"></a></span>
<span id="cb169-26"><a href="#cb169-26" tabindex="-1"></a>nh_color <span class="op">=</span> col1.color_picker(<span class="st">'Pick NH Color'</span>, <span class="st">'#0000FF'</span>, key<span class="op">=</span><span class="st">'nh'</span>)</span>
<span id="cb169-27"><a href="#cb169-27" tabindex="-1"></a>sh_color <span class="op">=</span> col2.color_picker(<span class="st">'Pick SH Color'</span>, <span class="st">'#FF0000'</span>, key<span class="op">=</span><span class="st">'sh'</span>)</span>
<span id="cb169-28"><a href="#cb169-28" tabindex="-1"></a></span>
<span id="cb169-29"><a href="#cb169-29" tabindex="-1"></a>    </span>
<span id="cb169-30"><a href="#cb169-30" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb169-31"><a href="#cb169-31" tabindex="-1"></a></span>
<span id="cb169-32"><a href="#cb169-32" tabindex="-1"></a>filtered.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[nh_color, sh_color],</span>
<span id="cb169-33"><a href="#cb169-33" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">'Kilometers'</span>, xlabel<span class="op">=</span><span class="st">'Category'</span>)</span>
<span id="cb169-34"><a href="#cb169-34" tabindex="-1"></a>ax.set_title(<span class="st">'Length of Highways'</span>)</span>
<span id="cb169-35"><a href="#cb169-35" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">2500</span>)</span>
<span id="cb169-36"><a href="#cb169-36" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb169-37"><a href="#cb169-37" tabindex="-1"></a>stats <span class="op">=</span> st.pyplot(fig)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard9.png" style="display: block; margin: auto;" width="75%"/></p>
</div>
<div class="section level2" id="exercise-10">
<h2>Exercise</h2>
<p>Add a radio-button to the app that allows the user to select the
units for length between Kilometers and Miles as shown below. As the
user toggles the radio-button, you should apply the appropriate
conversion from Kilometer to Miles and update the chart.</p>
<ul>
<li>Hint1: Change <code>st.columns()</code> to have 3 columns and save
the results into 3 separate objects.
<code>col1, col2, col3 = st.columns(3)</code></li>
<li>Hint2: You can convert the values from Kilometer to Miles using
<code>filtered = filtered[['NH', 'SH']]*0.621371</code></li>
</ul>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/dashboard_exercise.png" style="display: block; margin: auto;" width="75%"/></p>
</div>
<div class="section level2" id="create-a-simple-app">
<h2>Create a Simple App</h2>
<p>Let’s create a simple app that geocodes a user query and displays the
results on a map. We will use <a href="https://openrouteservice.org/dev/#/api-docs/geocode">OpenRouteService
Geocoding API</a> for geocoding and Folium to display the results on a
map.</p>
<ol style="list-style-type: decimal">
<li>We start by creating a new folder <strong>simple_app</strong> and
create the <code>app.py</code> with a basic layout with a title, a
description and a text input for the address.</li>
</ol>
<div class="sourceCode" id="cb170"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb170-2"><a href="#cb170-2" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb170-3"><a href="#cb170-3" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb170-4"><a href="#cb170-4" tabindex="-1"></a></span>
<span id="cb170-5"><a href="#cb170-5" tabindex="-1"></a>st.title(<span class="st">'A Simple Geocoder'</span>)</span>
<span id="cb170-6"><a href="#cb170-6" tabindex="-1"></a>st.markdown(<span class="st">'This app uses the [OpenRouteService API](https://openrouteservice.org/) '</span></span>
<span id="cb170-7"><a href="#cb170-7" tabindex="-1"></a>    <span class="st">'to geocode the input address and display the results on a map.'</span>)</span>
<span id="cb170-8"><a href="#cb170-8" tabindex="-1"></a>    </span>
<span id="cb170-9"><a href="#cb170-9" tabindex="-1"></a>address <span class="op">=</span> st.text_input(<span class="st">'Enter an address.'</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/app1.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="2" style="list-style-type: decimal">
<li>Now we add a <code>geocode()</code> function that will take an
address and geocode it using OpenRouteService API.</li>
</ol>
<div class="sourceCode" id="cb171"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb171-2"><a href="#cb171-2" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb171-3"><a href="#cb171-3" tabindex="-1"></a></span>
<span id="cb171-4"><a href="#cb171-4" tabindex="-1"></a>st.title(<span class="st">'A Simple Geocoder'</span>)</span>
<span id="cb171-5"><a href="#cb171-5" tabindex="-1"></a>st.markdown(<span class="st">'This app uses the [OpenRouteService API](https://openrouteservice.org/) '</span></span>
<span id="cb171-6"><a href="#cb171-6" tabindex="-1"></a>  <span class="st">'to geocode the input address and display the results on a map.'</span>)</span>
<span id="cb171-7"><a href="#cb171-7" tabindex="-1"></a></span>
<span id="cb171-8"><a href="#cb171-8" tabindex="-1"></a>address <span class="op">=</span> st.text_input(<span class="st">'Enter an address.'</span>)</span>
<span id="cb171-9"><a href="#cb171-9" tabindex="-1"></a></span>
<span id="cb171-10"><a href="#cb171-10" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">'&lt;your api key&gt;'</span></span>
<span id="cb171-11"><a href="#cb171-11" tabindex="-1"></a></span>
<span id="cb171-12"><a href="#cb171-12" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb171-13"><a href="#cb171-13" tabindex="-1"></a><span class="kw">def</span> geocode(query):</span>
<span id="cb171-14"><a href="#cb171-14" tabindex="-1"></a>    parameters <span class="op">=</span> {</span>
<span id="cb171-15"><a href="#cb171-15" tabindex="-1"></a>        <span class="st">'api_key'</span>: ORS_API_KEY,</span>
<span id="cb171-16"><a href="#cb171-16" tabindex="-1"></a>        <span class="st">'text'</span> : query</span>
<span id="cb171-17"><a href="#cb171-17" tabindex="-1"></a>    }</span>
<span id="cb171-18"><a href="#cb171-18" tabindex="-1"></a></span>
<span id="cb171-19"><a href="#cb171-19" tabindex="-1"></a>    response <span class="op">=</span> requests.get(</span>
<span id="cb171-20"><a href="#cb171-20" tabindex="-1"></a>         <span class="st">'https://api.openrouteservice.org/geocode/search'</span>,</span>
<span id="cb171-21"><a href="#cb171-21" tabindex="-1"></a>         params<span class="op">=</span>parameters)</span>
<span id="cb171-22"><a href="#cb171-22" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb171-23"><a href="#cb171-23" tabindex="-1"></a>        data <span class="op">=</span> response.json()</span>
<span id="cb171-24"><a href="#cb171-24" tabindex="-1"></a>        <span class="cf">if</span> data[<span class="st">'features'</span>]:</span>
<span id="cb171-25"><a href="#cb171-25" tabindex="-1"></a>            x, y <span class="op">=</span> data[<span class="st">'features'</span>][<span class="dv">0</span>][<span class="st">'geometry'</span>][<span class="st">'coordinates'</span>]</span>
<span id="cb171-26"><a href="#cb171-26" tabindex="-1"></a>            <span class="cf">return</span> (y, x)</span>
<span id="cb171-27"><a href="#cb171-27" tabindex="-1"></a>    </span>
<span id="cb171-28"><a href="#cb171-28" tabindex="-1"></a><span class="cf">if</span> address:</span>
<span id="cb171-29"><a href="#cb171-29" tabindex="-1"></a>    results <span class="op">=</span> geocode(address)</span>
<span id="cb171-30"><a href="#cb171-30" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb171-31"><a href="#cb171-31" tabindex="-1"></a>        st.write(<span class="st">'Geocoded Coordinates: </span><span class="sc">{}</span><span class="st">, </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(results[<span class="dv">0</span>], results[<span class="dv">1</span>]))</span>
<span id="cb171-32"><a href="#cb171-32" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb171-33"><a href="#cb171-33" tabindex="-1"></a>        st.error(<span class="st">'Request failed. No results.'</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/app2.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="3" style="list-style-type: decimal">
<li>Now that we have coordinates, we can display it on a map using the
<a href="https://github.com/randyzwitch/streamlit-folium"><code>streamlit_folium</code></a>
component.</li>
</ol>
<div class="sourceCode" id="cb172"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb172-2"><a href="#cb172-2" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb172-3"><a href="#cb172-3" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb172-4"><a href="#cb172-4" tabindex="-1"></a><span class="im">from</span> streamlit_folium <span class="im">import</span> folium_static</span>
<span id="cb172-5"><a href="#cb172-5" tabindex="-1"></a></span>
<span id="cb172-6"><a href="#cb172-6" tabindex="-1"></a>st.title(<span class="st">'A Simple Geocoder'</span>)</span>
<span id="cb172-7"><a href="#cb172-7" tabindex="-1"></a>st.markdown(<span class="st">'This app uses the [OpenRouteService API](https://openrouteservice.org/) '</span></span>
<span id="cb172-8"><a href="#cb172-8" tabindex="-1"></a>    <span class="st">'to geocode the input address and siplay the results on a map.'</span>)</span>
<span id="cb172-9"><a href="#cb172-9" tabindex="-1"></a></span>
<span id="cb172-10"><a href="#cb172-10" tabindex="-1"></a>address <span class="op">=</span> st.text_input(<span class="st">'Enter an address.'</span>)</span>
<span id="cb172-11"><a href="#cb172-11" tabindex="-1"></a></span>
<span id="cb172-12"><a href="#cb172-12" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">'&lt;your api key&gt;'</span></span>
<span id="cb172-13"><a href="#cb172-13" tabindex="-1"></a></span>
<span id="cb172-14"><a href="#cb172-14" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb172-15"><a href="#cb172-15" tabindex="-1"></a><span class="kw">def</span> geocode(query):</span>
<span id="cb172-16"><a href="#cb172-16" tabindex="-1"></a>    parameters <span class="op">=</span> {</span>
<span id="cb172-17"><a href="#cb172-17" tabindex="-1"></a>        <span class="st">'api_key'</span>: ORS_API_KEY,</span>
<span id="cb172-18"><a href="#cb172-18" tabindex="-1"></a>        <span class="st">'text'</span> : query</span>
<span id="cb172-19"><a href="#cb172-19" tabindex="-1"></a>    }</span>
<span id="cb172-20"><a href="#cb172-20" tabindex="-1"></a></span>
<span id="cb172-21"><a href="#cb172-21" tabindex="-1"></a>    response <span class="op">=</span> requests.get(</span>
<span id="cb172-22"><a href="#cb172-22" tabindex="-1"></a>         <span class="st">'https://api.openrouteservice.org/geocode/search'</span>,</span>
<span id="cb172-23"><a href="#cb172-23" tabindex="-1"></a>         params<span class="op">=</span>parameters)</span>
<span id="cb172-24"><a href="#cb172-24" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb172-25"><a href="#cb172-25" tabindex="-1"></a>        data <span class="op">=</span> response.json()</span>
<span id="cb172-26"><a href="#cb172-26" tabindex="-1"></a>        <span class="cf">if</span> data[<span class="st">'features'</span>]:</span>
<span id="cb172-27"><a href="#cb172-27" tabindex="-1"></a>            x, y <span class="op">=</span> data[<span class="st">'features'</span>][<span class="dv">0</span>][<span class="st">'geometry'</span>][<span class="st">'coordinates'</span>]</span>
<span id="cb172-28"><a href="#cb172-28" tabindex="-1"></a>            <span class="cf">return</span> (y, x)</span>
<span id="cb172-29"><a href="#cb172-29" tabindex="-1"></a>    </span>
<span id="cb172-30"><a href="#cb172-30" tabindex="-1"></a><span class="cf">if</span> address:</span>
<span id="cb172-31"><a href="#cb172-31" tabindex="-1"></a>    results <span class="op">=</span> geocode(address)</span>
<span id="cb172-32"><a href="#cb172-32" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb172-33"><a href="#cb172-33" tabindex="-1"></a>        st.write(<span class="st">'Geocoded Coordinates: </span><span class="sc">{}</span><span class="st">, </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(results[<span class="dv">0</span>], results[<span class="dv">1</span>]))</span>
<span id="cb172-34"><a href="#cb172-34" tabindex="-1"></a>        </span>
<span id="cb172-35"><a href="#cb172-35" tabindex="-1"></a>        m <span class="op">=</span> folium.Map(location<span class="op">=</span>results, zoom_start<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb172-36"><a href="#cb172-36" tabindex="-1"></a>        folium.Marker(</span>
<span id="cb172-37"><a href="#cb172-37" tabindex="-1"></a>                results,</span>
<span id="cb172-38"><a href="#cb172-38" tabindex="-1"></a>                popup<span class="op">=</span>address,</span>
<span id="cb172-39"><a href="#cb172-39" tabindex="-1"></a>                icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">'green'</span>, icon<span class="op">=</span><span class="st">'crosshairs'</span>, prefix<span class="op">=</span><span class="st">'fa'</span>)</span>
<span id="cb172-40"><a href="#cb172-40" tabindex="-1"></a>                ).add_to(m)</span>
<span id="cb172-41"><a href="#cb172-41" tabindex="-1"></a>        folium_static(m, width<span class="op">=</span><span class="dv">800</span>)</span>
<span id="cb172-42"><a href="#cb172-42" tabindex="-1"></a>        </span>
<span id="cb172-43"><a href="#cb172-43" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb172-44"><a href="#cb172-44" tabindex="-1"></a>        st.error(<span class="st">'Request failed. No results.'</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/app3.png" style="display: block; margin: auto;" width="75%"/></p>
</div>
<div class="section level2" id="exercise-11">
<h2>Exercise</h2>
<p>Add a dropdown menu to give the users an option to change the default
basemap of the Folium map.</p>
<ul>
<li>Hint: Add a <code>st.selectbox()</code> with basemap strings.
<code>st.selectbox('Select a basemap', ['OpenStreetMap', 'Stamen Terrain', 'Stamen Toner'])</code></li>
</ul>
<p>Reference: <a href="https://python-visualization.github.io/folium/modules.html#module-folium.folium"><code>folium.folium.Map</code></a></p>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/app_exercise.png" style="display: block; margin: auto;" width="75%"/></p>
</div>
</div>
<div class="section level1" id="building-mapping-apps-with-leafmap-and-streamlit">
<h1>Building Mapping Apps with Leafmap and Streamlit</h1>
<p>We can leverag <code>leafmap</code> to create an interactive mapping
dashboard that gives us the flexibility of using many different mapping
backends and way to read a wide-variety of spatial data formats.</p>
<div class="section level2" id="create-a-mapping-dashboard">
<h2>Create a Mapping Dashboard</h2>
<p>The code below creates an interactive mapping dashboard that displays
the statistics of the selected region.</p>
<ol style="list-style-type: decimal">
<li>We start by creating the app directory
<strong>mapping_dashboard</strong> and creating <code>app.py</code> with
the following content. This code creates a layout with a sidebar using
<code>st.sidebar()</code> and adds some widgets to it. Note that while
we need to use <code>st.title()</code> for the main section, we use
<code>st.sidebar.title()</code> for the sidebar.</li>
</ol>
<div class="sourceCode" id="cb173"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb173-2"><a href="#cb173-2" tabindex="-1"></a></span>
<span id="cb173-3"><a href="#cb173-3" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">'Dashboard'</span>, layout<span class="op">=</span><span class="st">'wide'</span>)</span>
<span id="cb173-4"><a href="#cb173-4" tabindex="-1"></a></span>
<span id="cb173-5"><a href="#cb173-5" tabindex="-1"></a>st.title(<span class="st">'Highway Dashboard'</span>)</span>
<span id="cb173-6"><a href="#cb173-6" tabindex="-1"></a></span>
<span id="cb173-7"><a href="#cb173-7" tabindex="-1"></a>st.sidebar.title(<span class="st">'About'</span>)</span>
<span id="cb173-8"><a href="#cb173-8" tabindex="-1"></a>st.sidebar.info(<span class="st">'Explore the Highway Statistics'</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/mapping_dashboard1.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="2" style="list-style-type: decimal">
<li>We now use <code>geopandas</code> to read 2 vector layers from a
geopackage and <code>pandas</code> to read a CSV file containing road
statistics. We put the code for data fetching inside a function and
cache it using the <code>st.cache_data</code> decorator.</li>
</ol>
<div class="sourceCode" id="cb174"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb174-2"><a href="#cb174-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb174-3"><a href="#cb174-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb174-4"><a href="#cb174-4" tabindex="-1"></a></span>
<span id="cb174-5"><a href="#cb174-5" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">'Dashboard'</span>, layout<span class="op">=</span><span class="st">'wide'</span>)</span>
<span id="cb174-6"><a href="#cb174-6" tabindex="-1"></a></span>
<span id="cb174-7"><a href="#cb174-7" tabindex="-1"></a>st.title(<span class="st">'Highway Dashboard'</span>)</span>
<span id="cb174-8"><a href="#cb174-8" tabindex="-1"></a></span>
<span id="cb174-9"><a href="#cb174-9" tabindex="-1"></a>st.sidebar.title(<span class="st">'About'</span>)</span>
<span id="cb174-10"><a href="#cb174-10" tabindex="-1"></a>st.sidebar.info(<span class="st">'Explore the Highway Statistics'</span>)</span>
<span id="cb174-11"><a href="#cb174-11" tabindex="-1"></a></span>
<span id="cb174-12"><a href="#cb174-12" tabindex="-1"></a></span>
<span id="cb174-13"><a href="#cb174-13" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb174-14"><a href="#cb174-14" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">'karnataka.gpkg'</span></span>
<span id="cb174-15"><a href="#cb174-15" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb174-16"><a href="#cb174-16" tabindex="-1"></a></span>
<span id="cb174-17"><a href="#cb174-17" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb174-18"><a href="#cb174-18" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb174-19"><a href="#cb174-19" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb174-20"><a href="#cb174-20" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb174-21"><a href="#cb174-21" tabindex="-1"></a></span>
<span id="cb174-22"><a href="#cb174-22" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb174-23"><a href="#cb174-23" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb174-24"><a href="#cb174-24" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb174-25"><a href="#cb174-25" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb174-26"><a href="#cb174-26" tabindex="-1"></a>    </span>
<span id="cb174-27"><a href="#cb174-27" tabindex="-1"></a>data_load_state <span class="op">=</span> st.text(<span class="st">'Loading data...'</span>)   </span>
<span id="cb174-28"><a href="#cb174-28" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb174-29"><a href="#cb174-29" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb174-30"><a href="#cb174-30" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_districts'</span>)</span>
<span id="cb174-31"><a href="#cb174-31" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_highways'</span>)</span>
<span id="cb174-32"><a href="#cb174-32" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb174-33"><a href="#cb174-33" tabindex="-1"></a>data_load_state.text(<span class="st">'Loading data... done!'</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/mapping_dashboard2.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="3" style="list-style-type: decimal">
<li>Now we use the information in the CSV file to display a chart in the
sidebar.</li>
</ol>
<div class="sourceCode" id="cb175"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb175-2"><a href="#cb175-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb175-3"><a href="#cb175-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb175-4"><a href="#cb175-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb175-5"><a href="#cb175-5" tabindex="-1"></a></span>
<span id="cb175-6"><a href="#cb175-6" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">'Dashboard'</span>, layout<span class="op">=</span><span class="st">'wide'</span>)</span>
<span id="cb175-7"><a href="#cb175-7" tabindex="-1"></a></span>
<span id="cb175-8"><a href="#cb175-8" tabindex="-1"></a>st.title(<span class="st">'Highway Dashboard'</span>)</span>
<span id="cb175-9"><a href="#cb175-9" tabindex="-1"></a></span>
<span id="cb175-10"><a href="#cb175-10" tabindex="-1"></a>st.sidebar.title(<span class="st">'About'</span>)</span>
<span id="cb175-11"><a href="#cb175-11" tabindex="-1"></a>st.sidebar.info(<span class="st">'Explore the Highway Statistics'</span>)</span>
<span id="cb175-12"><a href="#cb175-12" tabindex="-1"></a></span>
<span id="cb175-13"><a href="#cb175-13" tabindex="-1"></a></span>
<span id="cb175-14"><a href="#cb175-14" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb175-15"><a href="#cb175-15" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">'karnataka.gpkg'</span></span>
<span id="cb175-16"><a href="#cb175-16" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb175-17"><a href="#cb175-17" tabindex="-1"></a></span>
<span id="cb175-18"><a href="#cb175-18" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb175-19"><a href="#cb175-19" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb175-20"><a href="#cb175-20" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb175-21"><a href="#cb175-21" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb175-22"><a href="#cb175-22" tabindex="-1"></a></span>
<span id="cb175-23"><a href="#cb175-23" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb175-24"><a href="#cb175-24" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb175-25"><a href="#cb175-25" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb175-26"><a href="#cb175-26" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb175-27"><a href="#cb175-27" tabindex="-1"></a></span>
<span id="cb175-28"><a href="#cb175-28" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb175-29"><a href="#cb175-29" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb175-30"><a href="#cb175-30" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_districts'</span>)</span>
<span id="cb175-31"><a href="#cb175-31" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_highways'</span>)</span>
<span id="cb175-32"><a href="#cb175-32" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb175-33"><a href="#cb175-33" tabindex="-1"></a></span>
<span id="cb175-34"><a href="#cb175-34" tabindex="-1"></a><span class="co"># Create the chart</span></span>
<span id="cb175-35"><a href="#cb175-35" tabindex="-1"></a>districts <span class="op">=</span> districts_gdf.DISTRICT.values</span>
<span id="cb175-36"><a href="#cb175-36" tabindex="-1"></a>district <span class="op">=</span> st.sidebar.selectbox(<span class="st">'Select a District'</span>, districts)</span>
<span id="cb175-37"><a href="#cb175-37" tabindex="-1"></a></span>
<span id="cb175-38"><a href="#cb175-38" tabindex="-1"></a>district_lengths <span class="op">=</span> lengths_df[lengths_df[<span class="st">'DISTRICT'</span>] <span class="op">==</span> district]</span>
<span id="cb175-39"><a href="#cb175-39" tabindex="-1"></a></span>
<span id="cb175-40"><a href="#cb175-40" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb175-41"><a href="#cb175-41" tabindex="-1"></a>district_lengths.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">'blue'</span>, <span class="st">'red'</span>],</span>
<span id="cb175-42"><a href="#cb175-42" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">'Kilometers'</span>, xlabel<span class="op">=</span><span class="st">'Category'</span>)</span>
<span id="cb175-43"><a href="#cb175-43" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb175-44"><a href="#cb175-44" tabindex="-1"></a>stats <span class="op">=</span> st.sidebar.pyplot(fig)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/mapping_dashboard3.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="4" style="list-style-type: decimal">
<li>Now we create a folium map using <code>leafmap.Map()</code> and
render the vector layers. We also add a third layer with the boundary of
the selected district to highlight the selection.</li>
</ol>
<div class="sourceCode" id="cb176"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb176-2"><a href="#cb176-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb176-3"><a href="#cb176-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb176-4"><a href="#cb176-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb176-5"><a href="#cb176-5" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb176-6"><a href="#cb176-6" tabindex="-1"></a></span>
<span id="cb176-7"><a href="#cb176-7" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">'Dashboard'</span>, layout<span class="op">=</span><span class="st">'wide'</span>)</span>
<span id="cb176-8"><a href="#cb176-8" tabindex="-1"></a></span>
<span id="cb176-9"><a href="#cb176-9" tabindex="-1"></a>st.title(<span class="st">'Highway Dashboard'</span>)</span>
<span id="cb176-10"><a href="#cb176-10" tabindex="-1"></a></span>
<span id="cb176-11"><a href="#cb176-11" tabindex="-1"></a>st.sidebar.title(<span class="st">'About'</span>)</span>
<span id="cb176-12"><a href="#cb176-12" tabindex="-1"></a>st.sidebar.info(<span class="st">'Explore the Highway Statistics'</span>)</span>
<span id="cb176-13"><a href="#cb176-13" tabindex="-1"></a></span>
<span id="cb176-14"><a href="#cb176-14" tabindex="-1"></a></span>
<span id="cb176-15"><a href="#cb176-15" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb176-16"><a href="#cb176-16" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">'karnataka.gpkg'</span></span>
<span id="cb176-17"><a href="#cb176-17" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb176-18"><a href="#cb176-18" tabindex="-1"></a></span>
<span id="cb176-19"><a href="#cb176-19" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb176-20"><a href="#cb176-20" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb176-21"><a href="#cb176-21" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb176-22"><a href="#cb176-22" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb176-23"><a href="#cb176-23" tabindex="-1"></a></span>
<span id="cb176-24"><a href="#cb176-24" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb176-25"><a href="#cb176-25" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb176-26"><a href="#cb176-26" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb176-27"><a href="#cb176-27" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb176-28"><a href="#cb176-28" tabindex="-1"></a></span>
<span id="cb176-29"><a href="#cb176-29" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb176-30"><a href="#cb176-30" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb176-31"><a href="#cb176-31" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_districts'</span>)</span>
<span id="cb176-32"><a href="#cb176-32" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_highways'</span>)</span>
<span id="cb176-33"><a href="#cb176-33" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb176-34"><a href="#cb176-34" tabindex="-1"></a></span>
<span id="cb176-35"><a href="#cb176-35" tabindex="-1"></a><span class="co"># Create the chart</span></span>
<span id="cb176-36"><a href="#cb176-36" tabindex="-1"></a>districts <span class="op">=</span> districts_gdf.DISTRICT.values</span>
<span id="cb176-37"><a href="#cb176-37" tabindex="-1"></a>district <span class="op">=</span> st.sidebar.selectbox(<span class="st">'Select a District'</span>, districts)</span>
<span id="cb176-38"><a href="#cb176-38" tabindex="-1"></a></span>
<span id="cb176-39"><a href="#cb176-39" tabindex="-1"></a>district_lengths <span class="op">=</span> lengths_df[lengths_df[<span class="st">'DISTRICT'</span>] <span class="op">==</span> district]</span>
<span id="cb176-40"><a href="#cb176-40" tabindex="-1"></a></span>
<span id="cb176-41"><a href="#cb176-41" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb176-42"><a href="#cb176-42" tabindex="-1"></a>district_lengths.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">'blue'</span>, <span class="st">'red'</span>],</span>
<span id="cb176-43"><a href="#cb176-43" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">'Kilometers'</span>, xlabel<span class="op">=</span><span class="st">'Category'</span>)</span>
<span id="cb176-44"><a href="#cb176-44" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb176-45"><a href="#cb176-45" tabindex="-1"></a>stats <span class="op">=</span> st.sidebar.pyplot(fig)</span>
<span id="cb176-46"><a href="#cb176-46" tabindex="-1"></a></span>
<span id="cb176-47"><a href="#cb176-47" tabindex="-1"></a><span class="co">## Create the map</span></span>
<span id="cb176-48"><a href="#cb176-48" tabindex="-1"></a></span>
<span id="cb176-49"><a href="#cb176-49" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(</span>
<span id="cb176-50"><a href="#cb176-50" tabindex="-1"></a>    layers_control<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb176-51"><a href="#cb176-51" tabindex="-1"></a>    draw_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb176-52"><a href="#cb176-52" tabindex="-1"></a>    measure_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb176-53"><a href="#cb176-53" tabindex="-1"></a>    fullscreen_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb176-54"><a href="#cb176-54" tabindex="-1"></a>)</span>
<span id="cb176-55"><a href="#cb176-55" tabindex="-1"></a>m.add_basemap(<span class="st">'CartoDB.DarkMatter'</span>)</span>
<span id="cb176-56"><a href="#cb176-56" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb176-57"><a href="#cb176-57" tabindex="-1"></a>    gdf<span class="op">=</span>districts_gdf,</span>
<span id="cb176-58"><a href="#cb176-58" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb176-59"><a href="#cb176-59" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">'districts'</span>,</span>
<span id="cb176-60"><a href="#cb176-60" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="st">'on_click'</span>,</span>
<span id="cb176-61"><a href="#cb176-61" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'#7fcdbb'</span>, <span class="st">'fillOpacity'</span>: <span class="fl">0.3</span>, <span class="st">'weight'</span>: <span class="fl">0.5</span>},</span>
<span id="cb176-62"><a href="#cb176-62" tabindex="-1"></a>    )</span>
<span id="cb176-63"><a href="#cb176-63" tabindex="-1"></a></span>
<span id="cb176-64"><a href="#cb176-64" tabindex="-1"></a></span>
<span id="cb176-65"><a href="#cb176-65" tabindex="-1"></a>selected_gdf <span class="op">=</span> districts_gdf[districts_gdf[<span class="st">'DISTRICT'</span>] <span class="op">==</span> district]</span>
<span id="cb176-66"><a href="#cb176-66" tabindex="-1"></a></span>
<span id="cb176-67"><a href="#cb176-67" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb176-68"><a href="#cb176-68" tabindex="-1"></a>    gdf<span class="op">=</span>selected_gdf,</span>
<span id="cb176-69"><a href="#cb176-69" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">'selected'</span>,</span>
<span id="cb176-70"><a href="#cb176-70" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb176-71"><a href="#cb176-71" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb176-72"><a href="#cb176-72" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'yellow'</span>, <span class="st">'fill'</span>: <span class="va">None</span>, <span class="st">'weight'</span>: <span class="dv">2</span>}</span>
<span id="cb176-73"><a href="#cb176-73" tabindex="-1"></a> )</span>
<span id="cb176-74"><a href="#cb176-74" tabindex="-1"></a></span>
<span id="cb176-75"><a href="#cb176-75" tabindex="-1"></a></span>
<span id="cb176-76"><a href="#cb176-76" tabindex="-1"></a>m_streamlit <span class="op">=</span> m.to_streamlit(<span class="dv">600</span>, <span class="dv">600</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/mapping_dashboard4.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="5" style="list-style-type: decimal">
<li>We can selectively load certain layers on the map using a user-input
widget. Let’s add a checkbox that allows the user to overlay the roads
on the map.</li>
</ol>
<div class="sourceCode" id="cb177"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb177-2"><a href="#cb177-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb177-3"><a href="#cb177-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb177-4"><a href="#cb177-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb177-5"><a href="#cb177-5" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb177-6"><a href="#cb177-6" tabindex="-1"></a></span>
<span id="cb177-7"><a href="#cb177-7" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">'Dashboard'</span>, layout<span class="op">=</span><span class="st">'wide'</span>)</span>
<span id="cb177-8"><a href="#cb177-8" tabindex="-1"></a></span>
<span id="cb177-9"><a href="#cb177-9" tabindex="-1"></a>st.title(<span class="st">'Highway Dashboard'</span>)</span>
<span id="cb177-10"><a href="#cb177-10" tabindex="-1"></a></span>
<span id="cb177-11"><a href="#cb177-11" tabindex="-1"></a>st.sidebar.title(<span class="st">'About'</span>)</span>
<span id="cb177-12"><a href="#cb177-12" tabindex="-1"></a>st.sidebar.info(<span class="st">'Explore the Highway Statistics'</span>)</span>
<span id="cb177-13"><a href="#cb177-13" tabindex="-1"></a></span>
<span id="cb177-14"><a href="#cb177-14" tabindex="-1"></a></span>
<span id="cb177-15"><a href="#cb177-15" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/'</span></span>
<span id="cb177-16"><a href="#cb177-16" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">'karnataka.gpkg'</span></span>
<span id="cb177-17"><a href="#cb177-17" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">'highway_lengths_by_district.csv'</span></span>
<span id="cb177-18"><a href="#cb177-18" tabindex="-1"></a></span>
<span id="cb177-19"><a href="#cb177-19" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb177-20"><a href="#cb177-20" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb177-21"><a href="#cb177-21" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb177-22"><a href="#cb177-22" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb177-23"><a href="#cb177-23" tabindex="-1"></a></span>
<span id="cb177-24"><a href="#cb177-24" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb177-25"><a href="#cb177-25" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb177-26"><a href="#cb177-26" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb177-27"><a href="#cb177-27" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb177-28"><a href="#cb177-28" tabindex="-1"></a></span>
<span id="cb177-29"><a href="#cb177-29" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb177-30"><a href="#cb177-30" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb177-31"><a href="#cb177-31" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_districts'</span>)</span>
<span id="cb177-32"><a href="#cb177-32" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">'karnataka_highways'</span>)</span>
<span id="cb177-33"><a href="#cb177-33" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb177-34"><a href="#cb177-34" tabindex="-1"></a></span>
<span id="cb177-35"><a href="#cb177-35" tabindex="-1"></a><span class="co"># Create the chart</span></span>
<span id="cb177-36"><a href="#cb177-36" tabindex="-1"></a>districts <span class="op">=</span> districts_gdf.DISTRICT.values</span>
<span id="cb177-37"><a href="#cb177-37" tabindex="-1"></a>district <span class="op">=</span> st.sidebar.selectbox(<span class="st">'Select a District'</span>, districts)</span>
<span id="cb177-38"><a href="#cb177-38" tabindex="-1"></a>overlay <span class="op">=</span> st.sidebar.checkbox(<span class="st">'Overlay roads'</span>)</span>
<span id="cb177-39"><a href="#cb177-39" tabindex="-1"></a>district_lengths <span class="op">=</span> lengths_df[lengths_df[<span class="st">'DISTRICT'</span>] <span class="op">==</span> district]</span>
<span id="cb177-40"><a href="#cb177-40" tabindex="-1"></a></span>
<span id="cb177-41"><a href="#cb177-41" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb177-42"><a href="#cb177-42" tabindex="-1"></a>district_lengths.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">'blue'</span>, <span class="st">'red'</span>],</span>
<span id="cb177-43"><a href="#cb177-43" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">'Kilometers'</span>, xlabel<span class="op">=</span><span class="st">'Category'</span>)</span>
<span id="cb177-44"><a href="#cb177-44" tabindex="-1"></a>ax.get_xaxis().set_ticklabels([])</span>
<span id="cb177-45"><a href="#cb177-45" tabindex="-1"></a>stats <span class="op">=</span> st.sidebar.pyplot(fig)</span>
<span id="cb177-46"><a href="#cb177-46" tabindex="-1"></a></span>
<span id="cb177-47"><a href="#cb177-47" tabindex="-1"></a><span class="co">## Create the map</span></span>
<span id="cb177-48"><a href="#cb177-48" tabindex="-1"></a></span>
<span id="cb177-49"><a href="#cb177-49" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(</span>
<span id="cb177-50"><a href="#cb177-50" tabindex="-1"></a>    layers_control<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb177-51"><a href="#cb177-51" tabindex="-1"></a>    draw_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb177-52"><a href="#cb177-52" tabindex="-1"></a>    measure_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb177-53"><a href="#cb177-53" tabindex="-1"></a>    fullscreen_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb177-54"><a href="#cb177-54" tabindex="-1"></a>)</span>
<span id="cb177-55"><a href="#cb177-55" tabindex="-1"></a>m.add_basemap(<span class="st">'CartoDB.DarkMatter'</span>)</span>
<span id="cb177-56"><a href="#cb177-56" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb177-57"><a href="#cb177-57" tabindex="-1"></a>    gdf<span class="op">=</span>districts_gdf,</span>
<span id="cb177-58"><a href="#cb177-58" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb177-59"><a href="#cb177-59" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">'districts'</span>,</span>
<span id="cb177-60"><a href="#cb177-60" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="st">'on_click'</span>,</span>
<span id="cb177-61"><a href="#cb177-61" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'#7fcdbb'</span>, <span class="st">'fillOpacity'</span>: <span class="fl">0.3</span>, <span class="st">'weight'</span>: <span class="fl">0.5</span>},</span>
<span id="cb177-62"><a href="#cb177-62" tabindex="-1"></a>    )</span>
<span id="cb177-63"><a href="#cb177-63" tabindex="-1"></a></span>
<span id="cb177-64"><a href="#cb177-64" tabindex="-1"></a><span class="cf">if</span> overlay:</span>
<span id="cb177-65"><a href="#cb177-65" tabindex="-1"></a>    m.add_gdf(</span>
<span id="cb177-66"><a href="#cb177-66" tabindex="-1"></a>        gdf<span class="op">=</span>roads_gdf,</span>
<span id="cb177-67"><a href="#cb177-67" tabindex="-1"></a>        zoom_to_layer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb177-68"><a href="#cb177-68" tabindex="-1"></a>        layer_name<span class="op">=</span><span class="st">'highways'</span>,</span>
<span id="cb177-69"><a href="#cb177-69" tabindex="-1"></a>        info_mode<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb177-70"><a href="#cb177-70" tabindex="-1"></a>        style<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'#225ea8'</span>, <span class="st">'weight'</span>: <span class="fl">1.5</span>},</span>
<span id="cb177-71"><a href="#cb177-71" tabindex="-1"></a>    )</span>
<span id="cb177-72"><a href="#cb177-72" tabindex="-1"></a>    </span>
<span id="cb177-73"><a href="#cb177-73" tabindex="-1"></a>selected_gdf <span class="op">=</span> districts_gdf[districts_gdf[<span class="st">'DISTRICT'</span>] <span class="op">==</span> district]</span>
<span id="cb177-74"><a href="#cb177-74" tabindex="-1"></a></span>
<span id="cb177-75"><a href="#cb177-75" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb177-76"><a href="#cb177-76" tabindex="-1"></a>    gdf<span class="op">=</span>selected_gdf,</span>
<span id="cb177-77"><a href="#cb177-77" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">'selected'</span>,</span>
<span id="cb177-78"><a href="#cb177-78" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb177-79"><a href="#cb177-79" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb177-80"><a href="#cb177-80" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'yellow'</span>, <span class="st">'fill'</span>: <span class="va">None</span>, <span class="st">'weight'</span>: <span class="dv">2</span>}</span>
<span id="cb177-81"><a href="#cb177-81" tabindex="-1"></a> )</span>
<span id="cb177-82"><a href="#cb177-82" tabindex="-1"></a></span>
<span id="cb177-83"><a href="#cb177-83" tabindex="-1"></a></span>
<span id="cb177-84"><a href="#cb177-84" tabindex="-1"></a>m_streamlit <span class="op">=</span> m.to_streamlit(<span class="dv">600</span>, <span class="dv">600</span>)</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/mapping_dashboard5.png" style="display: block; margin: auto;" width="75%"/></p>
</div>
</div>
<div class="section level1" id="publishing-apps-with-streamlit-cloud">
<h1>Publishing Apps with Streamlit Cloud</h1>
<p>Streamlit provides free hosting for your streamlit apps. In this
section, we will now learn how to deploy an app to Streamlit cloud and
configure it correctly.</p>
<div class="section level2" id="upload-the-app-to-github">
<h2>Upload the app to GitHub</h2>
<p>To run your app on Streamlit Cloud, you need to upload your app to
GitHub. Streamlit supports both private and public repositories. In this
example, we will be deploying a <em>Route Finder</em> app which has been
uploaded to GitHub at
<code>https://github.com/spatialthoughts/python-dataviz-web/blob/main/streamlit/route_finder/app.py</code></p>
</div>
<div class="section level2" id="add-app-dependencies">
<h2>Add App dependencies</h2>
<p>If your app needs a third-party Python package, you need to add it in
a separate file called <code>requirements.txt</code>. The packages
listed in the file will be installed on Streamlit Cloud before running
the app.</p>
<p>For our app, we have created the <code>requirements.txt</code> file
with the following content and uploaded it to GitHub in the same
directory as the <code>app.py</code></p>
<pre><code>streamlit
folium
streamlit-folium</code></pre>
<p>You may also specify other dependencies for your app. Learn more at
<a href="https://docs.streamlit.io/streamlit-cloud/get-started/deploy-an-app/app-dependencies">App
dependencies</a> documentation.</p>
</div>
<div class="section level2" id="replace-sensitive-data-with-secrets">
<h2>Replace Sensitive Data with Secrets</h2>
<p>It is not a good practice to store API keys or passwords in the code
as it can be seen by others and can be misused. Streamlit provides an
easy way for <a href="https://docs.streamlit.io/streamlit-cloud/get-started/deploy-an-app/connect-to-data-sources/secrets-management">Secrets
Management</a>. You can store any key=value pairs in a separate location
and access it in the app using <code>st.secrets</code>.</p>
<p>While doing local development, you create a folder named
<code>.streamlit</code> in the app directory and store any key=value
pairs in a file named <code>secrets.toml</code>. For example, if you
want to store the ORS API Key, you can create a new file
<code>secrets.toml</code> in the <code>.streamlit</code> directory with
the following content. (Replace <code>&lt;your api key&gt;</code> with
the actual key)</p>
<pre><code>'ORS_API_KEY' = '&lt;your api key&gt;'</code></pre>
<p>Once done, the value of the ORS_API_KEY can be retrieved in the
streamlit app using <code>st.secrets['ORS_API_KEY']</code>. While
deploying the app, you can configure your secrets as outlined in the
next section.</p>
</div>
<div class="section level2" id="deploy-your-app">
<h2>Deploy your App</h2>
<p>Now you are ready to deploy your app to Streamlit Cloud.</p>
<ol style="list-style-type: decimal">
<li>Visit <a href="https://streamlit.io/cloud">Streamlit Cloud</a> and
sign-in. If you do not have an account, you can click <em>Sign-up</em>
and create a new account. Once logged-in, click the <em>New app</em>
button.</li>
</ol>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/cloud1.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="2" style="list-style-type: decimal">
<li>Click <em>Paste GitHub URL</em> and paste the URL to your streamlit
<code>app.py</code> file. For this example, you may use for the Route
Finder app. Next, click <em>Advanced settings…</em></li>
</ol>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/cloud2.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="3" style="list-style-type: decimal">
<li>This dialog allows you to store your private information required by
your apps, such as API keys, username/password for your database, etc.
For the <strong>Route Finder</strong> app, you need to enter the API Key
for OpenRouteService. Visit <a href="https://openrouteservice.org/dev/#/signup">OpenRouteService
Dashboard</a> and copy your API Key. Enter your API key in the following
format and replace <your key=""> with your actual API key. Click
<em>Save</em>.</your></li>
</ol>
<pre><code>'ORS_API_KEY' = '&lt;your key&gt;'</code></pre>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/cloud3.png" style="display: block; margin: auto;" width="50%"/></p>
<ol start="4" style="list-style-type: decimal">
<li>You are now ready to deploy the app. Click <em>Deploy!</em>.</li>
</ol>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/cloud4.png" style="display: block; margin: auto;" width="75%"/></p>
<ol start="5" style="list-style-type: decimal">
<li>Your app will now be deployed and will be accessible via the
provided URL. You can visit your Dashboard to manage the app once it is
deployed.</li>
</ol>
<p><img src="https://courses.spatialthoughts.com/images/python_dataviz/cloud5.png" style="display: block; margin: auto;" width="75%"/></p>
<p>The app is now live! Visit the <a href="https://spatialthoughts-python-dataviz--streamlitroute-finderapp-gqzg4q.streamlitapp.com/">Route
Finder</a> app to see it in action.</p>
</div>
</div>
<div class="section level1" id="supplement">
<h1>Supplement</h1>
<div class="section level2" id="contextily">
<h2>Contextily</h2>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_contextily.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level3" id="creating-an-artistic-rendering-of-a-city">
<h3>Creating an Artistic Rendering of a City</h3>
<p>Contextily provides an easy way to render tiles for a location using
the OpenStreetMap’s Nominatim API. Any location name from OpenStreetMap
can be geocoded and displayed using the <a href="https://contextily.readthedocs.io/en/latest/places_guide.html">Contextily
Place API</a>.</p>
<p>We can use it to quickly create a high-resolution rendering of any
city using any supported basemap with exact dimensions.</p>
<div class="section level4" id="setup-2">
<h4>Setup</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb181-2"><a href="#cb181-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb181-3"><a href="#cb181-3" tabindex="-1"></a>  <span class="op">!</span>pip install contextily</span></code></pre></div>
<div class="sourceCode" id="cb182"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb182-2"><a href="#cb182-2" tabindex="-1"></a><span class="im">from</span> contextily <span class="im">import</span> Place</span>
<span id="cb182-3"><a href="#cb182-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb182-4"><a href="#cb182-4" tabindex="-1"></a><span class="im">import</span> os</span></code></pre></div>
<div class="sourceCode" id="cb183"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb183-2"><a href="#cb183-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb183-3"><a href="#cb183-3" tabindex="-1"></a></span>
<span id="cb183-4"><a href="#cb183-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb183-5"><a href="#cb183-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb183-6"><a href="#cb183-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb183-7"><a href="#cb183-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div class="section level4" id="procedure">
<h4>Procedure</h4>
<p>Replace the <code>place_name</code> below with the name of your
chosen city, region or neighborhood and run it to query for its
coordinates and bounding box for OpenStreetMap. If your query fails, you
can visit <a href="https://www.openstreetmap.org/">OpenStreetMap</a> and
search for it to find the exact spelling of the place.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" tabindex="-1"></a>place_name <span class="op">=</span> <span class="st">'Bangalore'</span></span>
<span id="cb184-2"><a href="#cb184-2" tabindex="-1"></a>place <span class="op">=</span> Place(place_name, zoom<span class="op">=</span><span class="dv">13</span>)</span></code></pre></div>
<div class="sourceCode" id="cb185"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb185-2"><a href="#cb185-2" tabindex="-1"></a>place.plot(ax<span class="op">=</span>ax)</span>
<span id="cb185-3"><a href="#cb185-3" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb185-4"><a href="#cb185-4" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb185-5"><a href="#cb185-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>You can choose from over 200 basemap styles created by different
providers. Check the available styles using
<code>contextily.providers</code>.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" tabindex="-1"></a>providers <span class="op">=</span> cx.providers</span>
<span id="cb186-2"><a href="#cb186-2" tabindex="-1"></a>providers</span></code></pre></div>
<p>Let’s try the <code>Stamen.Toner</code> style. Some basemaps are
available only upto a certain zoom level. If you get an error adjust the
zoom level as well.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" tabindex="-1"></a>source <span class="op">=</span> cx.providers.Stamen.Toner</span>
<span id="cb187-2"><a href="#cb187-2" tabindex="-1"></a>zoom <span class="op">=</span> <span class="dv">13</span></span></code></pre></div>
<div class="sourceCode" id="cb188"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" tabindex="-1"></a>place <span class="op">=</span> Place(place_name, zoom<span class="op">=</span>zoom, source<span class="op">=</span>source)</span>
<span id="cb188-2"><a href="#cb188-2" tabindex="-1"></a></span>
<span id="cb188-3"><a href="#cb188-3" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb188-4"><a href="#cb188-4" tabindex="-1"></a>place.plot(ax<span class="op">=</span>ax)</span>
<span id="cb188-5"><a href="#cb188-5" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb188-6"><a href="#cb188-6" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb188-7"><a href="#cb188-7" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>The Place API returns the rendering of the city based on its boundng
box.</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" tabindex="-1"></a>place <span class="op">=</span> Place(place_name)</span>
<span id="cb189-2"><a href="#cb189-2" tabindex="-1"></a>x_min, x_max, y_min, y_max <span class="op">=</span> place.bbox_map</span>
<span id="cb189-3"><a href="#cb189-3" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Original BBOX'</span>, x_min, x_max, y_min, y_max)</span></code></pre></div>
<p>If we wanted to create a rendering for exact dimensions, we have to
adjust the default bounding box. Here we want to create a rendering that
will fit exactly to the chosen paper size. We compute the required ratio
and adjust the bounds so the resulting ratio matches our paper size.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" tabindex="-1"></a><span class="co"># Here we are using A4 paper size in Landscape orientation</span></span>
<span id="cb190-2"><a href="#cb190-2" tabindex="-1"></a><span class="co"># Swap width and height for Portrait orientation</span></span>
<span id="cb190-3"><a href="#cb190-3" tabindex="-1"></a><span class="co"># or choose any other dimensions</span></span>
<span id="cb190-4"><a href="#cb190-4" tabindex="-1"></a>paper_width <span class="op">=</span> <span class="fl">11.69</span></span>
<span id="cb190-5"><a href="#cb190-5" tabindex="-1"></a>paper_height <span class="op">=</span> <span class="fl">8.27</span></span>
<span id="cb190-6"><a href="#cb190-6" tabindex="-1"></a></span>
<span id="cb190-7"><a href="#cb190-7" tabindex="-1"></a>ratio <span class="op">=</span> paper_width<span class="op">/</span>paper_height</span>
<span id="cb190-8"><a href="#cb190-8" tabindex="-1"></a></span>
<span id="cb190-9"><a href="#cb190-9" tabindex="-1"></a>x_size <span class="op">=</span> x_max <span class="op">-</span> x_min</span>
<span id="cb190-10"><a href="#cb190-10" tabindex="-1"></a>y_size <span class="op">=</span> y_max <span class="op">-</span> y_min</span>
<span id="cb190-11"><a href="#cb190-11" tabindex="-1"></a></span>
<span id="cb190-12"><a href="#cb190-12" tabindex="-1"></a><span class="cf">if</span> ratio <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb190-13"><a href="#cb190-13" tabindex="-1"></a>  <span class="co"># adjust width</span></span>
<span id="cb190-14"><a href="#cb190-14" tabindex="-1"></a>  x_size_required <span class="op">=</span> ratio<span class="op">*</span>(y_max <span class="op">-</span> y_min)</span>
<span id="cb190-15"><a href="#cb190-15" tabindex="-1"></a>  difference <span class="op">=</span>  x_size_required <span class="op">-</span> x_size</span>
<span id="cb190-16"><a href="#cb190-16" tabindex="-1"></a>  x_min <span class="op">=</span> x_min <span class="op">-</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb190-17"><a href="#cb190-17" tabindex="-1"></a>  x_max <span class="op">=</span> x_max <span class="op">+</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb190-18"><a href="#cb190-18" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb190-19"><a href="#cb190-19" tabindex="-1"></a>  <span class="co"># adjust height</span></span>
<span id="cb190-20"><a href="#cb190-20" tabindex="-1"></a>  y_size_required <span class="op">=</span> ratio<span class="op">*</span>(x_max <span class="op">-</span> x_min)</span>
<span id="cb190-21"><a href="#cb190-21" tabindex="-1"></a>  difference <span class="op">=</span>  y_size_required <span class="op">-</span> y_size</span>
<span id="cb190-22"><a href="#cb190-22" tabindex="-1"></a>  y_min <span class="op">=</span> y_min <span class="op">-</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb190-23"><a href="#cb190-23" tabindex="-1"></a>  y_max <span class="op">=</span> y_max <span class="op">+</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb190-24"><a href="#cb190-24" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Adjusted BBOX'</span>, x_min, x_max, y_min, y_max)</span></code></pre></div>
<p>Now we have the bounding box cooridnates, we can use the
<code>bounds2img</code> method to fetch the tiles and create a map. The
final rendering is saved as a PNG file in the Colab localstorage. You
can open the <strong>Files</strong> tab from the left-hand panel in
Colab and browse to the output folder. Locate the
<code>basemap.png</code> file and click the <strong>⋮</strong> button
and select Download to download the file locally.</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb191-2"><a href="#cb191-2" tabindex="-1"></a>fig.set_size_inches(paper_width, paper_height)</span>
<span id="cb191-3"><a href="#cb191-3" tabindex="-1"></a></span>
<span id="cb191-4"><a href="#cb191-4" tabindex="-1"></a>basemap, extent <span class="op">=</span> cx.bounds2img(x_min, y_min, x_max, y_max, zoom<span class="op">=</span>zoom, source<span class="op">=</span>source)</span>
<span id="cb191-5"><a href="#cb191-5" tabindex="-1"></a>ax.imshow(basemap, extent<span class="op">=</span>extent)</span>
<span id="cb191-6"><a href="#cb191-6" tabindex="-1"></a></span>
<span id="cb191-7"><a href="#cb191-7" tabindex="-1"></a>ax.set_xlim(x_min, x_max)</span>
<span id="cb191-8"><a href="#cb191-8" tabindex="-1"></a>ax.set_ylim(y_min, y_max)</span>
<span id="cb191-9"><a href="#cb191-9" tabindex="-1"></a></span>
<span id="cb191-10"><a href="#cb191-10" tabindex="-1"></a>ax.set_xticks([])</span>
<span id="cb191-11"><a href="#cb191-11" tabindex="-1"></a>ax.set_yticks([])</span>
<span id="cb191-12"><a href="#cb191-12" tabindex="-1"></a></span>
<span id="cb191-13"><a href="#cb191-13" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb191-14"><a href="#cb191-14" tabindex="-1"></a></span>
<span id="cb191-15"><a href="#cb191-15" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">'basemap.png'</span></span>
<span id="cb191-16"><a href="#cb191-16" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb191-17"><a href="#cb191-17" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>, pad<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb191-18"><a href="#cb191-18" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/supplement_contextily_files/supplement_contextily_19_0.png"/></p>
</div>
</div>
</div>
<div class="section level2" id="advanced-plotting">
<h2>Advanced Plotting</h2>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_elevation_profile_plot.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level3" id="elevation-profile-plot-from-a-gps-track">
<h3>Elevation Profile Plot from a GPS Track</h3>
<p>We will take a GPS track recorded from Strava app and create an
elevation profile plot.</p>
<div class="section level4" id="setup-and-data-download-8">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb192-2"><a href="#cb192-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb192-3"><a href="#cb192-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb192-4"><a href="#cb192-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree mapclassify</span>
<span id="cb192-5"><a href="#cb192-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span></code></pre></div>
<div class="sourceCode" id="cb193"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb193-2"><a href="#cb193-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb193-3"><a href="#cb193-3" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb193-4"><a href="#cb193-4" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb193-5"><a href="#cb193-5" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code></pre></div>
<div class="sourceCode" id="cb194"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb194-2"><a href="#cb194-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb194-3"><a href="#cb194-3" tabindex="-1"></a></span>
<span id="cb194-4"><a href="#cb194-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb194-5"><a href="#cb194-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb194-6"><a href="#cb194-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb194-7"><a href="#cb194-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb195"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb195-2"><a href="#cb195-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb195-3"><a href="#cb195-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb195-4"><a href="#cb195-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb195-5"><a href="#cb195-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb195-6"><a href="#cb195-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span></code></pre></div>
<div class="sourceCode" id="cb196"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'summit.gpx'</span></span>
<span id="cb196-2"><a href="#cb196-2" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/gps/'</span></span>
<span id="cb196-3"><a href="#cb196-3" tabindex="-1"></a></span>
<span id="cb196-4"><a href="#cb196-4" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div class="section level4" id="data-pre-processing-4">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb197"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" tabindex="-1"></a>gpx_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb197-2"><a href="#cb197-2" tabindex="-1"></a><span class="co"># GPX files contain many layers. Read the 'track_points' layer</span></span>
<span id="cb197-3"><a href="#cb197-3" tabindex="-1"></a>gdf <span class="op">=</span> gpd.read_file(gpx_path, layer<span class="op">=</span><span class="st">'track_points'</span>)</span>
<span id="cb197-4"><a href="#cb197-4" tabindex="-1"></a>gdf <span class="op">=</span> gdf[[<span class="st">'track_fid'</span>,<span class="st">'ele'</span>, <span class="st">'time'</span>, <span class="st">'geometry'</span>]]</span>
<span id="cb197-5"><a href="#cb197-5" tabindex="-1"></a>gdf</span></code></pre></div>
<p>Let’s use the timestamp contained in the ‘time’ column as the index.
This will allow us to filter and plot the time-series data easily. We
must first convert the time column to datetime type with an appropriate
timezone.</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" tabindex="-1"></a>gdf[<span class="st">'time'</span>] <span class="op">=</span> pd.to_datetime(gdf[<span class="st">'time'</span>])</span>
<span id="cb198-2"><a href="#cb198-2" tabindex="-1"></a>gdf <span class="op">=</span> gdf.set_index(<span class="st">'time'</span>)</span>
<span id="cb198-3"><a href="#cb198-3" tabindex="-1"></a>gdf.index <span class="op">=</span> gdf.index.tz_convert(<span class="st">'Asia/Kolkata'</span>)</span>
<span id="cb198-4"><a href="#cb198-4" tabindex="-1"></a>gdf</span></code></pre></div>
<p>Using time as index allows us to filter the data as follows</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" tabindex="-1"></a>gdf_subset <span class="op">=</span> gdf[<span class="st">'2022-04-04T06:15:00'</span>:<span class="st">'2022-04-04T10:45:00'</span>]</span>
<span id="cb199-2"><a href="#cb199-2" tabindex="-1"></a>gdf_subset</span></code></pre></div>
<p>We can now plot the elevation against the timestamp using Matplotlib.
Since we have a large number of timestamps, we can use
<code>set_major_locator()</code> to define what labels will be present
on the axis.</p>
<p>Since our timestamps are timezone aware, we can also plot a timezone
name (i.e. IST) along with the label.</p>
<p>We can also use a different style for our plot. You can run
<code>plt.style.available</code> to see all available styles.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" tabindex="-1"></a>plt.style.use(<span class="st">'ggplot'</span>)</span></code></pre></div>
<div class="sourceCode" id="cb201"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb201-2"><a href="#cb201-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb201-3"><a href="#cb201-3" tabindex="-1"></a>gdf_subset[<span class="st">'ele'</span>].plot(kind<span class="op">=</span><span class="st">'line'</span>, ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'#2b8cbe'</span>)</span>
<span id="cb201-4"><a href="#cb201-4" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb201-5"><a href="#cb201-5" tabindex="-1"></a>plt.title(<span class="st">'Elevation Profile'</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb201-6"><a href="#cb201-6" tabindex="-1"></a>plt.ylabel(<span class="st">'Elevation (meters)'</span>, size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb201-7"><a href="#cb201-7" tabindex="-1"></a>plt.xlabel(<span class="va">None</span>)</span>
<span id="cb201-8"><a href="#cb201-8" tabindex="-1"></a><span class="co"># Show a tick every 30 minute</span></span>
<span id="cb201-9"><a href="#cb201-9" tabindex="-1"></a>xlocator <span class="op">=</span> mdates.MinuteLocator(interval<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb201-10"><a href="#cb201-10" tabindex="-1"></a></span>
<span id="cb201-11"><a href="#cb201-11" tabindex="-1"></a>xformat <span class="op">=</span> mdates.DateFormatter(<span class="st">'%H:%M %Z'</span>, tz<span class="op">=</span>gdf.index.tz)  <span class="co"># adds some extra formatting, but not required</span></span>
<span id="cb201-12"><a href="#cb201-12" tabindex="-1"></a></span>
<span id="cb201-13"><a href="#cb201-13" tabindex="-1"></a>ax.xaxis.set_major_locator(xlocator)</span>
<span id="cb201-14"><a href="#cb201-14" tabindex="-1"></a>ax.xaxis.set_major_formatter(xformat)</span>
<span id="cb201-15"><a href="#cb201-15" tabindex="-1"></a>ax.set_ylim([<span class="dv">3200</span>, <span class="dv">3700</span>])</span>
<span id="cb201-16"><a href="#cb201-16" tabindex="-1"></a>ax.fill_between(gdf.index, gdf[<span class="st">'ele'</span>].values, color<span class="op">=</span><span class="st">'grey'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb201-17"><a href="#cb201-17" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/supplement_elevation_profile_plot_files/supplement_elevation_profile_plot_16_0.png"/></p>
<div class="sourceCode" id="cb202"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" tabindex="-1"></a>plt.style.use(<span class="st">'default'</span>)</span></code></pre></div>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_stacked_barcharts.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
</div>
</div>
<div class="section level3" id="creating-a-stacked-bar-chart">
<h3>Creating A Stacked Bar Chart</h3>
<p>This example shows how to create a stacked chart with information
about crime type in each bar. This visualization can plot 2 variables in
a single plot.</p>
<div class="section level4" id="setup-and-data-download-9">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb203-2"><a href="#cb203-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb203-3"><a href="#cb203-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb204"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb204-2"><a href="#cb204-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb204-3"><a href="#cb204-3" tabindex="-1"></a></span>
<span id="cb204-4"><a href="#cb204-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb204-5"><a href="#cb204-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb204-6"><a href="#cb204-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb204-7"><a href="#cb204-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb205"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb205-2"><a href="#cb205-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb205-3"><a href="#cb205-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb205-4"><a href="#cb205-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb205-5"><a href="#cb205-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb205-6"><a href="#cb205-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span></code></pre></div>
<p>We have 12 different CSV files containing crime data for each month
of 2020. We download each of them to the data folder.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" tabindex="-1"></a>files <span class="op">=</span> [</span>
<span id="cb206-2"><a href="#cb206-2" tabindex="-1"></a>  <span class="st">'2020-01-metropolitan-street.csv'</span>,</span>
<span id="cb206-3"><a href="#cb206-3" tabindex="-1"></a>  <span class="st">'2020-02-metropolitan-street.csv'</span>,</span>
<span id="cb206-4"><a href="#cb206-4" tabindex="-1"></a>  <span class="st">'2020-03-metropolitan-street.csv'</span>,</span>
<span id="cb206-5"><a href="#cb206-5" tabindex="-1"></a>  <span class="st">'2020-04-metropolitan-street.csv'</span>,</span>
<span id="cb206-6"><a href="#cb206-6" tabindex="-1"></a>  <span class="st">'2020-05-metropolitan-street.csv'</span>,</span>
<span id="cb206-7"><a href="#cb206-7" tabindex="-1"></a>  <span class="st">'2020-06-metropolitan-street.csv'</span>,</span>
<span id="cb206-8"><a href="#cb206-8" tabindex="-1"></a>  <span class="st">'2020-07-metropolitan-street.csv'</span>,</span>
<span id="cb206-9"><a href="#cb206-9" tabindex="-1"></a>  <span class="st">'2020-08-metropolitan-street.csv'</span>,</span>
<span id="cb206-10"><a href="#cb206-10" tabindex="-1"></a>  <span class="st">'2020-09-metropolitan-street.csv'</span>,</span>
<span id="cb206-11"><a href="#cb206-11" tabindex="-1"></a>  <span class="st">'2020-10-metropolitan-street.csv'</span>,</span>
<span id="cb206-12"><a href="#cb206-12" tabindex="-1"></a>  <span class="st">'2020-11-metropolitan-street.csv'</span>,</span>
<span id="cb206-13"><a href="#cb206-13" tabindex="-1"></a>  <span class="st">'2020-12-metropolitan-street.csv'</span></span>
<span id="cb206-14"><a href="#cb206-14" tabindex="-1"></a>]</span>
<span id="cb206-15"><a href="#cb206-15" tabindex="-1"></a></span>
<span id="cb206-16"><a href="#cb206-16" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/crime/'</span></span>
<span id="cb206-17"><a href="#cb206-17" tabindex="-1"></a></span>
<span id="cb206-18"><a href="#cb206-18" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb206-19"><a href="#cb206-19" tabindex="-1"></a>  url <span class="op">=</span> os.path.join(data_url <span class="op">+</span> f)</span>
<span id="cb206-20"><a href="#cb206-20" tabindex="-1"></a>  download(url)</span></code></pre></div>
</div>
<div class="section level4" id="data-pre-processing-5">
<h4>Data Pre-Processing</h4>
<p>It will be helpful to merge all 12 CSV files into a single dataframe.
We can use <code>pd.concat()</code> to merge a list of dataframes.</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" tabindex="-1"></a>dataframe_list <span class="op">=</span> []</span>
<span id="cb207-2"><a href="#cb207-2" tabindex="-1"></a></span>
<span id="cb207-3"><a href="#cb207-3" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb207-4"><a href="#cb207-4" tabindex="-1"></a>    filepath <span class="op">=</span> os.path.join(data_folder, f)</span>
<span id="cb207-5"><a href="#cb207-5" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb207-6"><a href="#cb207-6" tabindex="-1"></a>    dataframe_list.append(df)</span>
<span id="cb207-7"><a href="#cb207-7" tabindex="-1"></a></span>
<span id="cb207-8"><a href="#cb207-8" tabindex="-1"></a>merged_df <span class="op">=</span> pd.concat(dataframe_list)</span></code></pre></div>
<div class="sourceCode" id="cb208"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" tabindex="-1"></a>counts_by_type <span class="op">=</span> merged_df.groupby([<span class="st">'Month'</span>, <span class="st">'Crime type'</span>]).size()</span>
<span id="cb208-2"><a href="#cb208-2" tabindex="-1"></a>counts_by_type</span></code></pre></div>
<p>The result is not in a suitable format for plotting. We call
<code>unstack()</code> to create a dataframe.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" tabindex="-1"></a>counts_df <span class="op">=</span> counts_by_type.unstack()</span>
<span id="cb209-2"><a href="#cb209-2" tabindex="-1"></a>counts_df</span></code></pre></div>
</div>
<div class="section level4" id="creating-a-chart">
<h4>Creating a Chart</h4>
<p>Now we can create the stacked bar chart. Instead of the default
legend, we create a horizontal legend with a frame using the
<code>legend()</code> function.</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb210-2"><a href="#cb210-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb210-3"><a href="#cb210-3" tabindex="-1"></a>counts_df.plot(kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax, colormap<span class="op">=</span><span class="st">'tab20'</span>)</span>
<span id="cb210-4"><a href="#cb210-4" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'upper center'</span>, ncol<span class="op">=</span><span class="dv">5</span>, frameon<span class="op">=</span><span class="va">True</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.5</span>, <span class="fl">1.1</span>), fancybox<span class="op">=</span><span class="va">True</span>, shadow<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb210-5"><a href="#cb210-5" tabindex="-1"></a>ax.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb210-6"><a href="#cb210-6" tabindex="-1"></a>ax.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb210-7"><a href="#cb210-7" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Year'</span>, size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb210-8"><a href="#cb210-8" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Number of Incidents'</span>, size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb210-9"><a href="#cb210-9" tabindex="-1"></a>ax.set_title(<span class="st">'Crime in London (2020)'</span>, size <span class="op">=</span> <span class="dv">18</span>, y<span class="op">=</span><span class="fl">1.1</span>)</span>
<span id="cb210-10"><a href="#cb210-10" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb210-11"><a href="#cb210-11" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'stacked_chart.jpg'</span>)</span>
<span id="cb210-12"><a href="#cb210-12" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb210-13"><a href="#cb210-13" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/supplement_stacked_barcharts_files/supplement_stacked_barcharts_15_0.png"/></p>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_labeling_features.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
</div>
</div>
<div class="section level3" id="labeling-features">
<h3>Labeling Features</h3>
<p>This example shows how to add labels to vector layer features using
Matplotlib. We will take a polygon layer of districts and add an
annotation to show the district name at the centroid of each
polygon.</p>
<div class="section level4" id="setup-and-data-download-10">
<h4>Setup and Data Download</h4>
<div class="sourceCode" id="cb211"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb211-2"><a href="#cb211-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb211-3"><a href="#cb211-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb211-4"><a href="#cb211-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree mapclassify</span>
<span id="cb211-5"><a href="#cb211-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span></code></pre></div>
<div class="sourceCode" id="cb212"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb212-2"><a href="#cb212-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb212-3"><a href="#cb212-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb213"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb213-2"><a href="#cb213-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb213-3"><a href="#cb213-3" tabindex="-1"></a></span>
<span id="cb213-4"><a href="#cb213-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb213-5"><a href="#cb213-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb213-6"><a href="#cb213-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb213-7"><a href="#cb213-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb214"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb214-2"><a href="#cb214-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb214-3"><a href="#cb214-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb214-4"><a href="#cb214-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb214-5"><a href="#cb214-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb214-6"><a href="#cb214-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb214-7"><a href="#cb214-7" tabindex="-1"></a></span>
<span id="cb214-8"><a href="#cb214-8" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'karnataka.gpkg'</span></span>
<span id="cb214-9"><a href="#cb214-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/osm/'</span></span>
<span id="cb214-10"><a href="#cb214-10" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
<pre><code>Downloaded data/karnataka.gpkg</code></pre>
</div>
<div class="section level4" id="data-pre-processing-6">
<h4>Data Pre-Processing</h4>
<p>We read the <code>districts</code> layer from the input geopackage
using GeoPandas.</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" tabindex="-1"></a>path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb216-2"><a href="#cb216-2" tabindex="-1"></a>districts_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">'karnataka_districts'</span>)</span></code></pre></div>
<p>Let’s say we want to add a label for each of the distrit polygons.
First, we need to decide the anchor position of the label. We can use
<code>representative_point()</code> to get a point inside each polygon
that best represents the geometry. It is similar to a centroid, but is
guranteed to be inside the polygon. Below code creates a new field in
the GeoDataFrame called <code>label_position</code> with the coordinates
of the anchor point.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" tabindex="-1"></a><span class="kw">def</span> get_label_position(row):</span>
<span id="cb217-2"><a href="#cb217-2" tabindex="-1"></a>  geometry <span class="op">=</span> row[<span class="st">'geometry'</span>]</span>
<span id="cb217-3"><a href="#cb217-3" tabindex="-1"></a>  location <span class="op">=</span> geometry.representative_point()</span>
<span id="cb217-4"><a href="#cb217-4" tabindex="-1"></a>  <span class="co"># We need the location as a tuple of x,y coordinates</span></span>
<span id="cb217-5"><a href="#cb217-5" tabindex="-1"></a>  location_coords <span class="op">=</span> location.coords[<span class="dv">0</span>]</span>
<span id="cb217-6"><a href="#cb217-6" tabindex="-1"></a>  <span class="cf">return</span> location_coords</span>
<span id="cb217-7"><a href="#cb217-7" tabindex="-1"></a></span>
<span id="cb217-8"><a href="#cb217-8" tabindex="-1"></a>districts_gdf[<span class="st">'label_position'</span>] <span class="op">=</span> districts_gdf.<span class="bu">apply</span>(get_label_position, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb217-9"><a href="#cb217-9" tabindex="-1"></a>districts_gdf</span></code></pre></div>
</div>
<div class="section level4" id="annotating-labels">
<h4>Annotating Labels</h4>
<p>We can now plot the districts and add an annotation for each polygon.
We iterate over each row of the GeoDataFrame and add the annotation with
name of the district at its centroid coordinates using
<code>annotate()</code> function.</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb218-2"><a href="#cb218-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">15</span>)</span>
<span id="cb218-3"><a href="#cb218-3" tabindex="-1"></a>districts_gdf.plot(ax<span class="op">=</span>ax, linewidth<span class="op">=</span><span class="dv">1</span>, facecolor<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'#252525'</span>)</span>
<span id="cb218-4"><a href="#cb218-4" tabindex="-1"></a></span>
<span id="cb218-5"><a href="#cb218-5" tabindex="-1"></a></span>
<span id="cb218-6"><a href="#cb218-6" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> districts_gdf.iterrows():</span>
<span id="cb218-7"><a href="#cb218-7" tabindex="-1"></a>   ax.annotate(text<span class="op">=</span>row[<span class="st">'DISTRICT'</span>], xy<span class="op">=</span>row[<span class="st">'label_position'</span>], horizontalalignment<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb218-8"><a href="#cb218-8" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb218-9"><a href="#cb218-9" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb218-10"><a href="#cb218-10" tabindex="-1"></a>plt.show()</span>
<span id="cb218-11"><a href="#cb218-11" tabindex="-1"></a></span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/supplement_labeling_features_files/supplement_labeling_features_13_0.png"/></p>
<div class="sourceCode" id="cb219"><pre class="sourceCode python"><code class="sourceCode python"></code></pre></div>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_ndvi_time_series.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
</div>
</div>
<div class="section level3" id="creating-time-series-charts">
<h3>Creating Time-Series Charts</h3>
<div class="sourceCode" id="cb220"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb220-2"><a href="#cb220-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb220-3"><a href="#cb220-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb220-4"><a href="#cb220-4" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span></code></pre></div>
<div class="sourceCode" id="cb221"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb221-2"><a href="#cb221-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb221-3"><a href="#cb221-3" tabindex="-1"></a></span>
<span id="cb221-4"><a href="#cb221-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb221-5"><a href="#cb221-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb221-6"><a href="#cb221-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb221-7"><a href="#cb221-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb222"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb222-2"><a href="#cb222-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb222-3"><a href="#cb222-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb222-4"><a href="#cb222-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb222-5"><a href="#cb222-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb222-6"><a href="#cb222-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb222-7"><a href="#cb222-7" tabindex="-1"></a>        </span>
<span id="cb222-8"><a href="#cb222-8" tabindex="-1"></a></span>
<span id="cb222-9"><a href="#cb222-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/misc/'</span></span>
<span id="cb222-10"><a href="#cb222-10" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'ndvi_data.xlsx'</span></span>
<span id="cb222-11"><a href="#cb222-11" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
<div class="section level4" id="data-pre-processing-7">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb223"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" tabindex="-1"></a>filepath <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb223-2"><a href="#cb223-2" tabindex="-1"></a>df <span class="op">=</span> pd.read_excel(filepath)</span>
<span id="cb223-3"><a href="#cb223-3" tabindex="-1"></a>df</span></code></pre></div>
<p>We set the ‘Date’ column as the index of the dateframe. This will
allow us to filter and plot the time-series data easily.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" tabindex="-1"></a>df <span class="op">=</span> df.set_index(pd.to_datetime(df[<span class="st">'Date'</span>]))</span>
<span id="cb224-2"><a href="#cb224-2" tabindex="-1"></a>df</span></code></pre></div>
<p>Create a chart with time-series of values in the ‘NDVI’ column. We
use <code>mdates</code> module to control the tick-marks on X-Axis.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb225-2"><a href="#cb225-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb225-3"><a href="#cb225-3" tabindex="-1"></a>df.plot(y<span class="op">=</span><span class="st">'NDVI'</span>, kind<span class="op">=</span><span class="st">'line'</span>, ax<span class="op">=</span>ax,</span>
<span id="cb225-4"><a href="#cb225-4" tabindex="-1"></a>        marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'#238b45'</span>,</span>
<span id="cb225-5"><a href="#cb225-5" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'Original NDVI'</span>)</span>
<span id="cb225-6"><a href="#cb225-6" tabindex="-1"></a></span>
<span id="cb225-7"><a href="#cb225-7" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">6</span>))</span>
<span id="cb225-8"><a href="#cb225-8" tabindex="-1"></a>ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">"%Y-%m"</span>))</span>
<span id="cb225-9"><a href="#cb225-9" tabindex="-1"></a></span>
<span id="cb225-10"><a href="#cb225-10" tabindex="-1"></a>ax.grid(<span class="st">'on'</span>)</span>
<span id="cb225-11"><a href="#cb225-11" tabindex="-1"></a>ax.set_title(<span class="st">'NDVI Time-Series'</span>)</span>
<span id="cb225-12"><a href="#cb225-12" tabindex="-1"></a>ax.set_ylabel(<span class="st">'NDVI'</span>)</span>
<span id="cb225-13"><a href="#cb225-13" tabindex="-1"></a></span>
<span id="cb225-14"><a href="#cb225-14" tabindex="-1"></a><span class="co"># Save the plot</span></span>
<span id="cb225-15"><a href="#cb225-15" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb225-16"><a href="#cb225-16" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'ndvi_time_series.png'</span>)</span>
<span id="cb225-17"><a href="#cb225-17" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb225-18"><a href="#cb225-18" tabindex="-1"></a></span>
<span id="cb225-19"><a href="#cb225-19" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/supplement_ndvi_time_series_files/supplement_ndvi_time_series_9_0.png"/></p>
</div>
<div class="section level4" id="time-series-smoothing-with-moving-average">
<h4>Time Series Smoothing with Moving Average</h4>
<p>Pandas has built-in method <code>rolling()</code> to allow us to
compute moving averages. Let’s smooth the time-series with a
moving-window average.</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" tabindex="-1"></a>window_size_days <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb226-2"><a href="#cb226-2" tabindex="-1"></a>window <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">D'</span>.<span class="bu">format</span>(window_size_days)</span>
<span id="cb226-3"><a href="#cb226-3" tabindex="-1"></a>df_smooth <span class="op">=</span> df.copy()</span>
<span id="cb226-4"><a href="#cb226-4" tabindex="-1"></a>df_smooth[<span class="st">'NDVI_smooth'</span>] <span class="op">=</span> df_smooth[<span class="st">'NDVI'</span>].rolling(window, center<span class="op">=</span><span class="va">True</span>).mean()</span>
<span id="cb226-5"><a href="#cb226-5" tabindex="-1"></a>df_smooth</span></code></pre></div>
<div class="sourceCode" id="cb227"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb227-2"><a href="#cb227-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb227-3"><a href="#cb227-3" tabindex="-1"></a>df_smooth.plot(y<span class="op">=</span><span class="st">'NDVI'</span>, kind<span class="op">=</span><span class="st">'line'</span>, ax<span class="op">=</span>ax, </span>
<span id="cb227-4"><a href="#cb227-4" tabindex="-1"></a>                  marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'#66c2a4'</span>, linestyle<span class="op">=</span><span class="st">'dotted'</span>,</span>
<span id="cb227-5"><a href="#cb227-5" tabindex="-1"></a>                  label<span class="op">=</span><span class="st">'Original'</span>)</span>
<span id="cb227-6"><a href="#cb227-6" tabindex="-1"></a>df_smooth.plot(y<span class="op">=</span><span class="st">'NDVI_smooth'</span>, kind<span class="op">=</span><span class="st">'line'</span>, ax<span class="op">=</span>ax,</span>
<span id="cb227-7"><a href="#cb227-7" tabindex="-1"></a>                  marker<span class="op">=</span><span class="st">'o'</span>, linewidth<span class="op">=</span> <span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'#238b45'</span>, </span>
<span id="cb227-8"><a href="#cb227-8" tabindex="-1"></a>                  label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st"> Day Moving-Average'</span>.<span class="bu">format</span>(window_size_days))</span>
<span id="cb227-9"><a href="#cb227-9" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">6</span>))</span>
<span id="cb227-10"><a href="#cb227-10" tabindex="-1"></a>ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">"%Y-%m"</span>))</span>
<span id="cb227-11"><a href="#cb227-11" tabindex="-1"></a></span>
<span id="cb227-12"><a href="#cb227-12" tabindex="-1"></a>ax.grid(<span class="st">'on'</span>)</span>
<span id="cb227-13"><a href="#cb227-13" tabindex="-1"></a></span>
<span id="cb227-14"><a href="#cb227-14" tabindex="-1"></a>ax.set_title(<span class="st">'NDVI Time-Series'</span>)</span>
<span id="cb227-15"><a href="#cb227-15" tabindex="-1"></a>ax.set_ylabel(<span class="st">'NDVI'</span>)</span>
<span id="cb227-16"><a href="#cb227-16" tabindex="-1"></a></span>
<span id="cb227-17"><a href="#cb227-17" tabindex="-1"></a><span class="co"># Save the plot</span></span>
<span id="cb227-18"><a href="#cb227-18" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb227-19"><a href="#cb227-19" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'smooth_ndvi_time_series.png'</span>)</span>
<span id="cb227-20"><a href="#cb227-20" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb227-21"><a href="#cb227-21" tabindex="-1"></a></span>
<span id="cb227-22"><a href="#cb227-22" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/supplement_ndvi_time_series_files/supplement_ndvi_time_series_12_0.png"/></p>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_feature_correlation_matrix.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
</div>
</div>
<div class="section level3" id="feature-correlation-matrix">
<h3>Feature Correlation Matrix</h3>
<p>Correlation Matrix is used in Machine Learning to identify redudant
features that are correlated. We will take a table of feature samples
generated from a multiband image and create a correlation matrix. This
matrix is used to identify and visualize patterns in the given data and
select features for a machine learning model.</p>
<div class="section level4" id="setup-and-data-download-11">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb228-2"><a href="#cb228-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb228-3"><a href="#cb228-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb228-4"><a href="#cb228-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code></pre></div>
<div class="sourceCode" id="cb229"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb229-2"><a href="#cb229-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb229-3"><a href="#cb229-3" tabindex="-1"></a></span>
<span id="cb229-4"><a href="#cb229-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb229-5"><a href="#cb229-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb229-6"><a href="#cb229-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb229-7"><a href="#cb229-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb230"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb230-2"><a href="#cb230-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb230-3"><a href="#cb230-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb230-4"><a href="#cb230-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb230-5"><a href="#cb230-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb230-6"><a href="#cb230-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb230-7"><a href="#cb230-7" tabindex="-1"></a></span>
<span id="cb230-8"><a href="#cb230-8" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/misc/'</span></span>
<span id="cb230-9"><a href="#cb230-9" tabindex="-1"></a>csv_name <span class="op">=</span> <span class="st">'feature_sample_data.csv'</span></span>
<span id="cb230-10"><a href="#cb230-10" tabindex="-1"></a></span>
<span id="cb230-11"><a href="#cb230-11" tabindex="-1"></a>download(data_url <span class="op">+</span> csv_name)</span>
<span id="cb230-12"><a href="#cb230-12" tabindex="-1"></a></span></code></pre></div>
<pre><code>Downloaded data/feature_sample_data.csv</code></pre>
</div>
<div class="section level4" id="data-pre-processing-8">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb232"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" tabindex="-1"></a>csv_path <span class="op">=</span> os.path.join(data_folder, csv_name)</span>
<span id="cb232-2"><a href="#cb232-2" tabindex="-1"></a>table <span class="op">=</span> pd.read_csv(csv_path)</span></code></pre></div>
<p>We use Pandas’ <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.corr.html"><code>pd.DataFrame.corr()</code></a>
method to calculate pairwise Pearson’s Correlation Coefficient for each
variable.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" tabindex="-1"></a>correlations <span class="op">=</span> table.corr()</span></code></pre></div>
</div>
<div class="section level4" id="plotting-using-matplotlib-1">
<h4>Plotting using Matplotlib</h4>
<p>We can use Matplotlib’s <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.matshow.html"><code>matplotlib.pyplot.matshow</code></a>
to display any array as a matrix.</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb234-2"><a href="#cb234-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">18</span>,<span class="dv">18</span>)</span>
<span id="cb234-3"><a href="#cb234-3" tabindex="-1"></a>im <span class="op">=</span> ax.matshow(correlations, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb234-4"><a href="#cb234-4" tabindex="-1"></a>fig.colorbar(im, shrink<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb234-5"><a href="#cb234-5" tabindex="-1"></a></span>
<span id="cb234-6"><a href="#cb234-6" tabindex="-1"></a>ticks <span class="op">=</span> np.arange(<span class="dv">0</span>,<span class="bu">len</span>(table.columns),<span class="dv">1</span>)</span>
<span id="cb234-7"><a href="#cb234-7" tabindex="-1"></a>ax.set_xticks(ticks)</span>
<span id="cb234-8"><a href="#cb234-8" tabindex="-1"></a>ax.set_yticks(ticks)</span>
<span id="cb234-9"><a href="#cb234-9" tabindex="-1"></a>ax.set_xticklabels(table.columns)</span>
<span id="cb234-10"><a href="#cb234-10" tabindex="-1"></a>ax.set_yticklabels(table.columns)</span>
<span id="cb234-11"><a href="#cb234-11" tabindex="-1"></a></span>
<span id="cb234-12"><a href="#cb234-12" tabindex="-1"></a></span>
<span id="cb234-13"><a href="#cb234-13" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb234-14"><a href="#cb234-14" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'correlation_matrix.png'</span>)</span>
<span id="cb234-15"><a href="#cb234-15" tabindex="-1"></a></span>
<span id="cb234-16"><a href="#cb234-16" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb234-17"><a href="#cb234-17" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="https://courses.spatialthoughts.com/python-dataviz-output/supplement_feature_correlation_matrix_files/supplement_feature_correlation_matrix_10_0.png"/></p>
</div>
</div>
</div>
<div class="section level2" id="animation">
<h2>Animation</h2>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_animating_maps.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level3" id="creating-animated-maps">
<h3>Creating Animated Maps</h3>
<p>We take the dataset for 2017 solar eclipse and animate the path of
the solar eclipse.</p>
<div class="section level4" id="setup-and-data-download-12">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb235-2"><a href="#cb235-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb235-3"><a href="#cb235-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb235-4"><a href="#cb235-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree</span>
<span id="cb235-5"><a href="#cb235-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span>
<span id="cb235-6"><a href="#cb235-6" tabindex="-1"></a>  <span class="op">!</span>pip install contextily</span></code></pre></div>
<div class="sourceCode" id="cb236"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb236-2"><a href="#cb236-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb236-3"><a href="#cb236-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb236-4"><a href="#cb236-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb236-5"><a href="#cb236-5" tabindex="-1"></a><span class="im">from</span> matplotlib.animation <span class="im">import</span> FuncAnimation, PillowWriter</span></code></pre></div>
<div class="sourceCode" id="cb237"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb237-2"><a href="#cb237-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb237-3"><a href="#cb237-3" tabindex="-1"></a></span>
<span id="cb237-4"><a href="#cb237-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb237-5"><a href="#cb237-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb237-6"><a href="#cb237-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb237-7"><a href="#cb237-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb238"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb238-2"><a href="#cb238-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb238-3"><a href="#cb238-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb238-4"><a href="#cb238-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb238-5"><a href="#cb238-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb238-6"><a href="#cb238-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Downloaded '</span> <span class="op">+</span> local)</span>
<span id="cb238-7"><a href="#cb238-7" tabindex="-1"></a></span>
<span id="cb238-8"><a href="#cb238-8" tabindex="-1"></a>path_shapefile <span class="op">=</span> <span class="st">'upath17'</span></span>
<span id="cb238-9"><a href="#cb238-9" tabindex="-1"></a>umbra_shapefile <span class="op">=</span> <span class="st">'umbra17'</span></span>
<span id="cb238-10"><a href="#cb238-10" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">'.shp'</span>, <span class="st">'.shx'</span>, <span class="st">'.dbf'</span>, <span class="st">'.prj'</span>]</span>
<span id="cb238-11"><a href="#cb238-11" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">'https://github.com/spatialthoughts/python-dataviz-web/raw/main/data/eclipse/'</span></span>
<span id="cb238-12"><a href="#cb238-12" tabindex="-1"></a></span>
<span id="cb238-13"><a href="#cb238-13" tabindex="-1"></a><span class="cf">for</span> shapefile <span class="kw">in</span> [path_shapefile, umbra_shapefile]:</span>
<span id="cb238-14"><a href="#cb238-14" tabindex="-1"></a>  <span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb238-15"><a href="#cb238-15" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> shapefile <span class="op">+</span> ext</span>
<span id="cb238-16"><a href="#cb238-16" tabindex="-1"></a>    download(url)</span></code></pre></div>
</div>
<div class="section level4" id="data-pre-processing-9">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb239"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" tabindex="-1"></a>path_shapefile_path <span class="op">=</span> os.path.join(data_folder, path_shapefile <span class="op">+</span> <span class="st">'.shp'</span>)</span>
<span id="cb239-2"><a href="#cb239-2" tabindex="-1"></a>path_gdf <span class="op">=</span> gpd.read_file(path_shapefile_path)</span></code></pre></div>
<div class="sourceCode" id="cb240"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" tabindex="-1"></a>umbra_shapefile_path <span class="op">=</span> os.path.join(data_folder, umbra_shapefile <span class="op">+</span> <span class="st">'.shp'</span>)</span>
<span id="cb240-2"><a href="#cb240-2" tabindex="-1"></a>umbra_gdf <span class="op">=</span> gpd.read_file(umbra_shapefile_path)</span></code></pre></div>
<div class="sourceCode" id="cb241"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" tabindex="-1"></a>path_reprojected <span class="op">=</span> path_gdf.to_crs(<span class="st">'epsg:3857'</span>)</span>
<span id="cb241-2"><a href="#cb241-2" tabindex="-1"></a>umbra_reprojected <span class="op">=</span> umbra_gdf.to_crs(<span class="st">'epsg:3857'</span>)</span></code></pre></div>
<div class="sourceCode" id="cb242"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" tabindex="-1"></a>path_boundary <span class="op">=</span> path_reprojected.geometry.unary_union</span>
<span id="cb242-2"><a href="#cb242-2" tabindex="-1"></a>umbra_subset <span class="op">=</span> umbra_reprojected[umbra_reprojected.geometry.intersects(path_boundary)]</span></code></pre></div>
</div>
<div class="section level4" id="creating-animation">
<h4>Creating Animation</h4>
<p>We use Matplotlibs <code>FuncAnimation</code> function from the
<code>animation</code> module to create an animation with each frame
showing the position of the umbra through the solar eclipse.</p>
<p>Reference: <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.animation.FuncAnimation.html"><code>matplotlib.animation.FuncAnimation</code></a></p>
<div class="sourceCode" id="cb243"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb243-2"><a href="#cb243-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb243-3"><a href="#cb243-3" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb243-4"><a href="#cb243-4" tabindex="-1"></a></span>
<span id="cb243-5"><a href="#cb243-5" tabindex="-1"></a><span class="kw">def</span> animate(i):</span>
<span id="cb243-6"><a href="#cb243-6" tabindex="-1"></a>    ax.clear()</span>
<span id="cb243-7"><a href="#cb243-7" tabindex="-1"></a>    <span class="co"># Get the point from the points list at index i</span></span>
<span id="cb243-8"><a href="#cb243-8" tabindex="-1"></a>    umbra_filtered <span class="op">=</span> umbra_subset.iloc[i:i<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb243-9"><a href="#cb243-9" tabindex="-1"></a>    path_reprojected.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#cccccc'</span>, edgecolor<span class="op">=</span><span class="st">'#969696'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb243-10"><a href="#cb243-10" tabindex="-1"></a>    cx.add_basemap(ax, crs<span class="op">=</span>path_reprojected.crs, source<span class="op">=</span>cx.providers.OpenTopoMap)</span>
<span id="cb243-11"><a href="#cb243-11" tabindex="-1"></a>    umbra_filtered.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'#252525'</span>, edgecolor<span class="op">=</span><span class="st">'#636363'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb243-12"><a href="#cb243-12" tabindex="-1"></a>    ax.set_axis_off()</span>
<span id="cb243-13"><a href="#cb243-13" tabindex="-1"></a>    props <span class="op">=</span> <span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'wheat'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb243-14"><a href="#cb243-14" tabindex="-1"></a>    time <span class="op">=</span> umbra_filtered.iloc[<span class="dv">0</span>].Time</span>
<span id="cb243-15"><a href="#cb243-15" tabindex="-1"></a>    text <span class="op">=</span> <span class="st">'Time: </span><span class="sc">{}</span><span class="st"> UTC'</span>.<span class="bu">format</span>(time)</span>
<span id="cb243-16"><a href="#cb243-16" tabindex="-1"></a>    ax.text(<span class="fl">0.05</span>, <span class="fl">0.20</span>, text, transform<span class="op">=</span>ax.transAxes, fontsize<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb243-17"><a href="#cb243-17" tabindex="-1"></a>            verticalalignment<span class="op">=</span><span class="st">'top'</span>, bbox<span class="op">=</span>props)</span>
<span id="cb243-18"><a href="#cb243-18" tabindex="-1"></a>    ax.set_title(<span class="st">'2017 Total Solar Eclipse Path'</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb243-19"><a href="#cb243-19" tabindex="-1"></a></span>
<span id="cb243-20"><a href="#cb243-20" tabindex="-1"></a>ani <span class="op">=</span> FuncAnimation(fig, animate, frames<span class="op">=</span><span class="bu">len</span>(umbra_subset),</span>
<span id="cb243-21"><a href="#cb243-21" tabindex="-1"></a>                    interval<span class="op">=</span><span class="dv">500</span>, repeat<span class="op">=</span><span class="va">True</span>, cache_frame_data<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb243-22"><a href="#cb243-22" tabindex="-1"></a>plt.close()</span></code></pre></div>
<div class="sourceCode" id="cb244"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb244-2"><a href="#cb244-2" tabindex="-1"></a>mpl.rcParams[<span class="st">'animation.embed_limit'</span>] <span class="op">=</span> <span class="dv">2</span><span class="op">**</span><span class="dv">128</span></span>
<span id="cb244-3"><a href="#cb244-3" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML</span>
<span id="cb244-4"><a href="#cb244-4" tabindex="-1"></a>HTML(ani.to_jshtml())</span></code></pre></div>
<div class="sourceCode" id="cb245"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb245-2"><a href="#cb245-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">'solar_eclipse.gif'</span>)</span>
<span id="cb245-3"><a href="#cb245-3" tabindex="-1"></a></span>
<span id="cb245-4"><a href="#cb245-4" tabindex="-1"></a>ani.save(output_path, writer<span class="op">=</span>PillowWriter(fps<span class="op">=</span><span class="dv">5</span>))</span></code></pre></div>
</div>
</div>
</div>
<div class="section level2" id="leafmap">
<h2>Leafmap</h2>
<p><a href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_leafmap_osm.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section level3" id="downloading-and-visualizing-osm-data-with-leafmap">
<h3>Downloading and Visualizing OSM Data with LeafMap</h3>
<p><a href="https://leafmap.org/">Leafmap</a> comes with handy utilities
to work with OpenStreetMap data. Using the popular package OSMNx in the
background, it provides utility functions to download and visualize data
from the OSM database.</p>
<ul>
<li><a href="https://leafmap.org/notebooks/15_openstreetmap/">Leafmap
OpenStreetMap Features</a></li>
<li><a href="https://leafmap.org/osm/"><code>leafmap.osm</code>
module</a></li>
</ul>
<div class="section level4" id="setup-and-data-download-13">
<h4>Setup and Data Download</h4>
<div class="sourceCode" id="cb246"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb246-2"><a href="#cb246-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">'google.colab'</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb246-3"><a href="#cb246-3" tabindex="-1"></a>  <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb246-4"><a href="#cb246-4" tabindex="-1"></a>  <span class="op">!</span>pip install fiona shapely pyproj rtree mapclassify</span>
<span id="cb246-5"><a href="#cb246-5" tabindex="-1"></a>  <span class="op">!</span>pip install geopandas</span>
<span id="cb246-6"><a href="#cb246-6" tabindex="-1"></a>  <span class="op">!</span>pip install leafmap</span>
<span id="cb246-7"><a href="#cb246-7" tabindex="-1"></a>  <span class="op">!</span>pip install osmnx</span></code></pre></div>
<div class="sourceCode" id="cb247"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb247-2"><a href="#cb247-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb247-3"><a href="#cb247-3" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb247-4"><a href="#cb247-4" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb247-5"><a href="#cb247-5" tabindex="-1"></a><span class="im">import</span> osmnx</span></code></pre></div>
<div class="sourceCode" id="cb248"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb248-2"><a href="#cb248-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">'output'</span></span>
<span id="cb248-3"><a href="#cb248-3" tabindex="-1"></a></span>
<span id="cb248-4"><a href="#cb248-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb248-5"><a href="#cb248-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb248-6"><a href="#cb248-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb248-7"><a href="#cb248-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div class="section level4" id="downloading-osm-data">
<h4>Downloading OSM Data</h4>
<p>We can easily download data for a city or a region by its name using
the <code>leafmap.osm_gdf_from_place()</code> function. We can specify
the list of required tags using a dictionary. See <a href="https://wiki.openstreetmap.org/wiki/Map_features">OSM Wiki</a> for
a complete list of tags and values.</p>
<p>You can also download data using a bounding box using
<code>leafmap.osm.osm_gdf_from_bbox()</code> function.</p>
<p>Reference: <a href="https://leafmap.org/osm/#leafmap.osm.osm_gdf_from_place"><code>leafmap.osm_gdf_from_place</code></a></p>
<div class="sourceCode" id="cb249"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" tabindex="-1"></a>parking_gdf <span class="op">=</span> leafmap.osm_gdf_from_place(</span>
<span id="cb249-2"><a href="#cb249-2" tabindex="-1"></a>    <span class="st">'Bangalore'</span>, </span>
<span id="cb249-3"><a href="#cb249-3" tabindex="-1"></a>    tags<span class="op">=</span>{<span class="st">'amenity'</span>: [<span class="st">'parking'</span>, <span class="st">'parking_space'</span>, <span class="st">'parking_entrance'</span>]}</span>
<span id="cb249-4"><a href="#cb249-4" tabindex="-1"></a>  )</span></code></pre></div>
<p>The GeoDataFrame has a hierarchical MultiIndex. Let’s flatten it
using <code>reset_index()</code></p>
<div class="sourceCode" id="cb250"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" tabindex="-1"></a>parking_gdf <span class="op">=</span> parking_gdf.reset_index(level<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>])</span></code></pre></div>
<p>The result has many columns. Let’s filter to required columns.</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" tabindex="-1"></a>parking_gdf_subset <span class="op">=</span> parking_gdf[[<span class="st">'amenity'</span>,<span class="st">'parking'</span>, <span class="st">'access'</span>, <span class="st">'geometry'</span>]]</span></code></pre></div>
<p>The results contains both points and polygon features. Let’s separate
them out.</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" tabindex="-1"></a>parking_zones <span class="op">=</span> parking_gdf_subset[</span>
<span id="cb252-2"><a href="#cb252-2" tabindex="-1"></a>    parking_gdf_subset[<span class="st">'geometry'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x : x.<span class="bu">type</span> <span class="op">==</span> <span class="st">'Polygon'</span> )]</span>
<span id="cb252-3"><a href="#cb252-3" tabindex="-1"></a>parking_locations <span class="op">=</span> parking_gdf_subset[</span>
<span id="cb252-4"><a href="#cb252-4" tabindex="-1"></a>    parking_gdf_subset[<span class="st">'geometry'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x : x.<span class="bu">type</span> <span class="op">==</span> <span class="st">'Point'</span> )]</span></code></pre></div>
<p>We can save the resulting GeoDataFrame to a GeoPackage.</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">'parking.gpkg'</span></span>
<span id="cb253-2"><a href="#cb253-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb253-3"><a href="#cb253-3" tabindex="-1"></a>parking_zones.to_file(driver<span class="op">=</span><span class="st">'GPKG'</span>, filename<span class="op">=</span>output_path, layer<span class="op">=</span><span class="st">'zones'</span>)</span>
<span id="cb253-4"><a href="#cb253-4" tabindex="-1"></a>parking_locations.to_file(driver<span class="op">=</span><span class="st">'GPKG'</span>, filename<span class="op">=</span>output_path, layer<span class="op">=</span><span class="st">'locations'</span>)</span></code></pre></div>
</div>
</div>
<div class="section level3" id="visualizing-osm-data">
<h3>Visualizing OSM Data</h3>
<p>The <code>leafmap.osm</code> module has many functions that can add
OSM data directy to the map. Here we use
<code>add_osm_from_geocode()</code> function to add the boundary of a
region from OSM. In addition, we can select a basemap from
<code>leafmap.basemaps.keys()</code> for the map.</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb254-2"><a href="#cb254-2" tabindex="-1"></a>m.add_basemap(<span class="st">'CartoDB.DarkMatter'</span>)</span>
<span id="cb254-3"><a href="#cb254-3" tabindex="-1"></a>m.add_osm_from_geocode(<span class="st">'Bangalore'</span>, layer_name<span class="op">=</span><span class="st">'Bangalore'</span>, info_mode<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb254-4"><a href="#cb254-4" tabindex="-1"></a>m</span></code></pre></div>
<p>We can add the GeoDataFrame to the map as well using GeoPanda’s
<code>explore()</code> function which allows us to customize the
marker’s shape, size for the point layer.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb255-2"><a href="#cb255-2" tabindex="-1"></a>m.add_basemap(<span class="st">'CartoDB.DarkMatter'</span>)</span>
<span id="cb255-3"><a href="#cb255-3" tabindex="-1"></a>m.add_osm_from_geocode(<span class="st">'Bangalore'</span>, layer_name<span class="op">=</span><span class="st">'Bangalore'</span>, info_mode<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb255-4"><a href="#cb255-4" tabindex="-1"></a>parking_zones.explore(</span>
<span id="cb255-5"><a href="#cb255-5" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">'fillOpacity'</span>: <span class="fl">0.3</span>, <span class="st">'weight'</span>: <span class="fl">0.5</span>},</span>
<span id="cb255-6"><a href="#cb255-6" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'orange'</span>,</span>
<span id="cb255-7"><a href="#cb255-7" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'parking zones'</span>,</span>
<span id="cb255-8"><a href="#cb255-8" tabindex="-1"></a>    m<span class="op">=</span>m)</span>
<span id="cb255-9"><a href="#cb255-9" tabindex="-1"></a>parking_locations.explore(</span>
<span id="cb255-10"><a href="#cb255-10" tabindex="-1"></a>    marker_type<span class="op">=</span><span class="st">'circle'</span>,</span>
<span id="cb255-11"><a href="#cb255-11" tabindex="-1"></a>    marker_kwds<span class="op">=</span>{<span class="st">'radius'</span>: <span class="dv">1</span>},</span>
<span id="cb255-12"><a href="#cb255-12" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'yellow'</span>,</span>
<span id="cb255-13"><a href="#cb255-13" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'parking locations'</span>,</span>
<span id="cb255-14"><a href="#cb255-14" tabindex="-1"></a>    m<span class="op">=</span>m)</span>
<span id="cb255-15"><a href="#cb255-15" tabindex="-1"></a>m</span></code></pre></div>
</div>
</div>
</div>
<div class="section level1" id="resources">
<h1>Resources</h1>
<ul>
<li><a href="https://jakevdp.github.io/PythonDataScienceHandbook/04.00-introduction-to-matplotlib.html">Visualization
with Matplotlib</a>: Python Data Science Handbook by Jake
VanderPlas</li>
<li><a href="https://github.com/MarcSkovMadsen/awesome-streamlit">Awesome
Streamlit</a>: A curated list of Awesome Streamlit resources and gallery
of Streamlit apps.</li>
</ul>
</div>
<div class="section level1" id="data-credits">
<h1>Data Credits</h1>
<ul>
<li>London Crime Statistics: ASB Incidents, Crime and Outcome - UK Home
Office. Retrieved 2022-01-20. <a class="uri" href="https://data.police.uk/about/">https://data.police.uk/about/</a></li>
<li>California Census Data: U.S. Census Bureau, 2019 American Community
Survey 5-Year Estimates and Cartographic Boundary Files - Shapefile:
2019</li>
<li>Eclipse Shapefiles: NASA’s Scientific Visualization Studio
Downloaded from <a class="uri" href="https://svs.gsfc.nasa.gov/4518">https://svs.gsfc.nasa.gov/4518</a></li>
<li>NASA Shuttle Radar Topography Mission (SRTM) Elevation Dataset.
Downloaded from <a href="https://dwtkns.com/srtm30m/%5D">30m SRTM Tile
Downloader</a>.</li>
<li>Temperature Anomalies: GISTEMP Team, 2022: GISS Surface Temperature
Analysis (GISTEMP), version 4. NASA Goddard Institute for Space Studies.
Dataset accessed 2022-01-26 at <a class="uri" href="https://data.giss.nasa.gov/gistemp/">https://data.giss.nasa.gov/gistemp/</a>.</li>
<li>OpenStreetMap (osm) data layers: Data/Maps Copyright 2019 Geofabrik
GmbH and OpenStreetMap Contributors. <a href="https://download.geofabrik.de/asia/india.html">OSM India free
extract</a> downloaded from Geofabrik.</li>
<li>Bangalore Ward Maps Provided by <a href="http://projects.datameet.org/Municipal_Spatial_Data/">Spatial Data
of Municipalities (Maps) Project</a> by Data{Meet}.</li>
<li>Bangalore LandCover Data: <a href="https://esa-worldcover.org/en">ESA WorldCover project 2020</a> /
Contains modified Copernicus Sentinel data (2020) processed by ESA
WorldCover consortium</li>
<li>VIIRS NightTime Lights for India: Created from <a href="https://developers.google.com/earth-engine/datasets/catalog/NOAA_VIIRS_DNB_MONTHLY_V1_VCMCFG#description">VIIRS
Nighttime Day/Night Band Composites Version 1</a>, Earth Observation
Group, Payne Institute for Public Policy, Colorado School of Mines</li>
</ul>
</div>
<div class="section level1" id="license">
<h1>License</h1>
<p>This course material is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>Mapping and Data Visualization with Python Course</em> by Ujaval
Gandhi <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr/>
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
<hr/>
<p>© 2022 Spatial Thoughts <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>
<!-- Comment Section Powered by utterances -->
<div id="comments">
<hr/>
<p>If you want to report any issues with this page, please comment below.</p>
<script async="" crossorigin="anonymous" issue-term="title" label="comment" repo="spatialthoughts/courses" src="https://utteranc.es/client.js" theme="github-light">
</script>
</div>
</div>
<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>
<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>
<!-- code folding -->
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
